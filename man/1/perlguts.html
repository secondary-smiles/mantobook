<!-- Creator     : groff version 1.22.4 -->
<!-- CreationDate: Mon May 29 22:53:59 2023 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title>PERLGUTS</title>

</head>
<body>
<h1>perlguts</h1>



<h2>NAME
<a name="NAME"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">perlguts
&minus; Introduction to the Perl API</p>

<h2>DESCRIPTION
<a name="DESCRIPTION"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">This document
attempts to describe how to use the Perl <small>API,</small>
as well as to provide some info on the basic workings of the
Perl core. It is far from complete and probably contains
many errors. Please refer any questions or comments to the
author below.</p>

<h2>Variables
<a name="Variables"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em"><b>Datatypes</b>
<br>
Perl has three typedefs that handle Perl&rsquo;s three main
data types:</p>

<p style="margin-left:11%; margin-top: 1em">SV Scalar Value
<br>
AV Array Value <br>
HV Hash Value</p>

<p style="margin-left:11%; margin-top: 1em">Each typedef
has specific routines that manipulate the various data
types.</p>

<p style="margin-left:11%; margin-top: 1em"><b>What is an
&quot; <small>IV&quot;</small> ?</b> <br>
Perl uses a special typedef <small>IV</small> which is a
simple signed integer type that is guaranteed to be large
enough to hold a pointer (as well as an integer).
Additionally, there is the <small>UV,</small> which is
simply an unsigned <small>IV.</small></p>

<p style="margin-left:11%; margin-top: 1em">Perl also uses
several special typedefs to declare variables to hold
integers of (at least) a given size. Use I8, I16, I32, and
I64 to declare a signed integer variable which has at least
as many bits as the number in its name. These all evaluate
to the native C type that is closest to the given number of
bits, but no smaller than that number. For example, on many
platforms, a &quot;short&quot; is 16 bits long, and if so,
I16 will evaluate to a &quot;short&quot;. But on platforms
where a &quot;short&quot; isn&rsquo;t exactly 16 bits, Perl
will use the smallest type that contains 16 bits or
more.</p>

<p style="margin-left:11%; margin-top: 1em">U8, U16, U32,
and U64 are to declare the corresponding unsigned integer
types.</p>

<p style="margin-left:11%; margin-top: 1em">If the platform
doesn&rsquo;t support 64&minus;bit integers, both I64 and
U64 will be undefined. Use <small>IV</small> and
<small>UV</small> to declare the largest practicable, and
&quot;&quot;WIDEST_UTYPE&quot; in perlapi&quot; for the
absolute maximum unsigned, but which may not be usable in
all circumstances.</p>

<p style="margin-left:11%; margin-top: 1em">A numeric
constant can be specified with
&quot;&quot;INT16_C&quot;&quot; in perlapi,
&quot;&quot;UINTMAX_C&quot;&quot; in perlapi, and
similar.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Working with
SVs</b> <br>
An <small>SV</small> can be created and loaded with one
command. There are five types of values that can be loaded:
an integer value ( <small>IV</small> ), an unsigned integer
value ( <small>UV</small> ), a double ( <small>NV</small> ),
a string ( <small>PV</small> ), and another scalar (
<small>SV</small> ). (&quot; <small>PV&quot;</small> stands
for &quot;Pointer Value&quot;. You might think that it is
misnamed because it is described as pointing only to
strings. However, it is possible to have it point to other
things. For example, it could point to an array of UVs. But,
using it for non-strings requires care, as the underlying
assumption of much of the internals is that PVs are just for
strings. Often, for example, a trailing &quot;NUL&quot; is
tacked on automatically. The non-string use is documented
only in this paragraph.)</p>

<p style="margin-left:11%; margin-top: 1em">The seven
routines are:</p>

<p style="margin-left:11%; margin-top: 1em">SV*
newSViv(IV); <br>
SV* newSVuv(UV); <br>
SV* newSVnv(double); <br>
SV* newSVpv(const char*, STRLEN); <br>
SV* newSVpvn(const char*, STRLEN); <br>
SV* newSVpvf(const char*, ...); <br>
SV* newSVsv(SV*);</p>


<p style="margin-left:11%; margin-top: 1em">&quot;STRLEN&quot;
is an integer type (&quot;Size_t&quot;, usually defined as
&quot;size_t&quot; in <i>config.h</i>) guaranteed to be
large enough to represent the size of any string that perl
can handle.</p>

<p style="margin-left:11%; margin-top: 1em">In the unlikely
case of a <small>SV</small> requiring more complex
initialization, you can create an empty <small>SV</small>
with newSV(len). If &quot;len&quot; is 0 an empty
<small>SV</small> of type <small>NULL</small> is returned,
else an <small>SV</small> of type <small>PV</small> is
returned with len + 1 (for the &quot;NUL&quot;) bytes of
storage allocated, accessible via SvPVX. In both cases the
<small>SV</small> has the undef value.</p>

<p style="margin-left:11%; margin-top: 1em">SV *sv =
newSV(0); /* no storage allocated */ <br>
SV *sv = newSV(10); /* 10 (+1) bytes of uninitialised
storage <br>
* allocated */</p>

<p style="margin-left:11%; margin-top: 1em">To change the
value of an <i>already-existing</i> <small>SV,</small> there
are eight routines:</p>

<p style="margin-left:11%; margin-top: 1em">void
sv_setiv(SV*, IV); <br>
void sv_setuv(SV*, UV); <br>
void sv_setnv(SV*, double); <br>
void sv_setpv(SV*, const char*); <br>
void sv_setpvn(SV*, const char*, STRLEN) <br>
void sv_setpvf(SV*, const char*, ...); <br>
void sv_vsetpvfn(SV*, const char*, STRLEN, va_list *, <br>
SV **, Size_t, bool *); <br>
void sv_setsv(SV*, SV*);</p>

<p style="margin-left:11%; margin-top: 1em">Notice that you
can choose to specify the length of the string to be
assigned by using &quot;sv_setpvn&quot;,
&quot;newSVpvn&quot;, or &quot;newSVpv&quot;, or you may
allow Perl to calculate the length by using
&quot;sv_setpv&quot; or by specifying 0 as the second
argument to &quot;newSVpv&quot;. Be warned, though, that
Perl will determine the string&rsquo;s length by using
&quot;strlen&quot;, which depends on the string terminating
with a &quot;NUL&quot; character, and not otherwise
containing NULs.</p>

<p style="margin-left:11%; margin-top: 1em">The arguments
of &quot;sv_setpvf&quot; are processed like
&quot;sprintf&quot;, and the formatted output becomes the
value.</p>


<p style="margin-left:11%; margin-top: 1em">&quot;sv_vsetpvfn&quot;
is an analogue of &quot;vsprintf&quot;, but it allows you to
specify either a pointer to a variable argument list or the
address and length of an array of SVs. The last argument
points to a boolean; on return, if that boolean is true,
then locale-specific information has been used to format the
string, and the string&rsquo;s contents are therefore
untrustworthy (see perlsec). This pointer may be
<small>NULL</small> if that information is not important.
Note that this function requires you to specify the length
of the format.</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;sv_set*()&quot; functions are not generic enough to
operate on values that have &quot;magic&quot;. See
&quot;Magic Virtual Tables&quot; later in this document.</p>

<p style="margin-left:11%; margin-top: 1em">All SVs that
contain strings should be terminated with a &quot;NUL&quot;
character. If it is not &quot;NUL&quot;&minus;terminated
there is a risk of core dumps and corruptions from code
which passes the string to C functions or system calls which
expect a &quot;NUL&quot;&minus;terminated string.
Perl&rsquo;s own functions typically add a trailing
&quot;NUL&quot; for this reason. Nevertheless, you should be
very careful when you pass a string stored in an
<small>SV</small> to a C function or system call.</p>

<p style="margin-left:11%; margin-top: 1em">To access the
actual value that an <small>SV</small> points to,
Perl&rsquo;s <small>API</small> exposes several macros that
coerce the actual scalar type into an <small>IV, UV,</small>
double, or string:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="5%"></td>
<td width="63%">


<p>&quot;SvIV(SV*)&quot; (&quot;IV&quot;) and
&quot;SvUV(SV*)&quot; (&quot;UV&quot;)</p></td>
<td width="20%">
</td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="5%"></td>
<td width="63%">


<p>&quot;SvNV(SV*)&quot; (&quot;double&quot;)</p></td>
<td width="20%">
</td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="5%"></td>
<td width="63%">


<p>Strings are a bit complicated:</p></td>
<td width="20%">
</td></tr>
</table>

<p style="margin-left:17%;">&bull;</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="23%"></td>
<td width="66%">


<p style="margin-top: 1em">Byte string: &quot;SvPVbyte(SV*,
STRLEN len)&quot; or &quot;SvPVbyte_nolen(SV*)&quot;</p></td>
<td width="11%">
</td></tr>
</table>

<p style="margin-left:23%; margin-top: 1em">If the Perl
string is &quot;\xff\xff&quot;, then this returns a
2&minus;byte &quot;char*&quot;.</p>

<p style="margin-left:23%; margin-top: 1em">This is
suitable for Perl strings that represent bytes.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="17%"></td>
<td width="1%">


<p style="margin-top: 1em">&bull;</p></td>
<td width="5%"></td>
<td width="68%">


<p style="margin-top: 1em"><small>UTF&minus;8</small>
string: &quot;SvPVutf8(SV*, STRLEN len)&quot; or
&quot;SvPVutf8_nolen(SV*)&quot;</p> </td>
<td width="9%">
</td></tr>
</table>

<p style="margin-left:23%; margin-top: 1em">If the Perl
string is &quot;\xff\xff&quot;, then this returns a
4&minus;byte &quot;char*&quot;.</p>

<p style="margin-left:23%; margin-top: 1em">This is
suitable for Perl strings that represent characters.</p>


<p style="margin-left:23%; margin-top: 1em"><b><small>CAVEAT</small></b>
: That &quot;char*&quot; will be encoded via Perl&rsquo;s
internal <small>UTF&minus;8</small> variant, which means
that if the <small>SV</small> contains non-Unicode code
points (e.g., 0x110000), then the result may contain
extensions over valid <small>UTF&minus;8.</small> See
&quot;is_strict_utf8_string&quot; in perlapi for some
methods Perl gives you to check the
<small>UTF&minus;8</small> validity of these macros&rsquo;
returns.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="17%"></td>
<td width="1%">


<p style="margin-top: 1em">&bull;</p></td>
<td width="5%"></td>
<td width="77%">


<p style="margin-top: 1em">You can also use &quot;SvPV(SV*,
STRLEN len)&quot; or &quot;SvPV_nolen(SV*)&quot; to fetch
the <small>SV</small> &rsquo;s raw internal buffer. This is
tricky, though; if your Perl string is &quot;\xff\xff&quot;,
then depending on the <small>SV</small> &rsquo;s internal
encoding you might get back a 2&minus;byte
<b><small>OR</small></b> a 4&minus;byte &quot;char*&quot;.
Moreover, if it&rsquo;s the 4&minus;byte string, that could
come from either Perl &quot;\xff\xff&quot; stored
<small>UTF&minus;8</small> encoded, or Perl
&quot;\xc3\xbf\xc3\xbf&quot; stored as raw octets. To
differentiate between these you <b><small>MUST</small></b>
look up the <small>SV</small> &rsquo;s <small>UTF8</small>
bit (cf. &quot;SvUTF8&quot;) to know whether the source Perl
string is 2 characters (&quot;SvUTF8&quot; would be on) or 4
characters (&quot;SvUTF8&quot; would be off).</p></td></tr>
</table>


<p style="margin-left:23%; margin-top: 1em"><b><small>IMPORTANT:</small></b>
Use of &quot;SvPV&quot;, &quot;SvPV_nolen&quot;, or
similarly-named macros <i>without</i> looking up the
<small>SV</small> &rsquo;s <small>UTF8</small> bit is almost
certainly a bug if non-ASCII input is allowed.</p>

<p style="margin-left:23%; margin-top: 1em">When the
<small>UTF8</small> bit is on, the same
<b><small>CAVEAT</small></b> about
<small>UTF&minus;8</small> validity applies here as for
&quot;SvPVutf8&quot;.</p>

<p style="margin-left:17%; margin-top: 1em">(See &quot;How
do I pass a Perl string to a C library?&quot; for more
details.)</p>

<p style="margin-left:17%; margin-top: 1em">In
&quot;SvPVbyte&quot;, &quot;SvPVutf8&quot;, and
&quot;SvPV&quot;, the length of the &quot;char*&quot;
returned is placed into the variable &quot;len&quot; (these
are macros, so you do <i>not</i> use &amp;len). If you do
not care what the length of the data is, use
&quot;SvPVbyte_nolen&quot;, &quot;SvPVutf8_nolen&quot;, or
&quot;SvPV_nolen&quot; instead. The global variable
&quot;PL_na&quot; can also be given to
&quot;SvPVbyte&quot;/&quot;SvPVutf8&quot;/&quot;SvPV&quot;
in this case. But that can be quite inefficient because
&quot;PL_na&quot; must be accessed in thread-local storage
in threaded Perl. In any case, remember that Perl allows
arbitrary strings of data that may both contain NULs and
might not be terminated by a &quot;NUL&quot;.</p>

<p style="margin-left:17%; margin-top: 1em">Also remember
that C doesn&rsquo;t allow you to safely say
&quot;foo(SvPVbyte(s, len), len);&quot;. It might work with
your compiler, but it won&rsquo;t work for everyone. Break
this sort of statement up into separate assignments:</p>

<p style="margin-left:17%; margin-top: 1em">SV *s; <br>
STRLEN len; <br>
char *ptr; <br>
ptr = SvPVbyte(s, len); <br>
foo(ptr, len);</p>

<p style="margin-left:11%; margin-top: 1em">If you want to
know if the scalar value is <small>TRUE,</small> you can
use:</p>


<p style="margin-left:11%; margin-top: 1em">SvTRUE(SV*)</p>

<p style="margin-left:11%; margin-top: 1em">Although Perl
will automatically grow strings for you, if you need to
force Perl to allocate more memory for your
<small>SV,</small> you can use the macro</p>

<p style="margin-left:11%; margin-top: 1em">SvGROW(SV*,
STRLEN newlen)</p>

<p style="margin-left:11%; margin-top: 1em">which will
determine if more memory needs to be allocated. If so, it
will call the function &quot;sv_grow&quot;. Note that
&quot;SvGROW&quot; can only increase, not decrease, the
allocated memory of an <small>SV</small> and that it does
not automatically add space for the trailing &quot;NUL&quot;
byte (perl&rsquo;s own string functions typically do
&quot;SvGROW(sv, len + 1)&quot;).</p>

<p style="margin-left:11%; margin-top: 1em">If you want to
write to an existing <small>SV</small> &rsquo;s buffer and
set its value to a string, use <b>SvPVbyte_force()</b> or
one of its variants to force the <small>SV</small> to be a
<small>PV.</small> This will remove any of various types of
non-stringness from the <small>SV</small> while preserving
the content of the <small>SV</small> in the
<small>PV.</small> This can be used, for example, to append
data from an <small>API</small> function to a buffer without
extra copying:</p>


<p style="margin-left:11%; margin-top: 1em">(void)SvPVbyte_force(sv,
len); <br>
s = SvGROW(sv, len + needlen + 1); <br>
/* something that modifies up to needlen bytes at s+len, but
<br>
modifies newlen bytes <br>
eg. newlen = read(fd, s + len, needlen); <br>
ignoring errors for these examples <br>
*/ <br>
s[len + newlen] = '\0'; <br>
SvCUR_set(sv, len + newlen); <br>
SvUTF8_off(sv); <br>
SvSETMAGIC(sv);</p>

<p style="margin-left:11%; margin-top: 1em">If you already
have the data in memory or if you want to keep your code
simple, you can use one of the sv_cat*() variants, such as
<b>sv_catpvn()</b>. If you want to insert anywhere in the
string you can use <b>sv_insert()</b> or
<b>sv_insert_flags()</b>.</p>

<p style="margin-left:11%; margin-top: 1em">If you
don&rsquo;t need the existing content of the
<small>SV,</small> you can avoid some copying with:</p>

<p style="margin-left:11%; margin-top: 1em">SvPVCLEAR(sv);
<br>
s = SvGROW(sv, needlen + 1); <br>
/* something that modifies up to needlen bytes at s, but
modifies <br>
newlen bytes <br>
eg. newlen = read(fd, s, needlen); <br>
*/ <br>
s[newlen] = '\0'; <br>
SvCUR_set(sv, newlen); <br>
SvPOK_only(sv); /* also clears SVf_UTF8 */ <br>
SvSETMAGIC(sv);</p>

<p style="margin-left:11%; margin-top: 1em">Again, if you
already have the data in memory or want to avoid the
complexity of the above, you can use <b>sv_setpvn()</b>.</p>

<p style="margin-left:11%; margin-top: 1em">If you have a
buffer allocated with <b>Newx()</b> and want to set that as
the <small>SV</small> &rsquo;s value, you can use
<b>sv_usepvn_flags()</b>. That has some requirements if you
want to avoid perl re-allocating the buffer to fit the
trailing <small>NUL:</small></p>

<p style="margin-left:11%; margin-top: 1em">Newx(buf,
somesize+1, char); <br>
/* ... fill in buf ... */ <br>
buf[somesize] = '\0'; <br>
sv_usepvn_flags(sv, buf, somesize, SV_SMAGIC |
SV_HAS_TRAILING_NUL); <br>
/* buf now belongs to perl, don't release it */</p>

<p style="margin-left:11%; margin-top: 1em">If you have an
<small>SV</small> and want to know what kind of data Perl
thinks is stored in it, you can use the following macros to
check the type of <small>SV</small> you have.</p>

<p style="margin-left:11%; margin-top: 1em">SvIOK(SV*) <br>
SvNOK(SV*) <br>
SvPOK(SV*)</p>

<p style="margin-left:11%; margin-top: 1em">Be aware that
retrieving the numeric value of an <small>SV</small> can set
<small>IOK</small> or <small>NOK</small> on that
<small>SV,</small> even when the <small>SV</small> started
as a string. Prior to Perl 5.36.0 retrieving the string
value of an integer could set <small>POK,</small> but this
can no longer occur. From 5.36.0 this can be used to
distinguish the original representation of an
<small>SV</small> and is intended to make life simpler for
serializers:</p>

<p style="margin-left:11%; margin-top: 1em">/* references
handled elsewhere */ <br>
if (SvIsBOOL(sv)) { <br>
/* originally boolean */ <br>
... <br>
} <br>
else if (SvPOK(sv)) { <br>
/* originally a string */ <br>
... <br>
} <br>
else if (SvNIOK(sv)) { <br>
/* originally numeric */ <br>
... <br>
} <br>
else { <br>
/* something special or undef */ <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">You can get and
set the current length of the string stored in an
<small>SV</small> with the following macros:</p>

<p style="margin-left:11%; margin-top: 1em">SvCUR(SV*) <br>
SvCUR_set(SV*, I32 val)</p>

<p style="margin-left:11%; margin-top: 1em">You can also
get a pointer to the end of the string stored in the
<small>SV</small> with the macro:</p>

<p style="margin-left:11%; margin-top: 1em">SvEND(SV*)</p>

<p style="margin-left:11%; margin-top: 1em">But note that
these last three macros are valid only if
&quot;SvPOK()&quot; is true.</p>

<p style="margin-left:11%; margin-top: 1em">If you want to
append something to the end of string stored in an
&quot;SV*&quot;, you can use the following functions:</p>

<p style="margin-left:11%; margin-top: 1em">void
sv_catpv(SV*, const char*); <br>
void sv_catpvn(SV*, const char*, STRLEN); <br>
void sv_catpvf(SV*, const char*, ...); <br>
void sv_vcatpvfn(SV*, const char*, STRLEN, va_list *, SV **,
<br>
I32, bool); <br>
void sv_catsv(SV*, SV*);</p>

<p style="margin-left:11%; margin-top: 1em">The first
function calculates the length of the string to be appended
by using &quot;strlen&quot;. In the second, you specify the
length of the string yourself. The third function processes
its arguments like &quot;sprintf&quot; and appends the
formatted output. The fourth function works like
&quot;vsprintf&quot;. You can specify the address and length
of an array of SVs instead of the va_list argument. The
fifth function extends the string stored in the first
<small>SV</small> with the string stored in the second
<small>SV.</small> It also forces the second
<small>SV</small> to be interpreted as a string.</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;sv_cat*()&quot; functions are not generic enough to
operate on values that have &quot;magic&quot;. See
&quot;Magic Virtual Tables&quot; later in this document.</p>

<p style="margin-left:11%; margin-top: 1em">If you know the
name of a scalar variable, you can get a pointer to its
<small>SV</small> by using the following:</p>

<p style="margin-left:11%; margin-top: 1em">SV*
get_sv(&quot;package::varname&quot;, 0);</p>

<p style="margin-left:11%; margin-top: 1em">This returns
<small>NULL</small> if the variable does not exist.</p>

<p style="margin-left:11%; margin-top: 1em">If you want to
know if this variable (or any other <small>SV</small> ) is
actually &quot;defined&quot;, you can call:</p>

<p style="margin-left:11%; margin-top: 1em">SvOK(SV*)</p>

<p style="margin-left:11%; margin-top: 1em">The scalar
&quot;undef&quot; value is stored in an <small>SV</small>
instance called &quot;PL_sv_undef&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Its address can
be used whenever an &quot;SV*&quot; is needed. Make sure
that you don&rsquo;t try to compare a random sv with
&amp;PL_sv_undef. For example when interfacing Perl code,
it&rsquo;ll work correctly for:</p>


<p style="margin-left:11%; margin-top: 1em">foo(undef);</p>

<p style="margin-left:11%; margin-top: 1em">But won&rsquo;t
work when called as:</p>

<p style="margin-left:11%; margin-top: 1em">$x = undef;
<br>
foo($x);</p>

<p style="margin-left:11%; margin-top: 1em">So to repeat
always use <b>SvOK()</b> to check whether an sv is
defined.</p>

<p style="margin-left:11%; margin-top: 1em">Also you have
to be careful when using &amp;PL_sv_undef as a value in AVs
or HVs (see &quot;AVs, HVs and undefined values&quot;).</p>

<p style="margin-left:11%; margin-top: 1em">There are also
the two values &quot;PL_sv_yes&quot; and
&quot;PL_sv_no&quot;, which contain boolean
<small>TRUE</small> and <small>FALSE</small> values,
respectively. Like &quot;PL_sv_undef&quot;, their addresses
can be used whenever an &quot;SV*&quot; is needed.</p>

<p style="margin-left:11%; margin-top: 1em">Do not be
fooled into thinking that &quot;(SV *) 0&quot; is the same
as &amp;PL_sv_undef. Take this code:</p>

<p style="margin-left:11%; margin-top: 1em">SV* sv = (SV*)
0; <br>
if
(I&minus;am&minus;to&minus;return&minus;a&minus;real&minus;value)
{ <br>
sv = sv_2mortal(newSViv(42)); <br>
} <br>
sv_setsv(ST(0), sv);</p>

<p style="margin-left:11%; margin-top: 1em">This code tries
to return a new <small>SV</small> (which contains the value
42) if it should return a real value, or undef otherwise.
Instead it has returned a <small>NULL</small> pointer which,
somewhere down the line, will cause a segmentation
violation, bus error, or just weird results. Change the zero
to &amp;PL_sv_undef in the first line and all will be
well.</p>

<p style="margin-left:11%; margin-top: 1em">To free an
<small>SV</small> that you&rsquo;ve created, call
&quot;SvREFCNT_dec(SV*)&quot;. Normally this call is not
necessary (see &quot;Reference Counts and
Mortality&quot;).</p>

<p style="margin-left:11%; margin-top: 1em"><b>Offsets</b>
<br>
Perl provides the function &quot;sv_chop&quot; to
efficiently remove characters from the beginning of a
string; you give it an <small>SV</small> and a pointer to
somewhere inside the <small>PV,</small> and it discards
everything before the pointer. The efficiency comes by means
of a little hack: instead of actually removing the
characters, &quot;sv_chop&quot; sets the flag
&quot;OOK&quot; (offset <small>OK</small> ) to signal to
other functions that the offset hack is in effect, and it
moves the <small>PV</small> pointer (called
&quot;SvPVX&quot;) forward by the number of bytes chopped
off, and adjusts &quot;SvCUR&quot; and &quot;SvLEN&quot;
accordingly. (A portion of the space between the old and new
<small>PV</small> pointers is used to store the count of
chopped bytes.)</p>

<p style="margin-left:11%; margin-top: 1em">Hence, at this
point, the start of the buffer that we allocated lives at
&quot;SvPVX(sv) &minus; SvIV(sv)&quot; in memory and the
<small>PV</small> pointer is pointing into the middle of
this allocated storage.</p>

<p style="margin-left:11%; margin-top: 1em">This is best
demonstrated by example. Normally copy-on-write will prevent
the substitution from operator from using this hack, but if
you can craft a string for which copy-on-write is not
possible, you can see it in play. In the current
implementation, the final byte of a string buffer is used as
a copy-on-write reference count. If the buffer is not big
enough, then copy-on-write is skipped. First have a look at
an empty string:</p>

<p style="margin-left:11%; margin-top: 1em">% ./perl
&minus;Ilib &minus;MDevel::Peek &minus;le '$a=&quot;&quot;;
$a .= &quot;&quot;; Dump $a' <br>
SV = PV(0x7ffb7c008a70) at 0x7ffb7c030390 <br>
REFCNT = 1 <br>
FLAGS = (POK,pPOK) <br>
PV = 0x7ffb7bc05b50 &quot;&quot;\0 <br>
CUR = 0 <br>
LEN = 10</p>

<p style="margin-left:11%; margin-top: 1em">Notice here the
<small>LEN</small> is 10. (It may differ on your platform.)
Extend the length of the string to one less than 10, and do
a substitution:</p>

<p style="margin-left:11%; margin-top: 1em">% ./perl
&minus;Ilib &minus;MDevel::Peek &minus;le '$a=&quot;&quot;;
$a.=&quot;123456789&quot;; $a=~s/.//; \ <br>
Dump($a)' <br>
SV = PV(0x7ffa04008a70) at 0x7ffa04030390 <br>
REFCNT = 1 <br>
FLAGS = (POK,OOK,pPOK) <br>
OFFSET = 1 <br>
PV = 0x7ffa03c05b61 ( &quot;\1&quot; . )
&quot;23456789&quot;\0 <br>
CUR = 8 <br>
LEN = 9</p>

<p style="margin-left:11%; margin-top: 1em">Here the number
of bytes chopped off (1) is shown next as the
<small>OFFSET.</small> The portion of the string between the
&quot;real&quot; and the &quot;fake&quot; beginnings is
shown in parentheses, and the values of &quot;SvCUR&quot;
and &quot;SvLEN&quot; reflect the fake beginning, not the
real one. (The first character of the string buffer happens
to have changed to &quot;\1&quot; here, not &quot;1&quot;,
because the current implementation stores the offset count
in the string buffer. This is subject to change.)</p>

<p style="margin-left:11%; margin-top: 1em">Something
similar to the offset hack is performed on AVs to enable
efficient shifting and splicing off the beginning of the
array; while &quot;AvARRAY&quot; points to the first element
in the array that is visible from Perl, &quot;AvALLOC&quot;
points to the real start of the C array. These are usually
the same, but a &quot;shift&quot; operation can be carried
out by increasing &quot;AvARRAY&quot; by one and decreasing
&quot;AvFILL&quot; and &quot;AvMAX&quot;. Again, the
location of the real start of the C array only comes into
play when freeing the array. See &quot;av_shift&quot; in
<i>av.c</i>.</p>


<p style="margin-left:11%; margin-top: 1em"><b>What&rsquo;s
Really Stored in an <small>SV</small> ?</b> <br>
Recall that the usual method of determining the type of
scalar you have is to use &quot;Sv*OK&quot; macros. Because
a scalar can be both a number and a string, usually these
macros will always return <small>TRUE</small> and calling
the &quot;Sv*V&quot; macros will do the appropriate
conversion of string to integer/double or integer/double to
string.</p>

<p style="margin-left:11%; margin-top: 1em">If you
<i>really</i> need to know if you have an integer, double,
or string pointer in an <small>SV,</small> you can use the
following three macros instead:</p>

<p style="margin-left:11%; margin-top: 1em">SvIOKp(SV*)
<br>
SvNOKp(SV*) <br>
SvPOKp(SV*)</p>

<p style="margin-left:11%; margin-top: 1em">These will tell
you if you truly have an integer, double, or string pointer
stored in your <small>SV.</small> The &quot;p&quot; stands
for private.</p>

<p style="margin-left:11%; margin-top: 1em">There are
various ways in which the private and public flags may
differ. For example, in perl 5.16 and earlier a tied
<small>SV</small> may have a valid underlying value in the
<small>IV</small> slot (so SvIOKp is true), but the data
should be accessed via the <small>FETCH</small> routine
rather than directly, so SvIOK is false. (In perl 5.18
onwards, tied scalars use the flags the same way as untied
scalars.) Another is when numeric conversion has occurred
and precision has been lost: only the private flag is set on
&rsquo;lossy&rsquo; values. So when an <small>NV</small> is
converted to an <small>IV</small> with loss, SvIOKp, SvNOKp
and SvNOK will be set, while SvIOK wont be.</p>

<p style="margin-left:11%; margin-top: 1em">In general,
though, it&rsquo;s best to use the &quot;Sv*V&quot;
macros.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Working with
AVs</b> <br>
There are two ways to create and load an <small>AV.</small>
The first method creates an empty <small>AV:</small></p>

<p style="margin-left:11%; margin-top: 1em">AV*
newAV();</p>

<p style="margin-left:11%; margin-top: 1em">The second
method both creates the <small>AV</small> and initially
populates it with SVs:</p>

<p style="margin-left:11%; margin-top: 1em">AV*
av_make(SSize_t num, SV **ptr);</p>

<p style="margin-left:11%; margin-top: 1em">The second
argument points to an array containing &quot;num&quot;
&quot;SV*&quot;&rsquo;s. Once the <small>AV</small> has been
created, the SVs can be destroyed, if so desired.</p>

<p style="margin-left:11%; margin-top: 1em">Once the
<small>AV</small> has been created, the following operations
are possible on it:</p>

<p style="margin-left:11%; margin-top: 1em">void
av_push(AV*, SV*); <br>
SV* av_pop(AV*); <br>
SV* av_shift(AV*); <br>
void av_unshift(AV*, SSize_t num);</p>

<p style="margin-left:11%; margin-top: 1em">These should be
familiar operations, with the exception of
&quot;av_unshift&quot;. This routine adds &quot;num&quot;
elements at the front of the array with the
&quot;undef&quot; value. You must then use
&quot;av_store&quot; (described below) to assign values to
these new elements.</p>

<p style="margin-left:11%; margin-top: 1em">Here are some
other functions:</p>

<p style="margin-left:11%; margin-top: 1em">SSize_t
av_top_index(AV*); <br>
SV** av_fetch(AV*, SSize_t key, I32 lval); <br>
SV** av_store(AV*, SSize_t key, SV* val);</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;av_top_index&quot; function returns the highest index
value in an array (just like $#array in Perl). If the array
is empty, &minus;1 is returned. The &quot;av_fetch&quot;
function returns the value at index &quot;key&quot;, but if
&quot;lval&quot; is non-zero, then &quot;av_fetch&quot; will
store an undef value at that index. The &quot;av_store&quot;
function stores the value &quot;val&quot; at index
&quot;key&quot;, and does not increment the reference count
of &quot;val&quot;. Thus the caller is responsible for
taking care of that, and if &quot;av_store&quot; returns
<small>NULL,</small> the caller will have to decrement the
reference count to avoid a memory leak. Note that
&quot;av_fetch&quot; and &quot;av_store&quot; both return
&quot;SV**&quot;&rsquo;s, not &quot;SV*&quot;&rsquo;s as
their return value.</p>

<p style="margin-left:11%; margin-top: 1em">A few more:</p>

<p style="margin-left:11%; margin-top: 1em">void
av_clear(AV*); <br>
void av_undef(AV*); <br>
void av_extend(AV*, SSize_t key);</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;av_clear&quot; function deletes all the elements in
the AV* array, but does not actually delete the array
itself. The &quot;av_undef&quot; function will delete all
the elements in the array plus the array itself. The
&quot;av_extend&quot; function extends the array so that it
contains at least &quot;key+1&quot; elements. If
&quot;key+1&quot; is less than the currently allocated
length of the array, then nothing is done.</p>

<p style="margin-left:11%; margin-top: 1em">If you know the
name of an array variable, you can get a pointer to its
<small>AV</small> by using the following:</p>

<p style="margin-left:11%; margin-top: 1em">AV*
get_av(&quot;package::varname&quot;, 0);</p>

<p style="margin-left:11%; margin-top: 1em">This returns
<small>NULL</small> if the variable does not exist.</p>

<p style="margin-left:11%; margin-top: 1em">See
&quot;Understanding the Magic of Tied Hashes and
Arrays&quot; for more information on how to use the array
access functions on tied arrays.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Working with
HVs</b> <br>
To create an <small>HV,</small> you use the following
routine:</p>

<p style="margin-left:11%; margin-top: 1em">HV*
newHV();</p>

<p style="margin-left:11%; margin-top: 1em">Once the
<small>HV</small> has been created, the following operations
are possible on it:</p>

<p style="margin-left:11%; margin-top: 1em">SV**
hv_store(HV*, const char* key, U32 klen, SV* val, U32 hash);
<br>
SV** hv_fetch(HV*, const char* key, U32 klen, I32 lval);</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;klen&quot; parameter is the length of the key being
passed in (Note that you cannot pass 0 in as a value of
&quot;klen&quot; to tell Perl to measure the length of the
key). The &quot;val&quot; argument contains the
<small>SV</small> pointer to the scalar being stored, and
&quot;hash&quot; is the precomputed hash value (zero if you
want &quot;hv_store&quot; to calculate it for you). The
&quot;lval&quot; parameter indicates whether this fetch is
actually a part of a store operation, in which case a new
undefined value will be added to the <small>HV</small> with
the supplied key and &quot;hv_fetch&quot; will return as if
the value had already existed.</p>

<p style="margin-left:11%; margin-top: 1em">Remember that
&quot;hv_store&quot; and &quot;hv_fetch&quot; return
&quot;SV**&quot;&rsquo;s and not just &quot;SV*&quot;. To
access the scalar value, you must first dereference the
return value. However, you should check to make sure that
the return value is not <small>NULL</small> before
dereferencing it.</p>

<p style="margin-left:11%; margin-top: 1em">The first of
these two functions checks if a hash table entry exists, and
the second deletes it.</p>

<p style="margin-left:11%; margin-top: 1em">bool
hv_exists(HV*, const char* key, U32 klen); <br>
SV* hv_delete(HV*, const char* key, U32 klen, I32
flags);</p>

<p style="margin-left:11%; margin-top: 1em">If
&quot;flags&quot; does not include the &quot;G_DISCARD&quot;
flag then &quot;hv_delete&quot; will create and return a
mortal copy of the deleted value.</p>

<p style="margin-left:11%; margin-top: 1em">And more
miscellaneous functions:</p>

<p style="margin-left:11%; margin-top: 1em">void
hv_clear(HV*); <br>
void hv_undef(HV*);</p>

<p style="margin-left:11%; margin-top: 1em">Like their
<small>AV</small> counterparts, &quot;hv_clear&quot; deletes
all the entries in the hash table but does not actually
delete the hash table. The &quot;hv_undef&quot; deletes both
the entries and the hash table itself.</p>

<p style="margin-left:11%; margin-top: 1em">Perl keeps the
actual data in a linked list of structures with a typedef of
<small>HE.</small> These contain the actual key and value
pointers (plus extra administrative overhead). The key is a
string pointer; the value is an &quot;SV*&quot;. However,
once you have an &quot;HE*&quot;, to get the actual key and
value, use the routines specified below.</p>

<p style="margin-left:11%; margin-top: 1em">I32
hv_iterinit(HV*); <br>
/* Prepares starting point to traverse hash table */ <br>
HE* hv_iternext(HV*); <br>
/* Get the next entry, and return a pointer to a <br>
structure that has both the key and value */ <br>
char* hv_iterkey(HE* entry, I32* retlen); <br>
/* Get the key from an HE structure and also return <br>
the length of the key string */ <br>
SV* hv_iterval(HV*, HE* entry); <br>
/* Return an SV pointer to the value of the HE <br>
structure */ <br>
SV* hv_iternextsv(HV*, char** key, I32* retlen); <br>
/* This convenience routine combines hv_iternext, <br>
hv_iterkey, and hv_iterval. The key and retlen <br>
arguments are return values for the key and its <br>
length. The value is returned in the SV* argument */</p>

<p style="margin-left:11%; margin-top: 1em">If you know the
name of a hash variable, you can get a pointer to its
<small>HV</small> by using the following:</p>

<p style="margin-left:11%; margin-top: 1em">HV*
get_hv(&quot;package::varname&quot;, 0);</p>

<p style="margin-left:11%; margin-top: 1em">This returns
<small>NULL</small> if the variable does not exist.</p>

<p style="margin-left:11%; margin-top: 1em">The hash
algorithm is defined in the &quot;PERL_HASH&quot; macro:</p>


<p style="margin-left:11%; margin-top: 1em">PERL_HASH(hash,
key, klen)</p>

<p style="margin-left:11%; margin-top: 1em">The exact
implementation of this macro varies by architecture and
version of perl, and the return value may change per
invocation, so the value is only valid for the duration of a
single perl process.</p>

<p style="margin-left:11%; margin-top: 1em">See
&quot;Understanding the Magic of Tied Hashes and
Arrays&quot; for more information on how to use the hash
access functions on tied hashes.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Hash
<small>API</small> Extensions</b> <br>
Beginning with version 5.004, the following functions are
also supported:</p>

<p style="margin-left:11%; margin-top: 1em">HE*
hv_fetch_ent (HV* tb, SV* key, I32 lval, U32 hash); <br>
HE* hv_store_ent (HV* tb, SV* key, SV* val, U32 hash); <br>
bool hv_exists_ent (HV* tb, SV* key, U32 hash); <br>
SV* hv_delete_ent (HV* tb, SV* key, I32 flags, U32 hash);
<br>
SV* hv_iterkeysv (HE* entry);</p>

<p style="margin-left:11%; margin-top: 1em">Note that these
functions take &quot;SV*&quot; keys, which simplifies
writing of extension code that deals with hash structures.
These functions also allow passing of &quot;SV*&quot; keys
to &quot;tie&quot; functions without forcing you to
stringify the keys (unlike the previous set of
functions).</p>

<p style="margin-left:11%; margin-top: 1em">They also
return and accept whole hash entries (&quot;HE*&quot;),
making their use more efficient (since the hash number for a
particular string doesn&rsquo;t have to be recomputed every
time). See perlapi for detailed descriptions.</p>

<p style="margin-left:11%; margin-top: 1em">The following
macros must always be used to access the contents of hash
entries. Note that the arguments to these macros must be
simple variables, since they may get evaluated more than
once. See perlapi for detailed descriptions of these
macros.</p>

<p style="margin-left:11%; margin-top: 1em">HePV(HE* he,
STRLEN len) <br>
HeVAL(HE* he) <br>
HeHASH(HE* he) <br>
HeSVKEY(HE* he) <br>
HeSVKEY_force(HE* he) <br>
HeSVKEY_set(HE* he, SV* sv)</p>

<p style="margin-left:11%; margin-top: 1em">These two lower
level macros are defined, but must only be used when dealing
with keys that are not &quot;SV*&quot;s:</p>

<p style="margin-left:11%; margin-top: 1em">HeKEY(HE* he)
<br>
HeKLEN(HE* he)</p>

<p style="margin-left:11%; margin-top: 1em">Note that both
&quot;hv_store&quot; and &quot;hv_store_ent&quot; do not
increment the reference count of the stored &quot;val&quot;,
which is the caller&rsquo;s responsibility. If these
functions return a <small>NULL</small> value, the caller
will usually have to decrement the reference count of
&quot;val&quot; to avoid a memory leak.</p>

<p style="margin-left:11%; margin-top: 1em"><b>AVs, HVs and
undefined values</b> <br>
Sometimes you have to store undefined values in AVs or HVs.
Although this may be a rare case, it can be tricky.
That&rsquo;s because you&rsquo;re used to using
&amp;PL_sv_undef if you need an undefined
<small>SV.</small></p>

<p style="margin-left:11%; margin-top: 1em">For example,
intuition tells you that this <small>XS</small> code:</p>

<p style="margin-left:11%; margin-top: 1em">AV *av =
newAV(); <br>
av_store( av, 0, &amp;PL_sv_undef );</p>

<p style="margin-left:11%; margin-top: 1em">is equivalent
to this Perl code:</p>

<p style="margin-left:11%; margin-top: 1em">my @av; <br>
$av[0] = undef;</p>

<p style="margin-left:11%; margin-top: 1em">Unfortunately,
this isn&rsquo;t true. In perl 5.18 and earlier, AVs use
&amp;PL_sv_undef as a marker for indicating that an array
element has not yet been initialized. Thus, &quot;exists
$av[0]&quot; would be true for the above Perl code, but
false for the array generated by the <small>XS</small> code.
In perl 5.20, storing &amp;PL_sv_undef will create a
read-only element, because the scalar &amp;PL_sv_undef
itself is stored, not a copy.</p>

<p style="margin-left:11%; margin-top: 1em">Similar
problems can occur when storing &amp;PL_sv_undef in HVs:</p>

<p style="margin-left:11%; margin-top: 1em">hv_store( hv,
&quot;key&quot;, 3, &amp;PL_sv_undef, 0 );</p>

<p style="margin-left:11%; margin-top: 1em">This will
indeed make the value &quot;undef&quot;, but if you try to
modify the value of &quot;key&quot;, you&rsquo;ll get the
following error:</p>

<p style="margin-left:11%; margin-top: 1em">Modification of
non&minus;creatable hash value attempted</p>

<p style="margin-left:11%; margin-top: 1em">In perl 5.8.0,
&amp;PL_sv_undef was also used to mark placeholders in
restricted hashes. This caused such hash entries not to
appear when iterating over the hash or when checking for the
keys with the &quot;hv_exists&quot; function.</p>

<p style="margin-left:11%; margin-top: 1em">You can run
into similar problems when you store &amp;PL_sv_yes or
&amp;PL_sv_no into AVs or HVs. Trying to modify such
elements will give you the following error:</p>

<p style="margin-left:11%; margin-top: 1em">Modification of
a read&minus;only value attempted</p>

<p style="margin-left:11%; margin-top: 1em">To make a long
story short, you can use the special variables
&amp;PL_sv_undef, &amp;PL_sv_yes and &amp;PL_sv_no with AVs
and HVs, but you have to make sure you know what
you&rsquo;re doing.</p>

<p style="margin-left:11%; margin-top: 1em">Generally, if
you want to store an undefined value in an <small>AV</small>
or <small>HV,</small> you should not use &amp;PL_sv_undef,
but rather create a new undefined value using the
&quot;newSV&quot; function, for example:</p>

<p style="margin-left:11%; margin-top: 1em">av_store( av,
42, newSV(0) ); <br>
hv_store( hv, &quot;foo&quot;, 3, newSV(0), 0 );</p>


<p style="margin-left:11%; margin-top: 1em"><b>References</b>
<br>
References are a special type of scalar that point to other
data types (including other references).</p>

<p style="margin-left:11%; margin-top: 1em">To create a
reference, use either of the following functions:</p>

<p style="margin-left:11%; margin-top: 1em">SV*
newRV_inc((SV*) thing); <br>
SV* newRV_noinc((SV*) thing);</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;thing&quot; argument can be any of an &quot;SV*&quot;,
&quot;AV*&quot;, or &quot;HV*&quot;. The functions are
identical except that &quot;newRV_inc&quot; increments the
reference count of the &quot;thing&quot;, while
&quot;newRV_noinc&quot; does not. For historical reasons,
&quot;newRV&quot; is a synonym for
&quot;newRV_inc&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Once you have a
reference, you can use the following macro to dereference
the reference:</p>

<p style="margin-left:11%; margin-top: 1em">SvRV(SV*)</p>

<p style="margin-left:11%; margin-top: 1em">then call the
appropriate routines, casting the returned &quot;SV*&quot;
to either an &quot;AV*&quot; or &quot;HV*&quot;, if
required.</p>

<p style="margin-left:11%; margin-top: 1em">To determine if
an <small>SV</small> is a reference, you can use the
following macro:</p>

<p style="margin-left:11%; margin-top: 1em">SvROK(SV*)</p>

<p style="margin-left:11%; margin-top: 1em">To discover
what type of value the reference refers to, use the
following macro and then check the return value.</p>


<p style="margin-left:11%; margin-top: 1em">SvTYPE(SvRV(SV*))</p>

<p style="margin-left:11%; margin-top: 1em">The most useful
types that will be returned are:</p>

<p style="margin-left:11%; margin-top: 1em">SVt_PVAV Array
<br>
SVt_PVHV Hash <br>
SVt_PVCV Code <br>
SVt_PVGV Glob (possibly a file handle)</p>

<p style="margin-left:11%; margin-top: 1em">Any numerical
value returned which is less than SVt_PVAV will be a scalar
of some form.</p>

<p style="margin-left:11%; margin-top: 1em">See
&quot;svtype&quot; in perlapi for more details.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Blessed
References and Class Objects</b> <br>
References are also used to support object-oriented
programming. In perl&rsquo;s <small>OO</small> lexicon, an
object is simply a reference that has been blessed into a
package (or class). Once blessed, the programmer may now use
the reference to access the various methods in the
class.</p>

<p style="margin-left:11%; margin-top: 1em">A reference can
be blessed into a package with the following function:</p>

<p style="margin-left:11%; margin-top: 1em">SV*
sv_bless(SV* sv, HV* stash);</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;sv&quot; argument must be a reference value. The
&quot;stash&quot; argument specifies which class the
reference will belong to. See &quot;Stashes and Globs&quot;
for information on converting class names into stashes.</p>

<p style="margin-left:11%; margin-top: 1em">/* Still under
construction */</p>

<p style="margin-left:11%; margin-top: 1em">The following
function upgrades rv to reference if not already one.
Creates a new <small>SV</small> for rv to point to. If
&quot;classname&quot; is non-null, the <small>SV</small> is
blessed into the specified class. <small>SV</small> is
returned.</p>

<p style="margin-left:11%; margin-top: 1em">SV* newSVrv(SV*
rv, const char* classname);</p>

<p style="margin-left:11%; margin-top: 1em">The following
three functions copy integer, unsigned integer or double
into an <small>SV</small> whose reference is &quot;rv&quot;.
<small>SV</small> is blessed if &quot;classname&quot; is
non-null.</p>

<p style="margin-left:11%; margin-top: 1em">SV*
sv_setref_iv(SV* rv, const char* classname, IV iv); <br>
SV* sv_setref_uv(SV* rv, const char* classname, UV uv); <br>
SV* sv_setref_nv(SV* rv, const char* classname, NV iv);</p>

<p style="margin-left:11%; margin-top: 1em">The following
function copies the pointer value (<i>the address, not the
string!</i>) into an <small>SV</small> whose reference is
rv. <small>SV</small> is blessed if &quot;classname&quot; is
non-null.</p>

<p style="margin-left:11%; margin-top: 1em">SV*
sv_setref_pv(SV* rv, const char* classname, void* pv);</p>

<p style="margin-left:11%; margin-top: 1em">The following
function copies a string into an <small>SV</small> whose
reference is &quot;rv&quot;. Set length to 0 to let Perl
calculate the string length. <small>SV</small> is blessed if
&quot;classname&quot; is non-null.</p>

<p style="margin-left:11%; margin-top: 1em">SV*
sv_setref_pvn(SV* rv, const char* classname, char* pv, <br>
STRLEN length);</p>

<p style="margin-left:11%; margin-top: 1em">The following
function tests whether the <small>SV</small> is blessed into
the specified class. It does not check inheritance
relationships.</p>

<p style="margin-left:11%; margin-top: 1em">int sv_isa(SV*
sv, const char* name);</p>

<p style="margin-left:11%; margin-top: 1em">The following
function tests whether the <small>SV</small> is a reference
to a blessed object.</p>

<p style="margin-left:11%; margin-top: 1em">int
sv_isobject(SV* sv);</p>

<p style="margin-left:11%; margin-top: 1em">The following
function tests whether the <small>SV</small> is derived from
the specified class. <small>SV</small> can be either a
reference to a blessed object or a string containing a class
name. This is the function implementing the
&quot;UNIVERSAL::isa&quot; functionality.</p>

<p style="margin-left:11%; margin-top: 1em">bool
sv_derived_from(SV* sv, const char* name);</p>

<p style="margin-left:11%; margin-top: 1em">To check if
you&rsquo;ve got an object derived from a specific class you
have to write:</p>

<p style="margin-left:11%; margin-top: 1em">if
(sv_isobject(sv) &amp;&amp; sv_derived_from(sv, class)) {
... }</p>

<p style="margin-left:11%; margin-top: 1em"><b>Creating New
Variables</b> <br>
To create a new Perl variable with an undef value which can
be accessed from your Perl script, use the following
routines, depending on the variable type.</p>

<p style="margin-left:11%; margin-top: 1em">SV*
get_sv(&quot;package::varname&quot;, GV_ADD); <br>
AV* get_av(&quot;package::varname&quot;, GV_ADD); <br>
HV* get_hv(&quot;package::varname&quot;, GV_ADD);</p>

<p style="margin-left:11%; margin-top: 1em">Notice the use
of <small>GV_ADD</small> as the second parameter. The new
variable can now be set, using the routines appropriate to
the data type.</p>

<p style="margin-left:11%; margin-top: 1em">There are
additional macros whose values may be bitwise
<small>OR</small> &rsquo;ed with the &quot;GV_ADD&quot;
argument to enable certain extra features. Those bits are:
<small><br>
GV_ADDMULTI</small></p>

<p style="margin-left:17%;">Marks the variable as multiply
defined, thus preventing the:</p>

<p style="margin-left:17%; margin-top: 1em">Name
&lt;varname&gt; used only once: possible typo</p>

<p style="margin-left:17%; margin-top: 1em">warning.</p>

<p style="margin-left:11%;"><small>GV_ADDWARN</small></p>

<p style="margin-left:17%;">Issues the warning:</p>

<p style="margin-left:17%; margin-top: 1em">Had to create
&lt;varname&gt; unexpectedly</p>

<p style="margin-left:17%; margin-top: 1em">if the variable
did not exist before the function was called.</p>

<p style="margin-left:11%; margin-top: 1em">If you do not
specify a package name, the variable is created in the
current package.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Reference
Counts and Mortality</b> <br>
Perl uses a reference count-driven garbage collection
mechanism. SVs, AVs, or HVs (xV for short in the following)
start their life with a reference count of 1. If the
reference count of an xV ever drops to 0, then it will be
destroyed and its memory made available for reuse. At the
most basic internal level, reference counts can be
manipulated with the following macros:</p>

<p style="margin-left:11%; margin-top: 1em">int
SvREFCNT(SV* sv); <br>
SV* SvREFCNT_inc(SV* sv); <br>
void SvREFCNT_dec(SV* sv);</p>

<p style="margin-left:11%; margin-top: 1em">(There are also
suffixed versions of the increment and decrement macros, for
situations where the full generality of these basic macros
can be exchanged for some performance.)</p>

<p style="margin-left:11%; margin-top: 1em">However, the
way a programmer should think about references is not so
much in terms of the bare reference count, but in terms of
<i>ownership</i> of references. A reference to an xV can be
owned by any of a variety of entities: another xV, the Perl
interpreter, an <small>XS</small> data structure, a piece of
running code, or a dynamic scope. An xV generally does not
know what entities own the references to it; it only knows
how many references there are, which is the reference
count.</p>

<p style="margin-left:11%; margin-top: 1em">To correctly
maintain reference counts, it is essential to keep track of
what references the <small>XS</small> code is manipulating.
The programmer should always know where a reference has come
from and who owns it, and be aware of any creation or
destruction of references, and any transfers of ownership.
Because ownership isn&rsquo;t represented explicitly in the
xV data structures, only the reference count need be
actually maintained by the code, and that means that this
understanding of ownership is not actually evident in the
code. For example, transferring ownership of a reference
from one owner to another doesn&rsquo;t change the reference
count at all, so may be achieved with no actual code. (The
transferring code doesn&rsquo;t touch the referenced object,
but does need to ensure that the former owner knows that it
no longer owns the reference, and that the new owner knows
that it now does.)</p>

<p style="margin-left:11%; margin-top: 1em">An xV that is
visible at the Perl level should not become unreferenced and
thus be destroyed. Normally, an object will only become
unreferenced when it is no longer visible, often by the same
means that makes it invisible. For example, a Perl reference
value ( <small>RV</small> ) owns a reference to its
referent, so if the <small>RV</small> is overwritten that
reference gets destroyed, and the no-longer-reachable
referent may be destroyed as a result.</p>

<p style="margin-left:11%; margin-top: 1em">Many functions
have some kind of reference manipulation as part of their
purpose. Sometimes this is documented in terms of ownership
of references, and sometimes it is (less helpfully)
documented in terms of changes to reference counts. For
example, the <b>newRV_inc()</b> function is documented to
create a new <small>RV</small> (with reference count 1) and
increment the reference count of the referent that was
supplied by the caller. This is best understood as creating
a new reference to the referent, which is owned by the
created <small>RV,</small> and returning to the caller
ownership of the sole reference to the <small>RV.</small>
The <b>newRV_noinc()</b> function instead does not increment
the reference count of the referent, but the
<small>RV</small> nevertheless ends up owning a reference to
the referent. It is therefore implied that the caller of
&quot;newRV_noinc()&quot; is relinquishing a reference to
the referent, making this conceptually a more complicated
operation even though it does less to the data
structures.</p>

<p style="margin-left:11%; margin-top: 1em">For example,
imagine you want to return a reference from an
<small>XSUB</small> function. Inside the <small>XSUB</small>
routine, you create an <small>SV</small> which initially has
just a single reference, owned by the <small>XSUB</small>
routine. This reference needs to be disposed of before the
routine is complete, otherwise it will leak, preventing the
<small>SV</small> from ever being destroyed. So to create an
<small>RV</small> referencing the <small>SV,</small> it is
most convenient to pass the <small>SV</small> to
&quot;newRV_noinc()&quot;, which consumes that reference.
Now the <small>XSUB</small> routine no longer owns a
reference to the <small>SV,</small> but does own a reference
to the <small>RV,</small> which in turn owns a reference to
the <small>SV.</small> The ownership of the reference to the
<small>RV</small> is then transferred by the process of
returning the <small>RV</small> from the
<small>XSUB.</small></p>

<p style="margin-left:11%; margin-top: 1em">There are some
convenience functions available that can help with the
destruction of xVs. These functions introduce the concept of
&quot;mortality&quot;. Much documentation speaks of an xV
itself being mortal, but this is misleading. It is really
<i>a reference to</i> an xV that is mortal, and it is
possible for there to be more than one mortal reference to a
single xV. For a reference to be mortal means that it is
owned by the temps stack, one of perl&rsquo;s many internal
stacks, which will destroy that reference &quot;a short time
later&quot;. Usually the &quot;short time later&quot; is the
end of the current Perl statement. However, it gets more
complicated around dynamic scopes: there can be multiple
sets of mortal references hanging around at the same time,
with different death dates. Internally, the actual
determinant for when mortal xV references are destroyed
depends on two macros, <small>SAVETMPS</small> and
<small>FREETMPS.</small> See perlcall and perlxs and
&quot;Temporaries Stack&quot; below for more details on
these macros.</p>

<p style="margin-left:11%; margin-top: 1em">Mortal
references are mainly used for xVs that are placed on
perl&rsquo;s main stack. The stack is problematic for
reference tracking, because it contains a lot of xV
references, but doesn&rsquo;t own those references: they are
not counted. Currently, there are many bugs resulting from
xVs being destroyed while referenced by the stack, because
the stack&rsquo;s uncounted references aren&rsquo;t enough
to keep the xVs alive. So when putting an (uncounted)
reference on the stack, it is vitally important to ensure
that there will be a counted reference to the same xV that
will last at least as long as the uncounted reference. But
it&rsquo;s also important that that counted reference be
cleaned up at an appropriate time, and not unduly prolong
the xV&rsquo;s life. For there to be a mortal reference is
often the best way to satisfy this requirement, especially
if the xV was created especially to be put on the stack and
would otherwise be unreferenced.</p>

<p style="margin-left:11%; margin-top: 1em">To create a
mortal reference, use the functions:</p>

<p style="margin-left:11%; margin-top: 1em">SV*
sv_newmortal() <br>
SV* sv_mortalcopy(SV*) <br>
SV* sv_2mortal(SV*)</p>


<p style="margin-left:11%; margin-top: 1em">&quot;sv_newmortal()&quot;
creates an <small>SV</small> (with the undefined value)
whose sole reference is mortal. &quot;sv_mortalcopy()&quot;
creates an xV whose value is a copy of a supplied xV and
whose sole reference is mortal. &quot;sv_2mortal()&quot;
mortalises an existing xV reference: it transfers ownership
of a reference from the caller to the temps stack. Because
&quot;sv_newmortal&quot; gives the new <small>SV</small> no
value, it must normally be given one via
&quot;sv_setpv&quot;, &quot;sv_setiv&quot;, etc. :</p>

<p style="margin-left:11%; margin-top: 1em">SV *tmp =
sv_newmortal(); <br>
sv_setiv(tmp, an_integer);</p>

<p style="margin-left:11%; margin-top: 1em">As that is
multiple C statements it is quite common so see this idiom
instead:</p>

<p style="margin-left:11%; margin-top: 1em">SV *tmp =
sv_2mortal(newSViv(an_integer));</p>

<p style="margin-left:11%; margin-top: 1em">The mortal
routines are not just for SVs; AVs and HVs can be made
mortal by passing their address (type-casted to
&quot;SV*&quot;) to the &quot;sv_2mortal&quot; or
&quot;sv_mortalcopy&quot; routines.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Stashes and
Globs</b> <br>
A <b>stash</b> is a hash that contains all variables that
are defined within a package. Each key of the stash is a
symbol name (shared by all the different types of objects
that have the same name), and each value in the hash table
is a <small>GV</small> (Glob Value). This <small>GV</small>
in turn contains references to the various objects of that
name, including (but not limited to) the following:</p>

<p style="margin-left:11%; margin-top: 1em">Scalar Value
<br>
Array Value <br>
Hash Value <br>
I/O Handle <br>
Format <br>
Subroutine</p>

<p style="margin-left:11%; margin-top: 1em">There is a
single stash called &quot;PL_defstash&quot; that holds the
items that exist in the &quot;main&quot; package. To get at
the items in other packages, append the string
&quot;::&quot; to the package name. The items in the
&quot;Foo&quot; package are in the stash &quot;Foo::&quot;
in PL_defstash. The items in the &quot;Bar::Baz&quot;
package are in the stash &quot;Baz::&quot; in
&quot;Bar::&quot;&rsquo;s stash.</p>

<p style="margin-left:11%; margin-top: 1em">To get the
stash pointer for a particular package, use the
function:</p>

<p style="margin-left:11%; margin-top: 1em">HV*
gv_stashpv(const char* name, I32 flags) <br>
HV* gv_stashsv(SV*, I32 flags)</p>

<p style="margin-left:11%; margin-top: 1em">The first
function takes a literal string, the second uses the string
stored in the <small>SV.</small> Remember that a stash is
just a hash table, so you get back an &quot;HV*&quot;. The
&quot;flags&quot; flag will create a new package if it is
set to <small>GV_ADD.</small></p>

<p style="margin-left:11%; margin-top: 1em">The name that
&quot;gv_stash*v&quot; wants is the name of the package
whose symbol table you want. The default package is called
&quot;main&quot;. If you have multiply nested packages, pass
their names to &quot;gv_stash*v&quot;, separated by
&quot;::&quot; as in the Perl language itself.</p>

<p style="margin-left:11%; margin-top: 1em">Alternately, if
you have an <small>SV</small> that is a blessed reference,
you can find out the stash pointer by using:</p>

<p style="margin-left:11%; margin-top: 1em">HV*
SvSTASH(SvRV(SV*));</p>

<p style="margin-left:11%; margin-top: 1em">then use the
following to get the package name itself:</p>

<p style="margin-left:11%; margin-top: 1em">char*
HvNAME(HV* stash);</p>

<p style="margin-left:11%; margin-top: 1em">If you need to
bless or re-bless an object you can use the following
function:</p>

<p style="margin-left:11%; margin-top: 1em">SV*
sv_bless(SV*, HV* stash)</p>

<p style="margin-left:11%; margin-top: 1em">where the first
argument, an &quot;SV*&quot;, must be a reference, and the
second argument is a stash. The returned &quot;SV*&quot; can
now be used in the same way as any other
<small>SV.</small></p>

<p style="margin-left:11%; margin-top: 1em">For more
information on references and blessings, consult
perlref.</p>

<p style="margin-left:11%; margin-top: 1em"><b>I/O
Handles</b> <br>
Like AVs and HVs, <small>IO</small> objects are another type
of non-scalar <small>SV</small> which may contain input and
output PerlIO objects or a &quot;DIR *&quot; from
<b>opendir()</b>.</p>

<p style="margin-left:11%; margin-top: 1em">You can create
a new <small>IO</small> object:</p>

<p style="margin-left:11%; margin-top: 1em">IO*
newIO();</p>

<p style="margin-left:11%; margin-top: 1em">Unlike other
SVs, a new <small>IO</small> object is automatically blessed
into the IO::File class.</p>

<p style="margin-left:11%; margin-top: 1em">The
<small>IO</small> object contains an input and output PerlIO
handle:</p>

<p style="margin-left:11%; margin-top: 1em">PerlIO
*IoIFP(IO *io); <br>
PerlIO *IoOFP(IO *io);</p>

<p style="margin-left:11%; margin-top: 1em">Typically if
the <small>IO</small> object has been opened on a file, the
input handle is always present, but the output handle is
only present if the file is open for output. For a file, if
both are present they will be the same PerlIO object.</p>

<p style="margin-left:11%; margin-top: 1em">Distinct input
and output PerlIO objects are created for sockets and
character devices.</p>

<p style="margin-left:11%; margin-top: 1em">The
<small>IO</small> object also contains other data associated
with Perl I/O handles:</p>

<p style="margin-left:11%; margin-top: 1em">IV IoLINES(io);
/* $. */ <br>
IV IoPAGE(io); /* $% */ <br>
IV IoPAGE_LEN(io); /* $= */ <br>
IV IoLINES_LEFT(io); /* $&minus; */ <br>
char *IoTOP_NAME(io); /* $^ */ <br>
GV *IoTOP_GV(io); /* $^ */ <br>
char *IoFMT_NAME(io); /* $~ */ <br>
GV *IoFMT_GV(io); /* $~ */ <br>
char *IoBOTTOM_NAME(io); <br>
GV *IoBOTTOM_GV(io); <br>
char IoTYPE(io); <br>
U8 IoFLAGS(io); <br>
=for apidoc_sections $io_scn, $formats_section <br>
=for apidoc_section $reports <br>
=for apidoc Amh|IV|IoLINES|IO *io <br>
=for apidoc Amh|IV|IoPAGE|IO *io <br>
=for apidoc Amh|IV|IoPAGE_LEN|IO *io <br>
=for apidoc Amh|IV|IoLINES_LEFT|IO *io <br>
=for apidoc Amh|char *|IoTOP_NAME|IO *io <br>
=for apidoc Amh|GV *|IoTOP_GV|IO *io <br>
=for apidoc Amh|char *|IoFMT_NAME|IO *io <br>
=for apidoc Amh|GV *|IoFMT_GV|IO *io <br>
=for apidoc Amh|char *|IoBOTTOM_NAME|IO *io <br>
=for apidoc Amh|GV *|IoBOTTOM_GV|IO *io <br>
=for apidoc_section $io <br>
=for apidoc Amh|char|IoTYPE|IO *io <br>
=for apidoc Amh|U8|IoFLAGS|IO *io</p>

<p style="margin-left:11%; margin-top: 1em">Most of these
are involved with formats.</p>


<p style="margin-left:11%; margin-top: 1em"><b>IoFLAGs()</b>
may contain a combination of flags, the most interesting of
which are &quot;IOf_FLUSH&quot; ($|) for autoflush and
&quot;IOf_UNTAINT&quot;, settable with IO::Handle&rsquo;s
<b>untaint()</b> method.</p>

<p style="margin-left:11%; margin-top: 1em">The
<small>IO</small> object may also contains a directory
handle:</p>

<p style="margin-left:11%; margin-top: 1em">DIR
*IoDIRP(io);</p>

<p style="margin-left:11%; margin-top: 1em">suitable for
use with <b>PerlDir_read()</b> etc.</p>

<p style="margin-left:11%; margin-top: 1em">All of these
accessors macros are lvalues, there are no distinct
&quot;_set()&quot; macros to modify the members of the
<small>IO</small> object.</p>


<p style="margin-left:11%; margin-top: 1em"><b>Double-Typed
SVs</b> <br>
Scalar variables normally contain only one type of value, an
integer, double, pointer, or reference. Perl will
automatically convert the actual scalar data from the stored
type into the requested type.</p>

<p style="margin-left:11%; margin-top: 1em">Some scalar
variables contain more than one type of scalar data. For
example, the variable $! contains either the numeric value
of &quot;errno&quot; or its string equivalent from either
&quot;strerror&quot; or &quot;sys_errlist[]&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">To force
multiple data values into an <small>SV,</small> you must do
two things: use the &quot;sv_set*v&quot; routines to add the
additional scalar type, then set a flag so that Perl will
believe it contains more than one type of data. The four
macros to set the flags are:</p>

<p style="margin-left:11%; margin-top: 1em">SvIOK_on <br>
SvNOK_on <br>
SvPOK_on <br>
SvROK_on</p>

<p style="margin-left:11%; margin-top: 1em">The particular
macro you must use depends on which &quot;sv_set*v&quot;
routine you called first. This is because every
&quot;sv_set*v&quot; routine turns on only the bit for the
particular type of data being set, and turns off all the
rest.</p>

<p style="margin-left:11%; margin-top: 1em">For example, to
create a new Perl variable called &quot;dberror&quot; that
contains both the numeric and descriptive string error
values, you could use the following code:</p>

<p style="margin-left:11%; margin-top: 1em">extern int
dberror; <br>
extern char *dberror_list; <br>
SV* sv = get_sv(&quot;dberror&quot;, GV_ADD); <br>
sv_setiv(sv, (IV) dberror); <br>
sv_setpv(sv, dberror_list[dberror]); <br>
SvIOK_on(sv);</p>

<p style="margin-left:11%; margin-top: 1em">If the order of
&quot;sv_setiv&quot; and &quot;sv_setpv&quot; had been
reversed, then the macro &quot;SvPOK_on&quot; would need to
be called instead of &quot;SvIOK_on&quot;.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Read-Only
Values</b> <br>
In Perl 5.16 and earlier, copy-on-write (see the next
section) shared a flag bit with read-only scalars. So the
only way to test whether &quot;sv_setsv&quot;, etc., will
raise a &quot;Modification of a read-only value&quot; error
in those versions is:</p>

<p style="margin-left:11%; margin-top: 1em">SvREADONLY(sv)
&amp;&amp; !SvIsCOW(sv)</p>

<p style="margin-left:11%; margin-top: 1em">Under Perl 5.18
and later, SvREADONLY only applies to read-only variables,
and, under 5.20, copy-on-write scalars can also be
read-only, so the above check is incorrect. You just
want:</p>


<p style="margin-left:11%; margin-top: 1em">SvREADONLY(sv)</p>

<p style="margin-left:11%; margin-top: 1em">If you need to
do this check often, define your own macro like this:</p>

<p style="margin-left:11%; margin-top: 1em">#if
PERL_VERSION &gt;= 18 <br>
# define SvTRULYREADONLY(sv) SvREADONLY(sv) <br>
#else <br>
# define SvTRULYREADONLY(sv) (SvREADONLY(sv) &amp;&amp;
!SvIsCOW(sv)) <br>
#endif</p>

<p style="margin-left:11%; margin-top: 1em"><b>Copy on
Write</b> <br>
Perl implements a copy-on-write ( <small>COW</small> )
mechanism for scalars, in which string copies are not
immediately made when requested, but are deferred until made
necessary by one or the other scalar changing. This is
mostly transparent, but one must take care not to modify
string buffers that are shared by multiple SVs.</p>

<p style="margin-left:11%; margin-top: 1em">You can test
whether an <small>SV</small> is using copy-on-write with
&quot;SvIsCOW(sv)&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">You can force
an <small>SV</small> to make its own copy of its string
buffer by calling &quot;sv_force_normal(sv)&quot; or
SvPV_force_nolen(sv).</p>

<p style="margin-left:11%; margin-top: 1em">If you want to
make the <small>SV</small> drop its string buffer, use
&quot;sv_force_normal_flags(sv, SV_COW_DROP_PV)&quot; or
simply &quot;sv_setsv(sv, NULL)&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">All of these
functions will croak on read-only scalars (see the previous
section for more on those).</p>

<p style="margin-left:11%; margin-top: 1em">To test that
your code is behaving correctly and not modifying
<small>COW</small> buffers, on systems that support
<b>mmap</b>(2) (i.e., Unix) you can configure perl with
&quot;&minus;Accflags=&minus;DPERL_DEBUG_READONLY_COW&quot;
and it will turn buffer violations into crashes. You will
find it to be marvellously slow, so you may want to skip
perl&rsquo;s own tests.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Magic
Variables</b> <br>
[This section still under construction. Ignore everything
here. Post no bills. Everything not permitted is
forbidden.]</p>

<p style="margin-left:11%; margin-top: 1em">Any
<small>SV</small> may be magical, that is, it has special
features that a normal <small>SV</small> does not have.
These features are stored in the <small>SV</small> structure
in a linked list of &quot;struct magic&quot;&rsquo;s,
typedef&rsquo;ed to &quot;MAGIC&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">struct magic {
<br>
MAGIC* mg_moremagic; <br>
MGVTBL* mg_virtual; <br>
U16 mg_private; <br>
char mg_type; <br>
U8 mg_flags; <br>
I32 mg_len; <br>
SV* mg_obj; <br>
char* mg_ptr; <br>
};</p>

<p style="margin-left:11%; margin-top: 1em">Note this is
current as of patchlevel 0, and could change at any
time.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Assigning
Magic</b> <br>
Perl adds magic to an <small>SV</small> using the sv_magic
function:</p>

<p style="margin-left:11%; margin-top: 1em">void
sv_magic(SV* sv, SV* obj, int how, const char* name, I32
namlen);</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;sv&quot; argument is a pointer to the
<small>SV</small> that is to acquire a new magical
feature.</p>

<p style="margin-left:11%; margin-top: 1em">If
&quot;sv&quot; is not already magical, Perl uses the
&quot;SvUPGRADE&quot; macro to convert &quot;sv&quot; to
type &quot;SVt_PVMG&quot;. Perl then continues by adding new
magic to the beginning of the linked list of magical
features. Any prior entry of the same type of magic is
deleted. Note that this can be overridden, and multiple
instances of the same type of magic can be associated with
an <small>SV.</small></p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;name&quot; and &quot;namlen&quot; arguments are used
to associate a string with the magic, typically the name of
a variable. &quot;namlen&quot; is stored in the
&quot;mg_len&quot; field and if &quot;name&quot; is non-null
then either a &quot;savepvn&quot; copy of &quot;name&quot;
or &quot;name&quot; itself is stored in the
&quot;mg_ptr&quot; field, depending on whether
&quot;namlen&quot; is greater than zero or equal to zero
respectively. As a special case, if &quot;(name &amp;&amp;
namlen == HEf_SVKEY)&quot; then &quot;name&quot; is assumed
to contain an &quot;SV*&quot; and is stored as-is with its
<small>REFCNT</small> incremented.</p>

<p style="margin-left:11%; margin-top: 1em">The sv_magic
function uses &quot;how&quot; to determine which, if any,
predefined &quot;Magic Virtual Table&quot; should be
assigned to the &quot;mg_virtual&quot; field. See the
&quot;Magic Virtual Tables&quot; section below. The
&quot;how&quot; argument is also stored in the
&quot;mg_type&quot; field. The value of &quot;how&quot;
should be chosen from the set of macros
&quot;PERL_MAGIC_foo&quot; found in <i>perl.h</i>. Note that
before these macros were added, Perl internals used to
directly use character literals, so you may occasionally
come across old code or documentation referring to
&rsquo;U&rsquo; magic rather than
&quot;PERL_MAGIC_uvar&quot; for example.</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;obj&quot; argument is stored in the &quot;mg_obj&quot;
field of the &quot;MAGIC&quot; structure. If it is not the
same as the &quot;sv&quot; argument, the reference count of
the &quot;obj&quot; object is incremented. If it is the
same, or if the &quot;how&quot; argument is
&quot;PERL_MAGIC_arylen&quot;,
&quot;PERL_MAGIC_regdatum&quot;,
&quot;PERL_MAGIC_regdata&quot;, or if it is a
<small>NULL</small> pointer, then &quot;obj&quot; is merely
stored, without the reference count being incremented.</p>

<p style="margin-left:11%; margin-top: 1em">See also
&quot;sv_magicext&quot; in perlapi for a more flexible way
to add magic to an <small>SV.</small></p>

<p style="margin-left:11%; margin-top: 1em">There is also a
function to add magic to an &quot;HV&quot;:</p>

<p style="margin-left:11%; margin-top: 1em">void
hv_magic(HV *hv, GV *gv, int how);</p>

<p style="margin-left:11%; margin-top: 1em">This simply
calls &quot;sv_magic&quot; and coerces the &quot;gv&quot;
argument into an &quot;SV&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">To remove the
magic from an <small>SV,</small> call the function
sv_unmagic:</p>

<p style="margin-left:11%; margin-top: 1em">int
sv_unmagic(SV *sv, int type);</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;type&quot; argument should be equal to the
&quot;how&quot; value when the &quot;SV&quot; was initially
made magical.</p>

<p style="margin-left:11%; margin-top: 1em">However, note
that &quot;sv_unmagic&quot; removes all magic of a certain
&quot;type&quot; from the &quot;SV&quot;. If you want to
remove only certain magic of a &quot;type&quot; based on the
magic virtual table, use &quot;sv_unmagicext&quot;
instead:</p>

<p style="margin-left:11%; margin-top: 1em">int
sv_unmagicext(SV *sv, int type, MGVTBL *vtbl);</p>

<p style="margin-left:11%; margin-top: 1em"><b>Magic
Virtual Tables</b> <br>
The &quot;mg_virtual&quot; field in the &quot;MAGIC&quot;
structure is a pointer to an &quot;MGVTBL&quot;, which is a
structure of function pointers and stands for &quot;Magic
Virtual Table&quot; to handle the various operations that
might be applied to that variable.</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;MGVTBL&quot; has five (or sometimes eight) pointers to
the following routine types:</p>

<p style="margin-left:11%; margin-top: 1em">int (*svt_get)
(pTHX_ SV* sv, MAGIC* mg); <br>
int (*svt_set) (pTHX_ SV* sv, MAGIC* mg); <br>
U32 (*svt_len) (pTHX_ SV* sv, MAGIC* mg); <br>
int (*svt_clear)(pTHX_ SV* sv, MAGIC* mg); <br>
int (*svt_free) (pTHX_ SV* sv, MAGIC* mg); <br>
int (*svt_copy) (pTHX_ SV *sv, MAGIC* mg, SV *nsv, <br>
const char *name, I32 namlen); <br>
int (*svt_dup) (pTHX_ MAGIC *mg, CLONE_PARAMS *param); <br>
int (*svt_local)(pTHX_ SV *nsv, MAGIC *mg);</p>

<p style="margin-left:11%; margin-top: 1em">This
<small>MGVTBL</small> structure is set at compile-time in
<i>perl.h</i> and there are currently 32 types. These
different structures contain pointers to various routines
that perform additional actions depending on which function
is being called.</p>

<p style="margin-left:11%; margin-top: 1em">Function
pointer Action taken <br>

&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;
&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;
<br>
svt_get Do something before the value of the SV is <br>
retrieved. <br>
svt_set Do something after the SV is assigned a value. <br>
svt_len Report on the SV's length. <br>
svt_clear Clear something the SV represents. <br>
svt_free Free any extra storage associated with the SV. <br>
svt_copy copy tied variable magic to a tied element <br>
svt_dup duplicate a magic structure during thread cloning
<br>
svt_local copy magic to local value during 'local'</p>

<p style="margin-left:11%; margin-top: 1em">For instance,
the <small>MGVTBL</small> structure called
&quot;vtbl_sv&quot; (which corresponds to an
&quot;mg_type&quot; of &quot;PERL_MAGIC_sv&quot;)
contains:</p>

<p style="margin-left:11%; margin-top: 1em">{ magic_get,
magic_set, magic_len, 0, 0 }</p>

<p style="margin-left:11%; margin-top: 1em">Thus, when an
<small>SV</small> is determined to be magical and of type
&quot;PERL_MAGIC_sv&quot;, if a get operation is being
performed, the routine &quot;magic_get&quot; is called. All
the various routines for the various magical types begin
with &quot;magic_&quot;. <small>NOTE:</small> the magic
routines are not considered part of the Perl
<small>API,</small> and may not be exported by the Perl
library.</p>

<p style="margin-left:11%; margin-top: 1em">The last three
slots are a recent addition, and for source code
compatibility they are only checked for if one of the three
flags &quot;MGf_COPY&quot;, &quot;MGf_DUP&quot;, or
&quot;MGf_LOCAL&quot; is set in mg_flags. This means that
most code can continue declaring a vtable as a
5&minus;element value. These three are currently used
exclusively by the threading code, and are highly subject to
change.</p>

<p style="margin-left:11%; margin-top: 1em">The current
kinds of Magic Virtual Tables are:</p>

<p style="margin-left:11%; margin-top: 1em">mg_type <br>
(old&minus;style char and macro) MGVTBL Type of magic <br>

&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;
&minus;&minus;&minus;&minus;&minus;&minus;
&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;&minus;
<br>
\0 PERL_MAGIC_sv vtbl_sv Special scalar variable <br>
# PERL_MAGIC_arylen vtbl_arylen Array length ($#ary) <br>
% PERL_MAGIC_rhash (none) Extra data for restricted <br>
hashes <br>
* PERL_MAGIC_debugvar vtbl_debugvar $DB::single, signal,
trace <br>
vars <br>
. PERL_MAGIC_pos vtbl_pos pos() lvalue <br>
: PERL_MAGIC_symtab (none) Extra data for symbol <br>
tables <br>
&lt; PERL_MAGIC_backref vtbl_backref For weak ref data <br>
@ PERL_MAGIC_arylen_p (none) To move arylen out of XPVAV
<br>
B PERL_MAGIC_bm vtbl_regexp Boyer&minus;Moore <br>
(fast string search) <br>
c PERL_MAGIC_overload_table vtbl_ovrld Holds overload table
<br>
(AMT) on stash <br>
D PERL_MAGIC_regdata vtbl_regdata Regex match position data
<br>
(@+ and @&minus; vars) <br>
d PERL_MAGIC_regdatum vtbl_regdatum Regex match position
data <br>
element <br>
E PERL_MAGIC_env vtbl_env %ENV hash <br>
e PERL_MAGIC_envelem vtbl_envelem %ENV hash element <br>
f PERL_MAGIC_fm vtbl_regexp Formline <br>
('compiled' format) <br>
g PERL_MAGIC_regex_global vtbl_mglob m//g target <br>
H PERL_MAGIC_hints vtbl_hints %^H hash <br>
h PERL_MAGIC_hintselem vtbl_hintselem %^H hash element <br>
I PERL_MAGIC_isa vtbl_isa @ISA array <br>
i PERL_MAGIC_isaelem vtbl_isaelem @ISA array element <br>
k PERL_MAGIC_nkeys vtbl_nkeys scalar(keys()) lvalue <br>
L PERL_MAGIC_dbfile (none) Debugger %_&lt;filename <br>
l PERL_MAGIC_dbline vtbl_dbline Debugger %_&lt;filename <br>
element <br>
N PERL_MAGIC_shared (none) Shared between threads <br>
n PERL_MAGIC_shared_scalar (none) Shared between threads
<br>
o PERL_MAGIC_collxfrm vtbl_collxfrm Locale transformation
<br>
P PERL_MAGIC_tied vtbl_pack Tied array or hash <br>
p PERL_MAGIC_tiedelem vtbl_packelem Tied array or hash
element <br>
q PERL_MAGIC_tiedscalar vtbl_packelem Tied scalar or handle
<br>
r PERL_MAGIC_qr vtbl_regexp Precompiled qr// regex <br>
S PERL_MAGIC_sig vtbl_sig %SIG hash <br>
s PERL_MAGIC_sigelem vtbl_sigelem %SIG hash element <br>
t PERL_MAGIC_taint vtbl_taint Taintedness <br>
U PERL_MAGIC_uvar vtbl_uvar Available for use by <br>
extensions <br>
u PERL_MAGIC_uvar_elem (none) Reserved for use by <br>
extensions <br>
V PERL_MAGIC_vstring (none) SV was vstring literal <br>
v PERL_MAGIC_vec vtbl_vec vec() lvalue <br>
w PERL_MAGIC_utf8 vtbl_utf8 Cached UTF&minus;8 information
<br>
x PERL_MAGIC_substr vtbl_substr substr() lvalue <br>
Y PERL_MAGIC_nonelem vtbl_nonelem Array element that does
not <br>
exist <br>
y PERL_MAGIC_defelem vtbl_defelem Shadow &quot;foreach&quot;
iterator <br>
variable / smart parameter <br>
vivification <br>
\ PERL_MAGIC_lvref vtbl_lvref Lvalue reference <br>
constructor <br>
] PERL_MAGIC_checkcall vtbl_checkcall Inlining/mutation of
call <br>
to this CV <br>
~ PERL_MAGIC_ext (none) Available for use by <br>
extensions</p>

<p style="margin-left:11%; margin-top: 1em">When an
uppercase and lowercase letter both exist in the table, then
the uppercase letter is typically used to represent some
kind of composite type (a list or a hash), and the lowercase
letter is used to represent an element of that composite
type. Some internals code makes use of this case
relationship. However, &rsquo;v&rsquo; and &rsquo;V&rsquo;
(vec and v&minus;string) are in no way related.</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;PERL_MAGIC_ext&quot; and &quot;PERL_MAGIC_uvar&quot;
magic types are defined specifically for use by extensions
and will not be used by perl itself. Extensions can use
&quot;PERL_MAGIC_ext&quot; magic to &rsquo;attach&rsquo;
private information to variables (typically objects). This
is especially useful because there is no way for normal perl
code to corrupt this private information (unlike using extra
elements of a hash object).</p>

<p style="margin-left:11%; margin-top: 1em">Similarly,
&quot;PERL_MAGIC_uvar&quot; magic can be used much like
<b>tie()</b> to call a C function any time a scalar&rsquo;s
value is used or changed. The &quot;MAGIC&quot;&rsquo;s
&quot;mg_ptr&quot; field points to a &quot;ufuncs&quot;
structure:</p>

<p style="margin-left:11%; margin-top: 1em">struct ufuncs {
<br>
I32 (*uf_val)(pTHX_ IV, SV*); <br>
I32 (*uf_set)(pTHX_ IV, SV*); <br>
IV uf_index; <br>
};</p>

<p style="margin-left:11%; margin-top: 1em">When the
<small>SV</small> is read from or written to, the
&quot;uf_val&quot; or &quot;uf_set&quot; function will be
called with &quot;uf_index&quot; as the first arg and a
pointer to the <small>SV</small> as the second. A simple
example of how to add &quot;PERL_MAGIC_uvar&quot; magic is
shown below. Note that the ufuncs structure is copied by
sv_magic, so you can safely allocate it on the stack.</p>

<p style="margin-left:11%; margin-top: 1em">void <br>
Umagic(sv) <br>
SV *sv; <br>
PREINIT: <br>
struct ufuncs uf; <br>
CODE: <br>
uf.uf_val = &amp;my_get_fn; <br>
uf.uf_set = &amp;my_set_fn; <br>
uf.uf_index = 0; <br>
sv_magic(sv, 0, PERL_MAGIC_uvar, (char*)&amp;uf,
sizeof(uf));</p>

<p style="margin-left:11%; margin-top: 1em">Attaching
&quot;PERL_MAGIC_uvar&quot; to arrays is permissible but has
no effect.</p>

<p style="margin-left:11%; margin-top: 1em">For hashes
there is a specialized hook that gives control over hash
keys (but not values). This hook calls
&quot;PERL_MAGIC_uvar&quot; &rsquo;get&rsquo; magic if the
&quot;set&quot; function in the &quot;ufuncs&quot; structure
is <small>NULL.</small> The hook is activated whenever the
hash is accessed with a key specified as an &quot;SV&quot;
through the functions &quot;hv_store_ent&quot;,
&quot;hv_fetch_ent&quot;, &quot;hv_delete_ent&quot;, and
&quot;hv_exists_ent&quot;. Accessing the key as a string
through the functions without the &quot;..._ent&quot; suffix
circumvents the hook. See &quot; <small>GUTS&quot;</small>
in Hash::Util::FieldHash for a detailed description.</p>

<p style="margin-left:11%; margin-top: 1em">Note that
because multiple extensions may be using
&quot;PERL_MAGIC_ext&quot; or &quot;PERL_MAGIC_uvar&quot;
magic, it is important for extensions to take extra care to
avoid conflict. Typically only using the magic on objects
blessed into the same class as the extension is sufficient.
For &quot;PERL_MAGIC_ext&quot; magic, it is usually a good
idea to define an &quot;MGVTBL&quot;, even if all its fields
will be 0, so that individual &quot;MAGIC&quot; pointers can
be identified as a particular kind of magic using their
magic virtual table. &quot;mg_findext&quot; provides an easy
way to do that:</p>

<p style="margin-left:11%; margin-top: 1em">STATIC MGVTBL
my_vtbl = { 0, 0, 0, 0, 0, 0, 0, 0 }; <br>
MAGIC *mg; <br>
if ((mg = mg_findext(sv, PERL_MAGIC_ext, &amp;my_vtbl))) {
<br>
/* this is really ours, not another module's PERL_MAGIC_ext
*/ <br>
my_priv_data_t *priv = (my_priv_data_t
*)mg&minus;&gt;mg_ptr; <br>
... <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">Also note that
the &quot;sv_set*()&quot; and &quot;sv_cat*()&quot;
functions described earlier do <b>not</b> invoke
&rsquo;set&rsquo; magic on their targets. This must be done
by the user either by calling the &quot;SvSETMAGIC()&quot;
macro after calling these functions, or by using one of the
&quot;sv_set*_mg()&quot; or &quot;sv_cat*_mg()&quot;
functions. Similarly, generic C code must call the
&quot;SvGETMAGIC()&quot; macro to invoke any
&rsquo;get&rsquo; magic if they use an <small>SV</small>
obtained from external sources in functions that don&rsquo;t
handle magic. See perlapi for a description of these
functions. For example, calls to the &quot;sv_cat*()&quot;
functions typically need to be followed by
&quot;SvSETMAGIC()&quot;, but they don&rsquo;t need a prior
&quot;SvGETMAGIC()&quot; since their implementation handles
&rsquo;get&rsquo; magic.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Finding
Magic</b> <br>
MAGIC *mg_find(SV *sv, int type); /* Finds the magic pointer
of that <br>
* type */</p>

<p style="margin-left:11%; margin-top: 1em">This routine
returns a pointer to a &quot;MAGIC&quot; structure stored in
the <small>SV.</small> If the <small>SV</small> does not
have that magical feature, &quot;NULL&quot; is returned. If
the <small>SV</small> has multiple instances of that magical
feature, the first one will be returned.
&quot;mg_findext&quot; can be used to find a
&quot;MAGIC&quot; structure of an <small>SV</small> based on
both its magic type and its magic virtual table:</p>

<p style="margin-left:11%; margin-top: 1em">MAGIC
*mg_findext(SV *sv, int type, MGVTBL *vtbl);</p>

<p style="margin-left:11%; margin-top: 1em">Also, if the
<small>SV</small> passed to &quot;mg_find&quot; or
&quot;mg_findext&quot; is not of type SVt_PVMG, Perl may
core dump.</p>

<p style="margin-left:11%; margin-top: 1em">int mg_copy(SV*
sv, SV* nsv, const char* key, STRLEN klen);</p>

<p style="margin-left:11%; margin-top: 1em">This routine
checks to see what types of magic &quot;sv&quot; has. If the
mg_type field is an uppercase letter, then the mg_obj is
copied to &quot;nsv&quot;, but the mg_type field is changed
to be the lowercase letter.</p>


<p style="margin-left:11%; margin-top: 1em"><b>Understanding
the Magic of Tied Hashes and Arrays</b> <br>
Tied hashes and arrays are magical beasts of the
&quot;PERL_MAGIC_tied&quot; magic type.</p>


<p style="margin-left:11%; margin-top: 1em"><small>WARNING:</small>
As of the 5.004 release, proper usage of the array and hash
access functions requires understanding a few caveats. Some
of these caveats are actually considered bugs in the
<small>API,</small> to be fixed in later releases, and are
bracketed with [ <small>MAYCHANGE</small> ] below. If you
find yourself actually applying such information in this
section, be aware that the behavior may change in the
future, umm, without warning.</p>

<p style="margin-left:11%; margin-top: 1em">The perl tie
function associates a variable with an object that
implements the various <small>GET, SET,</small> etc methods.
To perform the equivalent of the perl tie function from an
<small>XSUB,</small> you must mimic this behaviour. The code
below carries out the necessary steps -- firstly it creates
a new hash, and then creates a second hash which it blesses
into the class which will implement the tie methods. Lastly
it ties the two hashes together, and returns a reference to
the new tied hash. Note that the code below does
<small>NOT</small> call the <small>TIEHASH</small> method in
the MyTie class &minus; see &quot;Calling Perl Routines from
within C Programs&quot; for details on how to do this.</p>

<p style="margin-left:11%; margin-top: 1em">SV* <br>
mytie() <br>
PREINIT: <br>
HV *hash; <br>
HV *stash; <br>
SV *tie; <br>
CODE: <br>
hash = newHV(); <br>
tie = newRV_noinc((SV*)newHV()); <br>
stash = gv_stashpv(&quot;MyTie&quot;, GV_ADD); <br>
sv_bless(tie, stash); <br>
hv_magic(hash, (GV*)tie, PERL_MAGIC_tied); <br>
RETVAL = newRV_noinc(hash); <br>
OUTPUT: <br>
RETVAL</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;av_store&quot; function, when given a tied array
argument, merely copies the magic of the array onto the
value to be &quot;stored&quot;, using &quot;mg_copy&quot;.
It may also return <small>NULL,</small> indicating that the
value did not actually need to be stored in the array. [
<small>MAYCHANGE</small> ] After a call to
&quot;av_store&quot; on a tied array, the caller will
usually need to call &quot;mg_set(val)&quot; to actually
invoke the perl level &quot; <small>STORE&quot;</small>
method on the <small>TIEARRAY</small> object. If
&quot;av_store&quot; did return <small>NULL,</small> a call
to &quot;SvREFCNT_dec(val)&quot; will also be usually
necessary to avoid a memory leak. [/MAYCHANGE]</p>

<p style="margin-left:11%; margin-top: 1em">The previous
paragraph is applicable verbatim to tied hash access using
the &quot;hv_store&quot; and &quot;hv_store_ent&quot;
functions as well.</p>


<p style="margin-left:11%; margin-top: 1em">&quot;av_fetch&quot;
and the corresponding hash functions &quot;hv_fetch&quot;
and &quot;hv_fetch_ent&quot; actually return an undefined
mortal value whose magic has been initialized using
&quot;mg_copy&quot;. Note the value so returned does not
need to be deallocated, as it is already mortal. [
<small>MAYCHANGE</small> ] But you will need to call
&quot;mg_get()&quot; on the returned value in order to
actually invoke the perl level &quot;
<small>FETCH&quot;</small> method on the underlying
<small>TIE</small> object. Similarly, you may also call
&quot;mg_set()&quot; on the return value after possibly
assigning a suitable value to it using &quot;sv_setsv&quot;,
which will invoke the &quot; <small>STORE&quot;</small>
method on the <small>TIE</small> object. [/MAYCHANGE]</p>

<p style="margin-left:11%; margin-top: 1em">[
<small>MAYCHANGE</small> ] In other words, the array or hash
fetch/store functions don&rsquo;t really fetch and store
actual values in the case of tied arrays and hashes. They
merely call &quot;mg_copy&quot; to attach magic to the
values that were meant to be &quot;stored&quot; or
&quot;fetched&quot;. Later calls to &quot;mg_get&quot; and
&quot;mg_set&quot; actually do the job of invoking the
<small>TIE</small> methods on the underlying objects. Thus
the magic mechanism currently implements a kind of lazy
access to arrays and hashes.</p>

<p style="margin-left:11%; margin-top: 1em">Currently (as
of perl version 5.004), use of the hash and array access
functions requires the user to be aware of whether they are
operating on &quot;normal&quot; hashes and arrays, or on
their tied variants. The <small>API</small> may be changed
to provide more transparent access to both tied and normal
data types in future versions. [/MAYCHANGE]</p>

<p style="margin-left:11%; margin-top: 1em">You would do
well to understand that the <small>TIEARRAY</small> and
<small>TIEHASH</small> interfaces are mere sugar to invoke
some perl method calls while using the uniform hash and
array syntax. The use of this sugar imposes some overhead
(typically about two to four extra opcodes per
<small>FETCH/STORE</small> operation, in addition to the
creation of all the mortal variables required to invoke the
methods). This overhead will be comparatively small if the
<small>TIE</small> methods are themselves substantial, but
if they are only a few statements long, the overhead will
not be insignificant.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Localizing
changes</b> <br>
Perl has a very handy construction</p>

<p style="margin-left:11%; margin-top: 1em">{ <br>
local $var = 2; <br>
... <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">This
construction is <i>approximately</i> equivalent to</p>

<p style="margin-left:11%; margin-top: 1em">{ <br>
my $oldvar = $var; <br>
$var = 2; <br>
... <br>
$var = $oldvar; <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">The biggest
difference is that the first construction would reinstate
the initial value of $var, irrespective of how control exits
the block: &quot;goto&quot;, &quot;return&quot;,
&quot;die&quot;/&quot;eval&quot;, etc. It is a little bit
more efficient as well.</p>

<p style="margin-left:11%; margin-top: 1em">There is a way
to achieve a similar task from C via Perl
<small>API:</small> create a <i>pseudo-block</i>, and
arrange for some changes to be automatically undone at the
end of it, either explicit, or via a non-local exit (via
<b>die()</b>). A <i>block</i>&minus;like construct is
created by a pair of &quot;ENTER&quot;/&quot;LEAVE&quot;
macros (see &quot;Returning a Scalar&quot; in perlcall).
Such a construct may be created specially for some important
localized task, or an existing one (like boundaries of
enclosing Perl subroutine/block, or an existing pair for
freeing TMPs) may be used. (In the second case the overhead
of additional localization must be almost negligible.) Note
that any <small>XSUB</small> is automatically enclosed in an
&quot;ENTER&quot;/&quot;LEAVE&quot; pair.</p>

<p style="margin-left:11%; margin-top: 1em">Inside such a
<i>pseudo-block</i> the following service is available: <br>
&quot;SAVEINT(int i)&quot; <br>
&quot;SAVEIV(IV i)&quot; <br>
&quot;SAVEI32(I32 i)&quot; <br>
&quot;SAVELONG(long i)&quot; <br>
&quot;SAVEI8(I8 i)&quot; <br>
&quot;SAVEI16(I16 i)&quot; <br>
&quot;SAVEBOOL(int i)&quot; <br>
&quot;SAVESTRLEN(STRLEN i)&quot;</p>

<p style="margin-left:17%;">These macros arrange things to
restore the value of integer variable &quot;i&quot; at the
end of the enclosing <i>pseudo-block</i>.</p>

<p style="margin-left:11%;">SAVESPTR(s) <br>
SAVEPPTR(p)</p>

<p style="margin-left:17%;">These macros arrange things to
restore the value of pointers &quot;s&quot; and
&quot;p&quot;. &quot;s&quot; must be a pointer of a type
which survives conversion to &quot;SV*&quot; and back,
&quot;p&quot; should be able to survive conversion to
&quot;char*&quot; and back.</p>

<p style="margin-left:11%;">&quot;SAVEFREESV(SV
*sv)&quot;</p>

<p style="margin-left:17%;">The refcount of &quot;sv&quot;
will be decremented at the end of <i>pseudo-block</i>. This
is similar to &quot;sv_2mortal&quot; in that it is also a
mechanism for doing a delayed &quot;SvREFCNT_dec&quot;.
However, while &quot;sv_2mortal&quot; extends the lifetime
of &quot;sv&quot; until the beginning of the next statement,
&quot;SAVEFREESV&quot; extends it until the end of the
enclosing scope. These lifetimes can be wildly
different.</p>

<p style="margin-left:17%; margin-top: 1em">Also compare
&quot;SAVEMORTALIZESV&quot;.</p>

<p style="margin-left:11%;">&quot;SAVEMORTALIZESV(SV
*sv)&quot;</p>

<p style="margin-left:17%;">Just like
&quot;SAVEFREESV&quot;, but mortalizes &quot;sv&quot; at the
end of the current scope instead of decrementing its
reference count. This usually has the effect of keeping
&quot;sv&quot; alive until the statement that called the
currently live scope has finished executing.</p>

<p style="margin-left:11%;">&quot;SAVEFREEOP(OP
*op)&quot;</p>

<p style="margin-left:17%;">The &quot;OP *&quot; is
<b>op_free()</b>ed at the end of <i>pseudo-block</i>.</p>

<p style="margin-left:11%;">SAVEFREEPV(p)</p>

<p style="margin-left:17%;">The chunk of memory which is
pointed to by &quot;p&quot; is <b>Safefree()</b>ed at the
end of <i>pseudo-block</i>.</p>

<p style="margin-left:11%;">&quot;SAVECLEARSV(SV
*sv)&quot;</p>

<p style="margin-left:17%;">Clears a slot in the current
scratchpad which corresponds to &quot;sv&quot; at the end of
<i>pseudo-block</i>.</p>

<p style="margin-left:11%;">&quot;SAVEDELETE(HV *hv, char
*key, I32 length)&quot;</p>

<p style="margin-left:17%;">The key &quot;key&quot; of
&quot;hv&quot; is deleted at the end of <i>pseudo-block</i>.
The string pointed to by &quot;key&quot; is
<b>Safefree()</b>ed. If one has a <i>key</i> in short-lived
storage, the corresponding string may be reallocated like
this:</p>


<p style="margin-left:17%; margin-top: 1em">SAVEDELETE(PL_defstash,
savepv(tmpbuf), strlen(tmpbuf));</p>


<p style="margin-left:11%;">&quot;SAVEDESTRUCTOR(DESTRUCTORFUNC_NOCONTEXT_t
f, void *p)&quot;</p>

<p style="margin-left:17%;">At the end of
<i>pseudo-block</i> the function &quot;f&quot; is called
with the only argument &quot;p&quot;.</p>


<p style="margin-left:11%;">&quot;SAVEDESTRUCTOR_X(DESTRUCTORFUNC_t
f, void *p)&quot;</p>

<p style="margin-left:17%;">At the end of
<i>pseudo-block</i> the function &quot;f&quot; is called
with the implicit context argument (if any), and
&quot;p&quot;.</p>


<p style="margin-left:11%;">&quot;SAVESTACK_POS()&quot;</p>

<p style="margin-left:17%;">The current offset on the Perl
internal stack (cf. &quot;SP&quot;) is restored at the end
of <i>pseudo-block</i>.</p>

<p style="margin-left:11%; margin-top: 1em">The following
<small>API</small> list contains functions, thus one needs
to provide pointers to the modifiable data explicitly
(either C pointers, or Perlish &quot;GV *&quot;s). Where the
above macros take &quot;int&quot;, a similar function takes
&quot;int *&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Other macros
above have functions implementing them, but its probably
best to just use the macro, and not those or the ones below.
<br>
&quot;SV* save_scalar(GV *gv)&quot;</p>

<p style="margin-left:17%;">Equivalent to Perl code
&quot;local $gv&quot;.</p>

<p style="margin-left:11%;">&quot;AV* save_ary(GV
*gv)&quot; <br>
&quot;HV* save_hash(GV *gv)&quot;</p>

<p style="margin-left:17%;">Similar to
&quot;save_scalar&quot;, but localize @gv and %gv.</p>

<p style="margin-left:11%;">&quot;void save_item(SV
*item)&quot;</p>

<p style="margin-left:17%;">Duplicates the current value of
&quot;SV&quot;. On the exit from the current
&quot;ENTER&quot;/&quot;LEAVE&quot; <i>pseudo-block</i> the
value of &quot;SV&quot; will be restored using the stored
value. It doesn&rsquo;t handle magic. Use
&quot;save_scalar&quot; if magic is affected.</p>

<p style="margin-left:11%;">&quot;void save_list(SV **sarg,
I32 maxsarg)&quot;</p>

<p style="margin-left:17%;">A variant of
&quot;save_item&quot; which takes multiple arguments via an
array &quot;sarg&quot; of &quot;SV*&quot; of length
&quot;maxsarg&quot;.</p>

<p style="margin-left:11%;">&quot;SV* save_svref(SV
**sptr)&quot;</p>

<p style="margin-left:17%;">Similar to
&quot;save_scalar&quot;, but will reinstate an &quot;SV
*&quot;.</p>

<p style="margin-left:11%;">&quot;void save_aptr(AV
**aptr)&quot; <br>
&quot;void save_hptr(HV **hptr)&quot;</p>

<p style="margin-left:17%;">Similar to
&quot;save_svref&quot;, but localize &quot;AV *&quot; and
&quot;HV *&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;Alias&quot; module implements localization of the
basic types within the <i>caller&rsquo;s scope</i>. People
who are interested in how to localize things in the
containing scope should take a look there too.</p>

<h2>Subroutines
<a name="Subroutines"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>XSUBs and
the Argument Stack</b> <br>
The <small>XSUB</small> mechanism is a simple way for Perl
programs to access C subroutines. An <small>XSUB</small>
routine will have a stack that contains the arguments from
the Perl program, and a way to map from the Perl data
structures to a C equivalent.</p>

<p style="margin-left:11%; margin-top: 1em">The stack
arguments are accessible through the ST(n) macro, which
returns the &quot;n&quot;&rsquo;th stack argument. Argument
0 is the first argument passed in the Perl subroutine call.
These arguments are &quot;SV*&quot;, and can be used
anywhere an &quot;SV*&quot; is used.</p>

<p style="margin-left:11%; margin-top: 1em">Most of the
time, output from the C routine can be handled through use
of the <small>RETVAL</small> and <small>OUTPUT</small>
directives. However, there are some cases where the argument
stack is not already long enough to handle all the return
values. An example is the <small>POSIX</small>
<b>tzname()</b> call, which takes no arguments, but returns
two, the local time zone&rsquo;s standard and summer time
abbreviations.</p>

<p style="margin-left:11%; margin-top: 1em">To handle this
situation, the <small>PPCODE</small> directive is used and
the stack is extended using the macro:</p>

<p style="margin-left:11%; margin-top: 1em">EXTEND(SP,
num);</p>

<p style="margin-left:11%; margin-top: 1em">where
&quot;SP&quot; is the macro that represents the local copy
of the stack pointer, and &quot;num&quot; is the number of
elements the stack should be extended by.</p>

<p style="margin-left:11%; margin-top: 1em">Now that there
is room on the stack, values can be pushed on it using
&quot;PUSHs&quot; macro. The pushed values will often need
to be &quot;mortal&quot; (See &quot;Reference Counts and
Mortality&quot;):</p>


<p style="margin-left:11%; margin-top: 1em">PUSHs(sv_2mortal(newSViv(an_integer)))
<br>
PUSHs(sv_2mortal(newSVuv(an_unsigned_integer))) <br>
PUSHs(sv_2mortal(newSVnv(a_double))) <br>
PUSHs(sv_2mortal(newSVpv(&quot;Some String&quot;,0))) <br>
/* Although the last example is better written as the more
<br>
* efficient: */ <br>
PUSHs(newSVpvs_flags(&quot;Some String&quot;, SVs_TEMP))</p>

<p style="margin-left:11%; margin-top: 1em">And now the
Perl program calling &quot;tzname&quot;, the two values will
be assigned as in:</p>


<p style="margin-left:11%; margin-top: 1em">($standard_abbrev,
$summer_abbrev) = POSIX::tzname;</p>

<p style="margin-left:11%; margin-top: 1em">An alternate
(and possibly simpler) method to pushing values on the stack
is to use the macro:</p>


<p style="margin-left:11%; margin-top: 1em">XPUSHs(SV*)</p>

<p style="margin-left:11%; margin-top: 1em">This macro
automatically adjusts the stack for you, if needed. Thus,
you do not need to call &quot;EXTEND&quot; to extend the
stack.</p>

<p style="margin-left:11%; margin-top: 1em">Despite their
suggestions in earlier versions of this document the macros
&quot;(X)PUSH[iunp]&quot; are <i>not</i> suited to XSUBs
which return multiple results. For that, either stick to the
&quot;(X)PUSHs&quot; macros shown above, or use the new
&quot;m(X)PUSH[iunp]&quot; macros instead; see &quot;Putting
a C value on Perl stack&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">For more
information, consult perlxs and perlxstut.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Autoloading
with XSUBs</b> <br>
If an <small>AUTOLOAD</small> routine is an
<small>XSUB,</small> as with Perl subroutines, Perl puts the
fully-qualified name of the autoloaded subroutine in the
$AUTOLOAD variable of the <small>XSUB</small> &rsquo;s
package.</p>

<p style="margin-left:11%; margin-top: 1em">But it also
puts the same information in certain fields of the
<small>XSUB</small> itself:</p>

<p style="margin-left:11%; margin-top: 1em">HV *stash =
CvSTASH(cv); <br>
const char *subname = SvPVX(cv); <br>
STRLEN name_length = SvCUR(cv); /* in bytes */ <br>
U32 is_utf8 = SvUTF8(cv);</p>


<p style="margin-left:11%; margin-top: 1em">&quot;SvPVX(cv)&quot;
contains just the sub name itself, not including the
package. For an <small>AUTOLOAD</small> routine in
<small>UNIVERSAL</small> or one of its superclasses,
&quot;CvSTASH(cv)&quot; returns <small>NULL</small> during a
method call on a nonexistent package.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Note</b>:
Setting $AUTOLOAD stopped working in 5.6.1, which did not
support <small>XS AUTOLOAD</small> subs at all. Perl 5.8.0
introduced the use of fields in the <small>XSUB</small>
itself. Perl 5.16.0 restored the setting of $AUTOLOAD. If
you need to support 5.8&minus;5.14, use the
<small>XSUB</small> &rsquo;s fields.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Calling Perl
Routines from within C Programs</b> <br>
There are four routines that can be used to call a Perl
subroutine from within a C program. These four are:</p>

<p style="margin-left:11%; margin-top: 1em">I32
call_sv(SV*, I32); <br>
I32 call_pv(const char*, I32); <br>
I32 call_method(const char*, I32); <br>
I32 call_argv(const char*, I32, char**);</p>

<p style="margin-left:11%; margin-top: 1em">The routine
most often used is &quot;call_sv&quot;. The &quot;SV*&quot;
argument contains either the name of the Perl subroutine to
be called, or a reference to the subroutine. The second
argument consists of flags that control the context in which
the subroutine is called, whether or not the subroutine is
being passed arguments, how errors should be trapped, and
how to treat return values.</p>

<p style="margin-left:11%; margin-top: 1em">All four
routines return the number of arguments that the subroutine
returned on the Perl stack.</p>

<p style="margin-left:11%; margin-top: 1em">These routines
used to be called &quot;perl_call_sv&quot;, etc., before
Perl v5.6.0, but those names are now deprecated; macros of
the same name are provided for compatibility.</p>

<p style="margin-left:11%; margin-top: 1em">When using any
of these routines (except &quot;call_argv&quot;), the
programmer must manipulate the Perl stack. These include the
following macros and functions:</p>

<p style="margin-left:11%; margin-top: 1em">dSP <br>
SP <br>
PUSHMARK() <br>
PUTBACK <br>
SPAGAIN <br>
ENTER <br>
SAVETMPS <br>
FREETMPS <br>
LEAVE <br>
XPUSH*() <br>
POP*()</p>

<p style="margin-left:11%; margin-top: 1em">For a detailed
description of calling conventions from C to Perl, consult
perlcall.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Putting a C
value on Perl stack</b> <br>
A lot of opcodes (this is an elementary operation in the
internal perl stack machine) put an SV* on the stack.
However, as an optimization the corresponding
<small>SV</small> is (usually) not recreated each time. The
opcodes reuse specially assigned SVs (<i>target</i>s) which
are (as a corollary) not constantly freed/created.</p>

<p style="margin-left:11%; margin-top: 1em">Each of the
targets is created only once (but see &quot;Scratchpads and
recursion&quot; below), and when an opcode needs to put an
integer, a double, or a string on stack, it just sets the
corresponding parts of its <i>target</i> and puts the
<i>target</i> on stack.</p>

<p style="margin-left:11%; margin-top: 1em">The macro to
put this target on stack is &quot;PUSHTARG&quot;, and it is
directly used in some opcodes, as well as indirectly in
zillions of others, which use it via
&quot;(X)PUSH[iunp]&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Because the
target is reused, you must be careful when pushing multiple
values on the stack. The following code will not do what you
think:</p>

<p style="margin-left:11%; margin-top: 1em">XPUSHi(10);
<br>
XPUSHi(20);</p>

<p style="margin-left:11%; margin-top: 1em">This translates
as &quot;set &quot;TARG&quot; to 10, push a pointer to
&quot;TARG&quot; onto the stack; set &quot;TARG&quot; to 20,
push a pointer to &quot;TARG&quot; onto the stack&quot;. At
the end of the operation, the stack does not contain the
values 10 and 20, but actually contains two pointers to
&quot;TARG&quot;, which we have set to 20.</p>

<p style="margin-left:11%; margin-top: 1em">If you need to
push multiple different values then you should either use
the &quot;(X)PUSHs&quot; macros, or else use the new
&quot;m(X)PUSH[iunp]&quot; macros, none of which make use of
&quot;TARG&quot;. The &quot;(X)PUSHs&quot; macros simply
push an SV* on the stack, which, as noted under &quot;XSUBs
and the Argument Stack&quot;, will often need to be
&quot;mortal&quot;. The new &quot;m(X)PUSH[iunp]&quot;
macros make this a little easier to achieve by creating a
new mortal for you (via &quot;(X)PUSHmortal&quot;), pushing
that onto the stack (extending it if necessary in the case
of the &quot;mXPUSH[iunp]&quot; macros), and then setting
its value. Thus, instead of writing this to &quot;fix&quot;
the example above:</p>


<p style="margin-left:11%; margin-top: 1em">XPUSHs(sv_2mortal(newSViv(10)))
<br>
XPUSHs(sv_2mortal(newSViv(20)))</p>

<p style="margin-left:11%; margin-top: 1em">you can simply
write:</p>

<p style="margin-left:11%; margin-top: 1em">mXPUSHi(10)
<br>
mXPUSHi(20)</p>

<p style="margin-left:11%; margin-top: 1em">On a related
note, if you do use &quot;(X)PUSH[iunp]&quot;, then
you&rsquo;re going to need a &quot;dTARG&quot; in your
variable declarations so that the &quot;*PUSH*&quot; macros
can make use of the local variable &quot;TARG&quot;. See
also &quot;dTARGET&quot; and &quot;dXSTARG&quot;.</p>


<p style="margin-left:11%; margin-top: 1em"><b>Scratchpads</b>
<br>
The question remains on when the SVs which are
<i>target</i>s for opcodes are created. The answer is that
they are created when the current unit--a subroutine or a
file (for opcodes for statements outside of
subroutines)&minus;&minus;is compiled. During this time a
special anonymous Perl array is created, which is called a
scratchpad for the current unit.</p>

<p style="margin-left:11%; margin-top: 1em">A scratchpad
keeps SVs which are lexicals for the current unit and are
targets for opcodes. A previous version of this document
stated that one can deduce that an <small>SV</small> lives
on a scratchpad by looking on its flags: lexicals have
&quot;SVs_PADMY&quot; set, and <i>target</i>s have
&quot;SVs_PADTMP&quot; set. But this has never been fully
true. &quot;SVs_PADMY&quot; could be set on a variable that
no longer resides in any pad. While <i>target</i>s do have
&quot;SVs_PADTMP&quot; set, it can also be set on variables
that have never resided in a pad, but nonetheless act like
<i>target</i>s. As of perl 5.21.5, the &quot;SVs_PADMY&quot;
flag is no longer used and is defined as 0.
&quot;SvPADMY()&quot; now returns true for anything without
&quot;SVs_PADTMP&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">The
correspondence between OPs and <i>target</i>s is not
1&minus;to&minus;1. Different OPs in the compile tree of the
unit can use the same target, if this would not conflict
with the expected life of the temporary.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Scratchpads
and recursion</b> <br>
In fact it is not 100% true that a compiled unit contains a
pointer to the scratchpad <small>AV.</small> In fact it
contains a pointer to an <small>AV</small> of (initially)
one element, and this element is the scratchpad
<small>AV.</small> Why do we need an extra level of
indirection?</p>

<p style="margin-left:11%; margin-top: 1em">The answer is
<b>recursion</b>, and maybe <b>threads</b>. Both these can
create several execution pointers going into the same
subroutine. For the subroutine-child not write over the
temporaries for the subroutine-parent (lifespan of which
covers the call to the child), the parent and the child
should have different scratchpads. (<i>And</i> the lexicals
should be separate anyway!)</p>

<p style="margin-left:11%; margin-top: 1em">So each
subroutine is born with an array of scratchpads (of length
1). On each entry to the subroutine it is checked that the
current depth of the recursion is not more than the length
of this array, and if it is, new scratchpad is created and
pushed into the array.</p>

<p style="margin-left:11%; margin-top: 1em">The
<i>target</i>s on this scratchpad are &quot;undef&quot;s,
but they are already marked with correct flags.</p>

<h2>Memory Allocation
<a name="Memory Allocation"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em"><b>Allocation</b>
<br>
All memory meant to be used with the Perl <small>API</small>
functions should be manipulated using the macros described
in this section. The macros provide the necessary
transparency between differences in the actual malloc
implementation that is used within perl.</p>

<p style="margin-left:11%; margin-top: 1em">The following
three macros are used to initially allocate memory :</p>

<p style="margin-left:11%; margin-top: 1em">Newx(pointer,
number, type); <br>
Newxc(pointer, number, type, cast); <br>
Newxz(pointer, number, type);</p>

<p style="margin-left:11%; margin-top: 1em">The first
argument &quot;pointer&quot; should be the name of a
variable that will point to the newly allocated memory.</p>

<p style="margin-left:11%; margin-top: 1em">The second and
third arguments &quot;number&quot; and &quot;type&quot;
specify how many of the specified type of data structure
should be allocated. The argument &quot;type&quot; is passed
to &quot;sizeof&quot;. The final argument to
&quot;Newxc&quot;, &quot;cast&quot;, should be used if the
&quot;pointer&quot; argument is different from the
&quot;type&quot; argument.</p>

<p style="margin-left:11%; margin-top: 1em">Unlike the
&quot;Newx&quot; and &quot;Newxc&quot; macros, the
&quot;Newxz&quot; macro calls &quot;memzero&quot; to zero
out all the newly allocated memory.</p>


<p style="margin-left:11%; margin-top: 1em"><b>Reallocation</b>
<br>
Renew(pointer, number, type); <br>
Renewc(pointer, number, type, cast); <br>
Safefree(pointer)</p>

<p style="margin-left:11%; margin-top: 1em">These three
macros are used to change a memory buffer size or to free a
piece of memory no longer needed. The arguments to
&quot;Renew&quot; and &quot;Renewc&quot; match those of
&quot;New&quot; and &quot;Newc&quot; with the exception of
not needing the &quot;magic cookie&quot; argument.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Moving</b>
<br>
Move(source, dest, number, type); <br>
Copy(source, dest, number, type); <br>
Zero(dest, number, type);</p>

<p style="margin-left:11%; margin-top: 1em">These three
macros are used to move, copy, or zero out previously
allocated memory. The &quot;source&quot; and
&quot;dest&quot; arguments point to the source and
destination starting points. Perl will move, copy, or zero
out &quot;number&quot; instances of the size of the
&quot;type&quot; data structure (using the
&quot;sizeof&quot; function).</p>

<h2>PerlIO
<a name="PerlIO"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">The most recent
development releases of Perl have been experimenting with
removing Perl&rsquo;s dependency on the &quot;normal&quot;
standard I/O suite and allowing other stdio implementations
to be used. This involves creating a new abstraction layer
that then calls whichever implementation of stdio Perl was
compiled with. All XSUBs should now use the functions in the
PerlIO abstraction layer and not make any assumptions about
what kind of stdio is being used.</p>

<p style="margin-left:11%; margin-top: 1em">For a complete
description of the PerlIO abstraction, consult perlapio.</p>

<h2>Compiled code
<a name="Compiled code"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>Code
tree</b> <br>
Here we describe the internal form your code is converted to
by Perl. Start with a simple example:</p>

<p style="margin-left:11%; margin-top: 1em">$a = $b +
$c;</p>

<p style="margin-left:11%; margin-top: 1em">This is
converted to a tree similar to this one:</p>


<p style="margin-left:11%; margin-top: 1em">assign&minus;to
<br>
/ \ <br>
+ $a <br>
/ \ <br>
$b $c</p>

<p style="margin-left:11%; margin-top: 1em">(but slightly
more complicated). This tree reflects the way Perl parsed
your code, but has nothing to do with the execution order.
There is an additional &quot;thread&quot; going through the
nodes of the tree which shows the order of execution of the
nodes. In our simplified example above it looks like:</p>

<p style="margin-left:11%; margin-top: 1em">$b
&minus;&minus;&minus;&gt; $c &minus;&minus;&minus;&gt; +
&minus;&minus;&minus;&gt; $a &minus;&minus;&minus;&gt;
assign&minus;to</p>

<p style="margin-left:11%; margin-top: 1em">But with the
actual compile tree for &quot;$a = $b + $c&quot; it is
different: some nodes <i>optimized away</i>. As a corollary,
though the actual tree contains more nodes than our
simplified example, the execution order is the same as in
our example.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Examining
the tree</b> <br>
If you have your perl compiled for debugging (usually done
with &quot;&minus;DDEBUGGING&quot; on the
&quot;Configure&quot; command line), you may examine the
compiled tree by specifying &quot;&minus;Dx&quot; on the
Perl command line. The output takes several lines per node,
and for &quot;$b+$c&quot; it looks like this:</p>

<p style="margin-left:11%; margin-top: 1em">5 TYPE = add
===&gt; 6 <br>
TARG = 1 <br>
FLAGS = (SCALAR,KIDS) <br>
{ <br>
TYPE = null ===&gt; (4) <br>
(was rv2sv) <br>
FLAGS = (SCALAR,KIDS) <br>
{ <br>
3 TYPE = gvsv ===&gt; 4 <br>
FLAGS = (SCALAR) <br>
GV = main::b <br>
} <br>
} <br>
{ <br>
TYPE = null ===&gt; (5) <br>
(was rv2sv) <br>
FLAGS = (SCALAR,KIDS) <br>
{ <br>
4 TYPE = gvsv ===&gt; 5 <br>
FLAGS = (SCALAR) <br>
GV = main::c <br>
} <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">This tree has 5
nodes (one per &quot;TYPE&quot; specifier), only 3 of them
are not optimized away (one per number in the left column).
The immediate children of the given node correspond to
&quot;{}&quot; pairs on the same level of indentation, thus
this listing corresponds to the tree:</p>

<p style="margin-left:11%; margin-top: 1em">add <br>
/ \ <br>
null null <br>
| | <br>
gvsv gvsv</p>

<p style="margin-left:11%; margin-top: 1em">The execution
order is indicated by &quot;===&gt;&quot; marks, thus it is
&quot;3 4 5 6&quot; (node 6 is not included into above
listing), i.e., &quot;gvsv gvsv add whatever&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Each of these
nodes represents an op, a fundamental operation inside the
Perl core. The code which implements each operation can be
found in the <i>pp*.c</i> files; the function which
implements the op with type &quot;gvsv&quot; is
&quot;pp_gvsv&quot;, and so on. As the tree above shows,
different ops have different numbers of children:
&quot;add&quot; is a binary operator, as one would expect,
and so has two children. To accommodate the various
different numbers of children, there are various types of op
data structure, and they link together in different
ways.</p>

<p style="margin-left:11%; margin-top: 1em">The simplest
type of op structure is &quot;OP&quot;: this has no
children. Unary operators, &quot;UNOP&quot;s, have one
child, and this is pointed to by the &quot;op_first&quot;
field. Binary operators (&quot;BINOP&quot;s) have not only
an &quot;op_first&quot; field but also an
&quot;op_last&quot; field. The most complex type of op is a
&quot;LISTOP&quot;, which has any number of children. In
this case, the first child is pointed to by
&quot;op_first&quot; and the last child by
&quot;op_last&quot;. The children in between can be found by
iteratively following the &quot;OpSIBLING&quot; pointer from
the first child to the last (but see below).</p>

<p style="margin-left:11%; margin-top: 1em">There are also
some other op types: a &quot;PMOP&quot; holds a regular
expression, and has no children, and a &quot;LOOP&quot; may
or may not have children. If the &quot;op_children&quot;
field is non-zero, it behaves like a &quot;LISTOP&quot;. To
complicate matters, if a &quot;UNOP&quot; is actually a
&quot;null&quot; op after optimization (see &quot;Compile
pass 2: context propagation&quot;) it will still have
children in accordance with its former type.</p>

<p style="margin-left:11%; margin-top: 1em">Finally, there
is a &quot;LOGOP&quot;, or logic op. Like a
&quot;LISTOP&quot;, this has one or more children, but it
doesn&rsquo;t have an &quot;op_last&quot; field: so you have
to follow &quot;op_first&quot; and then the
&quot;OpSIBLING&quot; chain itself to find the last child.
Instead it has an &quot;op_other&quot; field, which is
comparable to the &quot;op_next&quot; field described below,
and represents an alternate execution path. Operators like
&quot;and&quot;, &quot;or&quot; and &quot;?&quot; are
&quot;LOGOP&quot;s. Note that in general,
&quot;op_other&quot; may not point to any of the direct
children of the &quot;LOGOP&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Starting in
version 5.21.2, perls built with the experimental define
&quot;&minus;DPERL_OP_PARENT&quot; add an extra boolean flag
for each op, &quot;op_moresib&quot;. When not set, this
indicates that this is the last op in an
&quot;OpSIBLING&quot; chain. This frees up the
&quot;op_sibling&quot; field on the last sibling to point
back to the parent op. Under this build, that field is also
renamed &quot;op_sibparent&quot; to reflect its joint role.
The macro OpSIBLING(o) wraps this special behaviour, and
always returns <small>NULL</small> on the last sibling. With
this build the op_parent(o) function can be used to find the
parent of any op. Thus for forward compatibility, you should
always use the OpSIBLING(o) macro rather than accessing
&quot;op_sibling&quot; directly.</p>

<p style="margin-left:11%; margin-top: 1em">Another way to
examine the tree is to use a compiler back-end module, such
as B::Concise.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Compile pass
1: check routines</b> <br>
The tree is created by the compiler while <i>yacc</i> code
feeds it the constructions it recognizes. Since <i>yacc</i>
works bottom-up, so does the first pass of perl
compilation.</p>

<p style="margin-left:11%; margin-top: 1em">What makes this
pass interesting for perl developers is that some
optimization may be performed on this pass. This is
optimization by so-called &quot;check routines&quot;. The
correspondence between node names and corresponding check
routines is described in <i>opcode.pl</i> (do not forget to
run &quot;make regen_headers&quot; if you modify this
file).</p>

<p style="margin-left:11%; margin-top: 1em">A check routine
is called when the node is fully constructed except for the
execution-order thread. Since at this time there are no
back-links to the currently constructed node, one can do
most any operation to the top-level node, including freeing
it and/or creating new nodes above/below it.</p>

<p style="margin-left:11%; margin-top: 1em">The check
routine returns the node which should be inserted into the
tree (if the top-level node was not modified, check routine
returns its argument).</p>

<p style="margin-left:11%; margin-top: 1em">By convention,
check routines have names &quot;ck_*&quot;. They are usually
called from &quot;new*OP&quot; subroutines (or
&quot;convert&quot;) (which in turn are called from
<i>perly.y</i>).</p>

<p style="margin-left:11%; margin-top: 1em"><b>Compile pass
1a: constant folding</b> <br>
Immediately after the check routine is called the returned
node is checked for being compile-time executable. If it is
(the value is judged to be constant) it is immediately
executed, and a <i>constant</i> node with the &quot;return
value&quot; of the corresponding subtree is substituted
instead. The subtree is deleted.</p>

<p style="margin-left:11%; margin-top: 1em">If constant
folding was not performed, the execution-order thread is
created.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Compile pass
2: context propagation</b> <br>
When a context for a part of compile tree is known, it is
propagated down through the tree. At this time the context
can have 5 values (instead of 2 for runtime context): void,
boolean, scalar, list, and lvalue. In contrast with the pass
1 this pass is processed from top to bottom: a node&rsquo;s
context determines the context for its children.</p>

<p style="margin-left:11%; margin-top: 1em">Additional
context-dependent optimizations are performed at this time.
Since at this moment the compile tree contains
back-references (via &quot;thread&quot; pointers), nodes
cannot be <b>free()</b>d now. To allow optimized-away nodes
at this stage, such nodes are <b>null()</b>ified instead of
<b>free()</b>ing (i.e. their type is changed to
<small>OP_NULL</small> ).</p>

<p style="margin-left:11%; margin-top: 1em"><b>Compile pass
3: peephole optimization</b> <br>
After the compile tree for a subroutine (or for an
&quot;eval&quot; or a file) is created, an additional pass
over the code is performed. This pass is neither top-down or
bottom-up, but in the execution order (with additional
complications for conditionals). Optimizations performed at
this stage are subject to the same restrictions as in the
pass 2.</p>

<p style="margin-left:11%; margin-top: 1em">Peephole
optimizations are done by calling the function pointed to by
the global variable &quot;PL_peepp&quot;. By default,
&quot;PL_peepp&quot; just calls the function pointed to by
the global variable &quot;PL_rpeepp&quot;. By default, that
performs some basic op fixups and optimisations along the
execution-order op chain, and recursively calls
&quot;PL_rpeepp&quot; for each side chain of ops (resulting
from conditionals). Extensions may provide additional
optimisations or fixups, hooking into either the
per-subroutine or recursive stage, like this:</p>

<p style="margin-left:11%; margin-top: 1em">static peep_t
prev_peepp; <br>
static void my_peep(pTHX_ OP *o) <br>
{ <br>
/* custom per&minus;subroutine optimisation goes here */
<br>
prev_peepp(aTHX_ o); <br>
/* custom per&minus;subroutine optimisation may also go here
*/ <br>
} <br>
BOOT: <br>
prev_peepp = PL_peepp; <br>
PL_peepp = my_peep; <br>
static peep_t prev_rpeepp; <br>
static void my_rpeep(pTHX_ OP *first) <br>
{ <br>
OP *o = first, *t = first; <br>
for(; o = o&minus;&gt;op_next, t = t&minus;&gt;op_next) {
<br>
/* custom per&minus;op optimisation goes here */ <br>
o = o&minus;&gt;op_next; <br>
if (!o || o == t) break; <br>
/* custom per&minus;op optimisation goes AND here */ <br>
} <br>
prev_rpeepp(aTHX_ orig_o); <br>
} <br>
BOOT: <br>
prev_rpeepp = PL_rpeepp; <br>
PL_rpeepp = my_rpeep;</p>

<p style="margin-left:11%; margin-top: 1em"><b>Pluggable
runops</b> <br>
The compile tree is executed in a runops function. There are
two runops functions, in <i>run.c</i> and in <i>dump.c</i>.
&quot;Perl_runops_debug&quot; is used with
<small>DEBUGGING</small> and
&quot;Perl_runops_standard&quot; is used otherwise. For fine
control over the execution of the compile tree it is
possible to provide your own runops function.</p>

<p style="margin-left:11%; margin-top: 1em">It&rsquo;s
probably best to copy one of the existing runops functions
and change it to suit your needs. Then, in the
<small>BOOT</small> section of your <small>XS</small> file,
add the line:</p>

<p style="margin-left:11%; margin-top: 1em">PL_runops =
my_runops;</p>

<p style="margin-left:11%; margin-top: 1em">This function
should be as efficient as possible to keep your programs
running as fast as possible.</p>


<p style="margin-left:11%; margin-top: 1em"><b>Compile-time
scope hooks</b> <br>
As of perl 5.14 it is possible to hook into the compile-time
lexical scope mechanism using
&quot;Perl_blockhook_register&quot;. This is used like
this:</p>

<p style="margin-left:11%; margin-top: 1em">STATIC void
my_start_hook(pTHX_ int full); <br>
STATIC BHK my_hooks; <br>
BOOT: <br>
BhkENTRY_set(&amp;my_hooks, bhk_start, my_start_hook); <br>
Perl_blockhook_register(aTHX_ &amp;my_hooks);</p>

<p style="margin-left:11%; margin-top: 1em">This will
arrange to have &quot;my_start_hook&quot; called at the
start of compiling every lexical scope. The available hooks
are: <br>
&quot;void bhk_start(pTHX_ int full)&quot;</p>

<p style="margin-left:17%;">This is called just after
starting a new lexical scope. Note that Perl code like</p>

<p style="margin-left:17%; margin-top: 1em">if ($x) { ...
}</p>

<p style="margin-left:17%; margin-top: 1em">creates two
scopes: the first starts at the &quot;(&quot; and has
&quot;full == 1&quot;, the second starts at the
&quot;{&quot; and has &quot;full == 0&quot;. Both end at the
&quot;}&quot;, so calls to &quot;start&quot; and
&quot;pre&quot;/&quot;post_end&quot; will match. Anything
pushed onto the save stack by this hook will be popped just
before the scope ends (between the &quot;pre_&quot; and
&quot;post_end&quot; hooks, in fact).</p>

<p style="margin-left:11%;">&quot;void bhk_pre_end(pTHX_ OP
**o)&quot;</p>

<p style="margin-left:17%;">This is called at the end of a
lexical scope, just before unwinding the stack. <i>o</i> is
the root of the optree representing the scope; it is a
double pointer so you can replace the <small>OP</small> if
you need to.</p>

<p style="margin-left:11%;">&quot;void bhk_post_end(pTHX_
OP **o)&quot;</p>

<p style="margin-left:17%;">This is called at the end of a
lexical scope, just after unwinding the stack. <i>o</i> is
as above. Note that it is possible for calls to
&quot;pre_&quot; and &quot;post_end&quot; to nest, if there
is something on the save stack that calls string eval.</p>

<p style="margin-left:11%;">&quot;void bhk_eval(pTHX_ OP
*const o)&quot;</p>

<p style="margin-left:17%;">This is called just before
starting to compile an &quot;eval STRING&quot;, &quot;do
FILE&quot;, &quot;require&quot; or &quot;use&quot;, after
the eval has been set up. <i>o</i> is the <small>OP</small>
that requested the eval, and will normally be an
&quot;OP_ENTEREVAL&quot;, &quot;OP_DOFILE&quot; or
&quot;OP_REQUIRE&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Once you have
your hook functions, you need a &quot;BHK&quot; structure to
put them in. It&rsquo;s best to allocate it statically,
since there is no way to free it once it&rsquo;s registered.
The function pointers should be inserted into this structure
using the &quot;BhkENTRY_set&quot; macro, which will also
set flags indicating which entries are valid. If you do need
to allocate your &quot;BHK&quot; dynamically for some
reason, be sure to zero it before you start.</p>

<p style="margin-left:11%; margin-top: 1em">Once
registered, there is no mechanism to switch these hooks off,
so if that is necessary you will need to do this yourself.
An entry in &quot;%^H&quot; is probably the best way, so the
effect is lexically scoped; however it is also possible to
use the &quot;BhkDISABLE&quot; and &quot;BhkENABLE&quot;
macros to temporarily switch entries on and off. You should
also be aware that generally speaking at least one scope
will have opened before your extension is loaded, so you
will see some &quot;pre&quot;/&quot;post_end&quot; pairs
that didn&rsquo;t have a matching &quot;start&quot;.</p>

<h2>Examining internal data structures with the &quot;dump&quot; functions
<a name="Examining internal data structures with the &quot;dump&quot; functions"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">To aid
debugging, the source file <i>dump.c</i> contains a number
of functions which produce formatted output of internal data
structures.</p>

<p style="margin-left:11%; margin-top: 1em">The most
commonly used of these functions is
&quot;Perl_sv_dump&quot;; it&rsquo;s used for dumping SVs,
AVs, HVs, and CVs. The &quot;Devel::Peek&quot; module calls
&quot;sv_dump&quot; to produce debugging output from
Perl-space, so users of that module should already be
familiar with its format.</p>


<p style="margin-left:11%; margin-top: 1em">&quot;Perl_op_dump&quot;
can be used to dump an &quot;OP&quot; structure or any of
its derivatives, and produces output similar to &quot;perl
&minus;Dx&quot;; in fact, &quot;Perl_dump_eval&quot; will
dump the main root of the code being evaluated, exactly like
&quot;&minus;Dx&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Other useful
functions are &quot;Perl_dump_sub&quot;, which turns a
&quot;GV&quot; into an op tree,
&quot;Perl_dump_packsubs&quot; which calls
&quot;Perl_dump_sub&quot; on all the subroutines in a
package like so: (Thankfully, these are all xsubs, so there
is no op tree)</p>

<p style="margin-left:11%; margin-top: 1em">(gdb) print
Perl_dump_packsubs(PL_defstash) <br>
SUB attributes::bootstrap = (xsub 0x811fedc 0) <br>
SUB UNIVERSAL::can = (xsub 0x811f50c 0) <br>
SUB UNIVERSAL::isa = (xsub 0x811f304 0) <br>
SUB UNIVERSAL::VERSION = (xsub 0x811f7ac 0) <br>
SUB DynaLoader::boot_DynaLoader = (xsub 0x805b188 0)</p>

<p style="margin-left:11%; margin-top: 1em">and
&quot;Perl_dump_all&quot;, which dumps all the subroutines
in the stash and the op tree of the main root.</p>

<h2>How multiple interpreters and concurrency are supported
<a name="How multiple interpreters and concurrency are supported"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>Background
and <small>MULTIPLICITY</small></b> <br>
The Perl interpreter can be regarded as a closed box: it has
an <small>API</small> for feeding it code or otherwise
making it do things, but it also has functions for its own
use. This smells a lot like an object, and there is a way
for you to build Perl so that you can have multiple
interpreters, with one interpreter represented either as a C
structure, or inside a thread-specific structure. These
structures contain all the context, the state of that
interpreter.</p>

<p style="margin-left:11%; margin-top: 1em">The macro that
controls the major Perl build flavor is
<small>MULTIPLICITY.</small> The <small>MULTIPLICITY</small>
build has a C structure that packages all the interpreter
state, which is being passed to various perl functions as a
&quot;hidden&quot; first argument.
<small>MULTIPLICITY</small> makes multi-threaded perls
possible (with the ithreads threading model, related to the
macro <small>USE_ITHREADS.</small> )</p>


<p style="margin-left:11%; margin-top: 1em"><small>PERL_IMPLICIT_CONTEXT</small>
is a legacy synonym for <small>MULTIPLICITY.</small></p>

<p style="margin-left:11%; margin-top: 1em">To see whether
you have non-const data you can use a <small>BSD</small> (or
<small>GNU</small> ) compatible &quot;nm&quot;:</p>

<p style="margin-left:11%; margin-top: 1em">nm libperl.a |
grep &minus;v ' [TURtr] '</p>

<p style="margin-left:11%; margin-top: 1em">If this
displays any &quot;D&quot; or &quot;d&quot; symbols (or
possibly &quot;C&quot; or &quot;c&quot;), you have non-const
data. The symbols the &quot;grep&quot; removed are as
follows: &quot;Tt&quot; are <i>text</i>, or code, the
&quot;Rr&quot; are <i>read-only</i> (const) data, and the
&quot;U&quot; is &lt;undefined&gt;, external symbols
referred to.</p>

<p style="margin-left:11%; margin-top: 1em">The test
<i>t/porting/libperl.t</i> does this kind of symbol sanity
checking on &quot;libperl.a&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">All this
obviously requires a way for the Perl internal functions to
be either subroutines taking some kind of structure as the
first argument, or subroutines taking nothing as the first
argument. To enable these two very different ways of
building the interpreter, the Perl source (as it does in so
many other situations) makes heavy use of macros and
subroutine naming conventions.</p>

<p style="margin-left:11%; margin-top: 1em">First problem:
deciding which functions will be public <small>API</small>
functions and which will be private. All functions whose
names begin &quot;S_&quot; are private (think &quot;S&quot;
for &quot;secret&quot; or &quot;static&quot;). All other
functions begin with &quot;Perl_&quot;, but just because a
function begins with &quot;Perl_&quot; does not mean it is
part of the <small>API.</small> (See &quot;Internal
Functions&quot;.) The easiest way to be <b>sure</b> a
function is part of the <small>API</small> is to find its
entry in perlapi. If it exists in perlapi, it&rsquo;s part
of the <small>API.</small> If it doesn&rsquo;t, and you
think it should be (i.e., you need it for your extension),
submit an issue at
&lt;https://github.com/Perl/perl5/issues&gt; explaining why
you think it should be.</p>

<p style="margin-left:11%; margin-top: 1em">Second problem:
there must be a syntax so that the same subroutine
declarations and calls can pass a structure as their first
argument, or pass nothing. To solve this, the subroutines
are named and declared in a particular way. Here&rsquo;s a
typical start of a static function used within the Perl
guts:</p>

<p style="margin-left:11%; margin-top: 1em">STATIC void
<br>
S_incline(pTHX_ char *s)</p>


<p style="margin-left:11%; margin-top: 1em"><small>STATIC</small>
becomes &quot;static&quot; in C, and may be #define&rsquo;d
to nothing in some configurations in the future.</p>

<p style="margin-left:11%; margin-top: 1em">A public
function (i.e. part of the internal <small>API,</small> but
not necessarily sanctioned for use in extensions) begins
like this:</p>

<p style="margin-left:11%; margin-top: 1em">void <br>
Perl_sv_setiv(pTHX_ SV* dsv, IV num)</p>


<p style="margin-left:11%; margin-top: 1em">&quot;pTHX_&quot;
is one of a number of macros (in <i>perl.h</i>) that hide
the details of the interpreter&rsquo;s context.
<small>THX</small> stands for &quot;thread&quot;,
&quot;this&quot;, or &quot;thingy&quot;, as the case may be.
(And no, George Lucas is not involved. :&minus;) The first
character could be &rsquo;p&rsquo; for a <b>p</b>rototype,
&rsquo;a&rsquo; for <b>a</b>rgument, or &rsquo;d&rsquo; for
<b>d</b>eclaration, so we have &quot;pTHX&quot;,
&quot;aTHX&quot; and &quot;dTHX&quot;, and their
variants.</p>

<p style="margin-left:11%; margin-top: 1em">When Perl is
built without options that set <small>MULTIPLICITY,</small>
there is no first argument containing the
interpreter&rsquo;s context. The trailing underscore in the
pTHX_ macro indicates that the macro expansion needs a comma
after the context argument because other arguments follow
it. If <small>MULTIPLICITY</small> is not defined, pTHX_
will be ignored, and the subroutine is not prototyped to
take the extra argument. The form of the macro without the
trailing underscore is used when there are no additional
explicit arguments.</p>

<p style="margin-left:11%; margin-top: 1em">When a core
function calls another, it must pass the context. This is
normally hidden via macros. Consider &quot;sv_setiv&quot;.
It expands into something like this:</p>

<p style="margin-left:11%; margin-top: 1em">#ifdef
MULTIPLICITY <br>
#define sv_setiv(a,b) Perl_sv_setiv(aTHX_ a, b) <br>
/* can't do this for vararg functions, see below */ <br>
#else <br>
#define sv_setiv Perl_sv_setiv <br>
#endif</p>

<p style="margin-left:11%; margin-top: 1em">This works
well, and means that <small>XS</small> authors can gleefully
write:</p>

<p style="margin-left:11%; margin-top: 1em">sv_setiv(foo,
bar);</p>

<p style="margin-left:11%; margin-top: 1em">and still have
it work under all the modes Perl could have been compiled
with.</p>

<p style="margin-left:11%; margin-top: 1em">This
doesn&rsquo;t work so cleanly for varargs functions, though,
as macros imply that the number of arguments is known in
advance. Instead we either need to spell them out fully,
passing &quot;aTHX_&quot; as the first argument (the Perl
core tends to do this with functions like Perl_warner), or
use a context-free version.</p>

<p style="margin-left:11%; margin-top: 1em">The
context-free version of Perl_warner is called
Perl_warner_nocontext, and does not take the extra argument.
Instead it does &quot;dTHX;&quot; to get the context from
thread-local storage. We &quot;#define warner
Perl_warner_nocontext&quot; so that extensions get source
compatibility at the expense of performance. (Passing an arg
is cheaper than grabbing it from thread-local storage.)</p>

<p style="margin-left:11%; margin-top: 1em">You can ignore
[pad]THXx when browsing the Perl headers/sources. Those are
strictly for use within the core. Extensions and embedders
need only be aware of [pad]THX.</p>

<p style="margin-left:11%; margin-top: 1em"><b>So what
happened to dTHR?</b> <br>
&quot;dTHR&quot; was introduced in perl 5.005 to support the
older thread model. The older thread model now uses the
&quot;THX&quot; mechanism to pass context pointers around,
so &quot;dTHR&quot; is not useful any more. Perl 5.6.0 and
later still have it for backward source compatibility, but
it is defined to be a no-op.</p>

<p style="margin-left:11%; margin-top: 1em"><b>How do I use
all this in extensions?</b> <br>
When Perl is built with <small>MULTIPLICITY,</small>
extensions that call any functions in the Perl
<small>API</small> will need to pass the initial context
argument somehow. The kicker is that you will need to write
it in such a way that the extension still compiles when Perl
hasn&rsquo;t been built with <small>MULTIPLICITY</small>
enabled.</p>

<p style="margin-left:11%; margin-top: 1em">There are three
ways to do this. First, the easy but inefficient way, which
is also the default, in order to maintain source
compatibility with extensions: whenever
<i><small>XSUB</small> .h</i> is #included, it redefines the
aTHX and aTHX_ macros to call a function that will return
the context. Thus, something like:</p>

<p style="margin-left:11%; margin-top: 1em">sv_setiv(sv,
num);</p>

<p style="margin-left:11%; margin-top: 1em">in your
extension will translate to this when
<small>MULTIPLICITY</small> is in effect:</p>


<p style="margin-left:11%; margin-top: 1em">Perl_sv_setiv(Perl_get_context(),
sv, num);</p>

<p style="margin-left:11%; margin-top: 1em">or to this
otherwise:</p>


<p style="margin-left:11%; margin-top: 1em">Perl_sv_setiv(sv,
num);</p>

<p style="margin-left:11%; margin-top: 1em">You don&rsquo;t
have to do anything new in your extension to get this; since
the Perl library provides <b>Perl_get_context()</b>, it will
all just work.</p>

<p style="margin-left:11%; margin-top: 1em">The second,
more efficient way is to use the following template for your
Foo.xs:</p>

<p style="margin-left:11%; margin-top: 1em">#define
PERL_NO_GET_CONTEXT /* we want efficiency */ <br>
#include &quot;EXTERN.h&quot; <br>
#include &quot;perl.h&quot; <br>
#include &quot;XSUB.h&quot; <br>
STATIC void my_private_function(int arg1, int arg2); <br>
STATIC void <br>
my_private_function(int arg1, int arg2) <br>
{ <br>
dTHX; /* fetch context */ <br>
... call many Perl API functions ... <br>
} <br>
[... etc ...] <br>
MODULE = Foo PACKAGE = Foo <br>
/* typical XSUB */ <br>
void <br>
my_xsub(arg) <br>
int arg <br>
CODE: <br>
my_private_function(arg, 10);</p>

<p style="margin-left:11%; margin-top: 1em">Note that the
only two changes from the normal way of writing an extension
is the addition of a &quot;#define PERL_NO_GET_CONTEXT&quot;
before including the Perl headers, followed by a
&quot;dTHX;&quot; declaration at the start of every function
that will call the Perl <small>API.</small> (You&rsquo;ll
know which functions need this, because the C compiler will
complain that there&rsquo;s an undeclared identifier in
those functions.) No changes are needed for the XSUBs
themselves, because the <b><small>XS</small> ()</b> macro is
correctly defined to pass in the implicit context if
needed.</p>

<p style="margin-left:11%; margin-top: 1em">The third, even
more efficient way is to ape how it is done within the Perl
guts:</p>

<p style="margin-left:11%; margin-top: 1em">#define
PERL_NO_GET_CONTEXT /* we want efficiency */ <br>
#include &quot;EXTERN.h&quot; <br>
#include &quot;perl.h&quot; <br>
#include &quot;XSUB.h&quot; <br>
/* pTHX_ only needed for functions that call Perl API */
<br>
STATIC void my_private_function(pTHX_ int arg1, int arg2);
<br>
STATIC void <br>
my_private_function(pTHX_ int arg1, int arg2) <br>
{ <br>
/* dTHX; not needed here, because THX is an argument */ <br>
... call Perl API functions ... <br>
} <br>
[... etc ...] <br>
MODULE = Foo PACKAGE = Foo <br>
/* typical XSUB */ <br>
void <br>
my_xsub(arg) <br>
int arg <br>
CODE: <br>
my_private_function(aTHX_ arg, 10);</p>

<p style="margin-left:11%; margin-top: 1em">This
implementation never has to fetch the context using a
function call, since it is always passed as an extra
argument. Depending on your needs for simplicity or
efficiency, you may mix the previous two approaches
freely.</p>

<p style="margin-left:11%; margin-top: 1em">Never add a
comma after &quot;pTHX&quot; yourself--always use the form
of the macro with the underscore for functions that take
explicit arguments, or the form without the argument for
functions with no explicit arguments.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Should I do
anything special if I call perl from multiple threads?</b>
<br>
If you create interpreters in one thread and then proceed to
call them in another, you need to make sure perl&rsquo;s own
Thread Local Storage ( <small>TLS</small> ) slot is
initialized correctly in each of those threads.</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;perl_alloc&quot; and &quot;perl_clone&quot;
<small>API</small> functions will automatically set the
<small>TLS</small> slot to the interpreter they created, so
that there is no need to do anything special if the
interpreter is always accessed in the same thread that
created it, and that thread did not create or call any other
interpreters afterwards. If that is not the case, you have
to set the <small>TLS</small> slot of the thread before
calling any functions in the Perl <small>API</small> on that
particular interpreter. This is done by calling the
&quot;PERL_SET_CONTEXT&quot; macro in that thread as the
first thing you do:</p>

<p style="margin-left:11%; margin-top: 1em">/* do this
before doing anything else with some_perl */ <br>
PERL_SET_CONTEXT(some_perl); <br>
... other Perl API calls on some_perl go here ...</p>

<p style="margin-left:11%; margin-top: 1em">(You can always
get the current context via
&quot;PERL_GET_CONTEXT&quot;.)</p>

<p style="margin-left:11%; margin-top: 1em"><b>Future Plans
and <small>PERL_IMPLICIT_SYS</small></b> <br>
Just as <small>MULTIPLICITY</small> provides a way to bundle
up everything that the interpreter knows about itself and
pass it around, so too are there plans to allow the
interpreter to bundle up everything it knows about the
environment it&rsquo;s running on. This is enabled with the
<small>PERL_IMPLICIT_SYS</small> macro. Currently it only
works with <small>USE_ITHREADS</small> on Windows.</p>

<p style="margin-left:11%; margin-top: 1em">This allows the
ability to provide an extra pointer (called the
&quot;host&quot; environment) for all the system calls. This
makes it possible for all the system stuff to maintain their
own state, broken down into seven C structures. These are
thin wrappers around the usual system calls (see
<i>win32/perllib.c</i>) for the default perl executable, but
for a more ambitious host (like the one that would do
<b>fork()</b> emulation) all the extra work needed to
pretend that different interpreters are actually different
&quot;processes&quot;, would be done here.</p>

<p style="margin-left:11%; margin-top: 1em">The Perl
engine/interpreter and the host are orthogonal entities.
There could be one or more interpreters in a process, and
one or more &quot;hosts&quot;, with free association between
them.</p>

<h2>Internal Functions
<a name="Internal Functions"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">All of
Perl&rsquo;s internal functions which will be exposed to the
outside world are prefixed by &quot;Perl_&quot; so that they
will not conflict with <small>XS</small> functions or
functions used in a program in which Perl is embedded.
Similarly, all global variables begin with &quot;PL_&quot;.
(By convention, static functions start with
&quot;S_&quot;.)</p>

<p style="margin-left:11%; margin-top: 1em">Inside the Perl
core (&quot;PERL_CORE&quot; defined), you can get at the
functions either with or without the &quot;Perl_&quot;
prefix, thanks to a bunch of defines that live in
<i>embed.h</i>. Note that extension code should <i>not</i>
set &quot;PERL_CORE&quot;; this exposes the full perl
internals, and is likely to cause breakage of the
<small>XS</small> in each new perl release.</p>

<p style="margin-left:11%; margin-top: 1em">The file
<i>embed.h</i> is generated automatically from
<i>embed.pl</i> and <i>embed.fnc</i>. <i>embed.pl</i> also
creates the prototyping header files for the internal
functions, generates the documentation and a lot of other
bits and pieces. It&rsquo;s important that when you add a
new function to the core or change an existing one, you
change the data in the table in <i>embed.fnc</i> as well.
Here&rsquo;s a sample entry from that table:</p>

<p style="margin-left:11%; margin-top: 1em">Apd |SV**
|av_fetch |AV* ar|I32 key|I32 lval</p>

<p style="margin-left:11%; margin-top: 1em">The first
column is a set of flags, the second column the return type,
the third column the name. Columns after that are the
arguments. The flags are documented at the top of
<i>embed.fnc</i>.</p>

<p style="margin-left:11%; margin-top: 1em">If you edit
<i>embed.pl</i> or <i>embed.fnc</i>, you will need to run
&quot;make regen_headers&quot; to force a rebuild of
<i>embed.h</i> and other auto-generated files.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Formatted
Printing of IVs, UVs, and NVs</b> <br>
If you are printing IVs, UVs, or <small>NVS</small> instead
of the <b>stdio</b>(3) style formatting codes like %d, %ld,
%f, you should use the following macros for portability</p>

<p style="margin-left:11%; margin-top: 1em">IVdf IV in
decimal <br>
UVuf UV in decimal <br>
UVof UV in octal <br>
UVxf UV in hexadecimal <br>
NVef NV %e&minus;like <br>
NVff NV %f&minus;like <br>
NVgf NV %g&minus;like</p>

<p style="margin-left:11%; margin-top: 1em">These will take
care of 64&minus;bit integers and long doubles. For
example:</p>


<p style="margin-left:11%; margin-top: 1em">printf(&quot;IV
is %&quot; IVdf &quot;\n&quot;, iv);</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;IVdf&quot; will expand to whatever is the correct
format for the IVs. Note that the spaces are required around
the format in case the code is compiled with C
<small>++</small> , to maintain compliance with its
standard.</p>

<p style="margin-left:11%; margin-top: 1em">Note that there
are different &quot;long doubles&quot;: Perl will use
whatever the compiler has.</p>

<p style="margin-left:11%; margin-top: 1em">If you are
printing addresses of pointers, use %p or UVxf combined with
<b><small>PTR2UV</small> ()</b>.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Formatted
Printing of SVs</b> <br>
The contents of SVs may be printed using the &quot;SVf&quot;
format, like so:</p>


<p style="margin-left:11%; margin-top: 1em">Perl_croak(aTHX_
&quot;This croaked because: %&quot; SVf &quot;\n&quot;,
SVfARG(err_msg))</p>

<p style="margin-left:11%; margin-top: 1em">where
&quot;err_msg&quot; is an <small>SV.</small></p>

<p style="margin-left:11%; margin-top: 1em">Not all scalar
types are printable. Simple values certainly are: one of
<small>IV, UV, NV,</small> or <small>PV.</small> Also, if
the <small>SV</small> is a reference to some value, either
it will be dereferenced and the value printed, or
information about the type of that value and its address are
displayed. The results of printing any other type of
<small>SV</small> are undefined and likely to lead to an
interpreter crash. NVs are printed using a %g&minus;ish
format.</p>

<p style="margin-left:11%; margin-top: 1em">Note that the
spaces are required around the &quot;SVf&quot; in case the
code is compiled with C <small>++</small> , to maintain
compliance with its standard.</p>

<p style="margin-left:11%; margin-top: 1em">Note that any
filehandle being printed to under <small>UTF&minus;8</small>
must be expecting <small>UTF&minus;8</small> in order to get
good results and avoid Wide-character warnings. One way to
do this for typical filehandles is to invoke perl with the
&quot;&minus;C&quot;&gt; parameter. (See &quot;&minus;C
[number/list]&quot; in perlrun.</p>

<p style="margin-left:11%; margin-top: 1em">You can use
this to concatenate two scalars:</p>

<p style="margin-left:11%; margin-top: 1em">SV *var1 =
get_sv(&quot;var1&quot;, GV_ADD); <br>
SV *var2 = get_sv(&quot;var2&quot;, GV_ADD); <br>
SV *var3 = newSVpvf(&quot;var1=%&quot; SVf &quot; and
var2=%&quot; SVf, <br>
SVfARG(var1), SVfARG(var2));</p>

<p style="margin-left:11%; margin-top: 1em"><b>Formatted
Printing of Strings</b> <br>
If you just want the bytes printed in a 7bit NUL-terminated
string, you can just use %s (assuming they are all really
only 7bit). But if there is a possibility the value will be
encoded as <small>UTF&minus;8</small> or contains bytes
above 0x7F (and therefore 8bit), you should instead use the
&quot;UTF8f&quot; format. And as its parameter, use the
&quot;UTF8fARG()&quot; macro:</p>

<p style="margin-left:11%; margin-top: 1em">chr * msg; <br>
/* U+2018: \xE2\x80\x98 LEFT SINGLE QUOTATION MARK <br>
U+2019: \xE2\x80\x99 RIGHT SINGLE QUOTATION MARK */ <br>
if (can_utf8) <br>
msg = &quot;\xE2\x80\x98Uses fancy quotes\xE2\x80\x99&quot;;
<br>
else <br>
msg = &quot;'Uses simple quotes'&quot;; <br>
Perl_croak(aTHX_ &quot;The message is: %&quot; UTF8f
&quot;\n&quot;, <br>
UTF8fARG(can_utf8, strlen(msg), msg));</p>

<p style="margin-left:11%; margin-top: 1em">The first
parameter to &quot;UTF8fARG&quot; is a boolean: 1 if the
string is in <small>UTF&minus;8</small> ; 0 if string is in
native byte encoding (Latin1). The second parameter is the
number of bytes in the string to print. And the third and
final parameter is a pointer to the first byte in the
string.</p>

<p style="margin-left:11%; margin-top: 1em">Note that any
filehandle being printed to under <small>UTF&minus;8</small>
must be expecting <small>UTF&minus;8</small> in order to get
good results and avoid Wide-character warnings. One way to
do this for typical filehandles is to invoke perl with the
&quot;&minus;C&quot;&gt; parameter. (See &quot;&minus;C
[number/list]&quot; in perlrun.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Formatted
Printing of &quot;Size_t&quot; and &quot;SSize_t&quot;</b>
<br>
The most general way to do this is to cast them to a
<small>UV</small> or <small>IV,</small> and print as in the
previous section.</p>

<p style="margin-left:11%; margin-top: 1em">But if
you&rsquo;re using &quot;PerlIO_printf()&quot;, it&rsquo;s
less typing and visual clutter to use the %z length modifier
(for <i>siZe</i>):</p>


<p style="margin-left:11%; margin-top: 1em">PerlIO_printf(&quot;STRLEN
is %zu\n&quot;, len);</p>

<p style="margin-left:11%; margin-top: 1em">This modifier
is not portable, so its use should be restricted to
&quot;PerlIO_printf()&quot;.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Formatted
Printing of &quot;Ptrdiff_t&quot;, &quot;intmax_t&quot;,
&quot;short&quot; and other special sizes</b> <br>
There are modifiers for these special situations if you are
using &quot;PerlIO_printf()&quot;. See &quot;size&quot; in
perlfunc.</p>


<p style="margin-left:11%; margin-top: 1em"><b>Pointer-To-Integer
and Integer-To-Pointer</b> <br>
Because pointer size does not necessarily equal integer
size, use the follow macros to do it right.</p>


<p style="margin-left:11%; margin-top: 1em">PTR2UV(pointer)
<br>
PTR2IV(pointer) <br>
PTR2NV(pointer) <br>
INT2PTR(pointertotype, integer)</p>

<p style="margin-left:11%; margin-top: 1em">For
example:</p>

<p style="margin-left:11%; margin-top: 1em">IV iv = ...;
<br>
SV *sv = INT2PTR(SV*, iv);</p>

<p style="margin-left:11%; margin-top: 1em">and</p>

<p style="margin-left:11%; margin-top: 1em">AV *av = ...;
<br>
UV uv = PTR2UV(av);</p>

<p style="margin-left:11%; margin-top: 1em">There are
also</p>


<p style="margin-left:11%; margin-top: 1em">PTR2nat(pointer)
/* pointer to integer of PTRSIZE */ <br>
PTR2ul(pointer) /* pointer to unsigned long */</p>

<p style="margin-left:11%; margin-top: 1em">And
&quot;PTRV&quot; which gives the native type for an integer
the same size as pointers, such as &quot;unsigned&quot; or
&quot;unsigned long&quot;.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Exception
Handling</b> <br>
There are a couple of macros to do very basic exception
handling in <small>XS</small> modules. You have to define
&quot;NO_XSLOCKS&quot; before including
<i><small>XSUB</small> .h</i> to be able to use these
macros:</p>

<p style="margin-left:11%; margin-top: 1em">#define
NO_XSLOCKS <br>
#include &quot;XSUB.h&quot;</p>

<p style="margin-left:11%; margin-top: 1em">You can use
these macros if you call code that may croak, but you need
to do some cleanup before giving control back to Perl. For
example:</p>

<p style="margin-left:11%; margin-top: 1em">dXCPT; /* set
up necessary variables */ <br>
XCPT_TRY_START { <br>
code_that_may_croak(); <br>
} XCPT_TRY_END <br>
XCPT_CATCH <br>
{ <br>
/* do cleanup here */ <br>
XCPT_RETHROW; <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">Note that you
always have to rethrow an exception that has been caught.
Using these macros, it is not possible to just catch the
exception and ignore it. If you have to ignore the
exception, you have to use the &quot;call_*&quot;
function.</p>

<p style="margin-left:11%; margin-top: 1em">The advantage
of using the above macros is that you don&rsquo;t have to
setup an extra function for &quot;call_*&quot;, and that
using these macros is faster than using
&quot;call_*&quot;.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Source
Documentation</b> <br>
There&rsquo;s an effort going on to document the internal
functions and automatically produce reference manuals from
them -- perlapi is one such manual which details all the
functions which are available to <small>XS</small> writers.
perlintern is the autogenerated manual for the functions
which are not part of the <small>API</small> and are
supposedly for internal use only.</p>

<p style="margin-left:11%; margin-top: 1em">Source
documentation is created by putting <small>POD</small>
comments into the C source, like this:</p>

<p style="margin-left:11%; margin-top: 1em">/* <br>
=for apidoc sv_setiv <br>
Copies an integer into the given SV. Does not handle 'set'
magic. See <br>
L&lt;perlapi/sv_setiv_mg&gt;. <br>
=cut <br>
*/</p>

<p style="margin-left:11%; margin-top: 1em">Please try and
supply some documentation if you add functions to the Perl
core.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Backwards
compatibility</b> <br>
The Perl <small>API</small> changes over time. New functions
are added or the interfaces of existing functions are
changed. The &quot;Devel::PPPort&quot; module tries to
provide compatibility code for some of these changes, so
<small>XS</small> writers don&rsquo;t have to code it
themselves when supporting multiple versions of Perl.</p>


<p style="margin-left:11%; margin-top: 1em">&quot;Devel::PPPort&quot;
generates a C header file <i>ppport.h</i> that can also be
run as a Perl script. To generate <i>ppport.h</i>, run:</p>

<p style="margin-left:11%; margin-top: 1em">perl
&minus;MDevel::PPPort &minus;eDevel::PPPort::WriteFile</p>

<p style="margin-left:11%; margin-top: 1em">Besides
checking existing <small>XS</small> code, the script can
also be used to retrieve compatibility information for
various <small>API</small> calls using the
&quot;&minus;&minus;api&minus;info&quot; command line
switch. For example:</p>

<p style="margin-left:11%; margin-top: 1em">% perl ppport.h
&minus;&minus;api&minus;info=sv_magicext</p>

<p style="margin-left:11%; margin-top: 1em">For details,
see &quot;perldoc&nbsp;ppport.h&quot;.</p>

<h2>Unicode Support
<a name="Unicode Support"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Perl 5.6.0
introduced Unicode support. It&rsquo;s important for porters
and <small>XS</small> writers to understand this support and
make sure that the code they write does not corrupt Unicode
data.</p>

<p style="margin-left:11%; margin-top: 1em"><b>What is
Unicode, anyway?</b> <br>
In the olden, less enlightened times, we all used to use
<small>ASCII.</small> Most of us did, anyway. The big
problem with <small>ASCII</small> is that it&rsquo;s
American. Well, no, that&rsquo;s not actually the problem;
the problem is that it&rsquo;s not particularly useful for
people who don&rsquo;t use the Roman alphabet. What used to
happen was that particular languages would stick their own
alphabet in the upper range of the sequence, between 128 and
255. Of course, we then ended up with plenty of variants
that weren&rsquo;t quite <small>ASCII,</small> and the whole
point of it being a standard was lost.</p>

<p style="margin-left:11%; margin-top: 1em">Worse still, if
you&rsquo;ve got a language like Chinese or Japanese that
has hundreds or thousands of characters, then you really
can&rsquo;t fit them into a mere 256, so they had to forget
about <small>ASCII</small> altogether, and build their own
systems using pairs of numbers to refer to one
character.</p>

<p style="margin-left:11%; margin-top: 1em">To fix this,
some people formed Unicode, Inc. and produced a new
character set containing all the characters you can possibly
think of and more. There are several ways of representing
these characters, and the one Perl uses is called
<small>UTF&minus;8. UTF&minus;8</small> uses a variable
number of bytes to represent a character. You can learn more
about Unicode and Perl&rsquo;s Unicode model in
perlunicode.</p>

<p style="margin-left:11%; margin-top: 1em">(On
<small>EBCDIC</small> platforms, Perl uses instead
UTF-EBCDIC, which is a form of <small>UTF&minus;8</small>
adapted for <small>EBCDIC</small> platforms. Below, we just
talk about <small>UTF&minus;8.</small> UTF-EBCDIC is like
<small>UTF&minus;8,</small> but the details are different.
The macros hide the differences from you, just remember that
the particular numbers and bit patterns presented below will
differ in UTF-EBCDIC.)</p>

<p style="margin-left:11%; margin-top: 1em"><b>How can I
recognise a <small>UTF&minus;8</small> string?</b> <br>
You can&rsquo;t. This is because <small>UTF&minus;8</small>
data is stored in bytes just like non&minus;UTF&minus;8
data. The Unicode character 200, (0xC8 for you hex types)
capital E with a grave accent, is represented by the two
bytes &quot;v196.172&quot;. Unfortunately, the non-Unicode
string &quot;chr(196).chr(172)&quot; has that byte sequence
as well. So you can&rsquo;t tell just by looking -- this is
what makes Unicode input an interesting problem.</p>

<p style="margin-left:11%; margin-top: 1em">In general, you
either have to know what you&rsquo;re dealing with, or you
have to guess. The <small>API</small> function
&quot;is_utf8_string&quot; can help; it&rsquo;ll tell you if
a string contains only valid <small>UTF&minus;8</small>
characters, and the chances of a non&minus;UTF&minus;8
string looking like valid <small>UTF&minus;8</small> become
very small very quickly with increasing string length. On a
character-by-character basis, &quot;isUTF8_CHAR&quot; will
tell you whether the current character in a string is valid
<small>UTF&minus;8.</small></p>

<p style="margin-left:11%; margin-top: 1em"><b>How does
<small>UTF&minus;8</small> represent Unicode characters?</b>
<br>
As mentioned above, <small>UTF&minus;8</small> uses a
variable number of bytes to store a character. Characters
with values 0...127 are stored in one byte, just like good
ol&rsquo; <small>ASCII.</small> Character 128 is stored as
&quot;v194.128&quot;; this continues up to character 191,
which is &quot;v194.191&quot;. Now we&rsquo;ve run out of
bits (191 is binary 10111111) so we move on; character 192
is &quot;v195.128&quot;. And so it goes on, moving to three
bytes at character 2048. &quot;Unicode Encodings&quot; in
perlunicode has pictures of how this works.</p>

<p style="margin-left:11%; margin-top: 1em">Assuming you
know you&rsquo;re dealing with a <small>UTF&minus;8</small>
string, you can find out how long the first character in it
is with the &quot;UTF8SKIP&quot; macro:</p>

<p style="margin-left:11%; margin-top: 1em">char *utf =
&quot;\305\233\340\240\201&quot;; <br>
I32 len; <br>
len = UTF8SKIP(utf); /* len is 2 here */ <br>
utf += len; <br>
len = UTF8SKIP(utf); /* len is 3 here */</p>

<p style="margin-left:11%; margin-top: 1em">Another way to
skip over characters in a <small>UTF&minus;8</small> string
is to use &quot;utf8_hop&quot;, which takes a string and a
number of characters to skip over. You&rsquo;re on your own
about bounds checking, though, so don&rsquo;t use it
lightly.</p>

<p style="margin-left:11%; margin-top: 1em">All bytes in a
multi-byte <small>UTF&minus;8</small> character will have
the high bit set, so you can test if you need to do
something special with this character like this (the
&quot;UTF8_IS_INVARIANT()&quot; is a macro that tests
whether the byte is encoded as a single byte even in
<small>UTF&minus;8</small> ):</p>

<p style="margin-left:11%; margin-top: 1em">U8 *utf; /*
Initialize this to point to the beginning of the <br>
sequence to convert */ <br>
U8 *utf_end; /* Initialize this to 1 beyond the end of the
sequence <br>
pointed to by 'utf' */ <br>
UV uv; /* Returned code point; note: a UV, not a U8, not a
<br>
char */ <br>
STRLEN len; /* Returned length of character in bytes */ <br>
if (!UTF8_IS_INVARIANT(*utf)) <br>
/* Must treat this as UTF&minus;8 */ <br>
uv = utf8_to_uvchr_buf(utf, utf_end, &amp;len); <br>
else <br>
/* OK to treat this character as a byte */ <br>
uv = *utf;</p>

<p style="margin-left:11%; margin-top: 1em">You can also
see in that example that we use
&quot;utf8_to_uvchr_buf&quot; to get the value of the
character; the inverse function &quot;uvchr_to_utf8&quot; is
available for putting a <small>UV</small> into
<small>UTF&minus;8:</small></p>

<p style="margin-left:11%; margin-top: 1em">if
(!UVCHR_IS_INVARIANT(uv)) <br>
/* Must treat this as UTF8 */ <br>
utf8 = uvchr_to_utf8(utf8, uv); <br>
else <br>
/* OK to treat this character as a byte */ <br>
*utf8++ = uv;</p>

<p style="margin-left:11%; margin-top: 1em">You <b>must</b>
convert characters to UVs using the above functions if
you&rsquo;re ever in a situation where you have to match
<small>UTF&minus;8</small> and non&minus;UTF&minus;8
characters. You may not skip over <small>UTF&minus;8</small>
characters in this case. If you do this, you&rsquo;ll lose
the ability to match hi-bit non&minus;UTF&minus;8
characters; for instance, if your <small>UTF&minus;8</small>
string contains &quot;v196.172&quot;, and you skip that
character, you can never match a &quot;chr(200)&quot; in a
non&minus;UTF&minus;8 string. So don&rsquo;t do that!</p>

<p style="margin-left:11%; margin-top: 1em">(Note that we
don&rsquo;t have to test for invariant characters in the
examples above. The functions work on any well-formed
<small>UTF&minus;8</small> input. It&rsquo;s just that its
faster to avoid the function overhead when it&rsquo;s not
needed.)</p>

<p style="margin-left:11%; margin-top: 1em"><b>How does
Perl store <small>UTF&minus;8</small> strings?</b> <br>
Currently, Perl deals with <small>UTF&minus;8</small>
strings and non&minus;UTF&minus;8 strings slightly
differently. A flag in the <small>SV,</small>
&quot;SVf_UTF8&quot;, indicates that the string is
internally encoded as <small>UTF&minus;8.</small> Without
it, the byte value is the codepoint number and vice versa.
This flag is only meaningful if the <small>SV</small> is
&quot;SvPOK&quot; or immediately after stringification via
&quot;SvPV&quot; or a similar macro. You can check and
manipulate this flag with the following macros:</p>

<p style="margin-left:11%; margin-top: 1em">SvUTF8(sv) <br>
SvUTF8_on(sv) <br>
SvUTF8_off(sv)</p>

<p style="margin-left:11%; margin-top: 1em">This flag has
an important effect on Perl&rsquo;s treatment of the string:
if <small>UTF&minus;8</small> data is not properly
distinguished, regular expressions, &quot;length&quot;,
&quot;substr&quot; and other string handling operations will
have undesirable (wrong) results.</p>

<p style="margin-left:11%; margin-top: 1em">The problem
comes when you have, for instance, a string that isn&rsquo;t
flagged as <small>UTF&minus;8,</small> and contains a byte
sequence that could be <small>UTF&minus;8</small> --
especially when combining non&minus;UTF&minus;8 and
<small>UTF&minus;8</small> strings.</p>

<p style="margin-left:11%; margin-top: 1em">Never forget
that the &quot;SVf_UTF8&quot; flag is separate from the
<small>PV</small> value; you need to be sure you don&rsquo;t
accidentally knock it off while you&rsquo;re manipulating
SVs. More specifically, you cannot expect to do this:</p>

<p style="margin-left:11%; margin-top: 1em">SV *sv; <br>
SV *nsv; <br>
STRLEN len; <br>
char *p; <br>
p = SvPV(sv, len); <br>
frobnicate(p); <br>
nsv = newSVpvn(p, len);</p>

<p style="margin-left:11%; margin-top: 1em">The
&quot;char*&quot; string does not tell you the whole story,
and you can&rsquo;t copy or reconstruct an <small>SV</small>
just by copying the string value. Check if the old
<small>SV</small> has the <small>UTF8</small> flag set
(<i>after</i> the &quot;SvPV&quot; call), and act
accordingly:</p>

<p style="margin-left:11%; margin-top: 1em">p = SvPV(sv,
len); <br>
is_utf8 = SvUTF8(sv); <br>
frobnicate(p, is_utf8); <br>
nsv = newSVpvn(p, len); <br>
if (is_utf8) <br>
SvUTF8_on(nsv);</p>

<p style="margin-left:11%; margin-top: 1em">In the above,
your &quot;frobnicate&quot; function has been changed to be
made aware of whether or not it&rsquo;s dealing with
<small>UTF&minus;8</small> data, so that it can handle the
string appropriately.</p>

<p style="margin-left:11%; margin-top: 1em">Since just
passing an <small>SV</small> to an <small>XS</small>
function and copying the data of the <small>SV</small> is
not enough to copy the <small>UTF8</small> flags, even less
right is just passing a &quot;char&nbsp;*&quot; to an
<small>XS</small> function.</p>

<p style="margin-left:11%; margin-top: 1em">For full
generality, use the &quot;DO_UTF8&quot; macro to see if the
string in an <small>SV</small> is to be <i>treated</i> as
<small>UTF&minus;8.</small> This takes into account if the
call to the <small>XS</small> function is being made from
within the scope of &quot;use&nbsp;bytes&quot;. If so, the
underlying bytes that comprise the
<small>UTF&minus;8</small> string are to be exposed, rather
than the character they represent. But this pragma should
only really be used for debugging and perhaps low-level
testing at the byte level. Hence most <small>XS</small> code
need not concern itself with this, but various areas of the
perl core do need to support it.</p>

<p style="margin-left:11%; margin-top: 1em">And this
isn&rsquo;t the whole story. Starting in Perl v5.12, strings
that aren&rsquo;t encoded in <small>UTF&minus;8</small> may
also be treated as Unicode under various conditions (see
&quot; <small>ASCII</small> Rules versus Unicode Rules&quot;
in perlunicode). This is only really a problem for
characters whose ordinals are between 128 and 255, and their
behavior varies under <small>ASCII</small> versus Unicode
rules in ways that your code cares about (see &quot;The
&quot;Unicode Bug&quot;&quot; in perlunicode). There is no
published <small>API</small> for dealing with this, as it is
subject to change, but you can look at the code for
&quot;pp_lc&quot; in <i>pp.c</i> for an example as to how
it&rsquo;s currently done.</p>

<p style="margin-left:11%; margin-top: 1em"><b>How do I
pass a Perl string to a C library?</b> <br>
A Perl string, conceptually, is an opaque sequence of code
points. Many C libraries expect their inputs to be
&quot;classical&quot; C strings, which are arrays of octets
1&minus;255, terminated with a <small>NUL</small> byte. Your
job when writing an interface between Perl and a C library
is to define the mapping between Perl and that library.</p>

<p style="margin-left:11%; margin-top: 1em">Generally
speaking, &quot;SvPVbyte&quot; and related macros suit this
task well. These assume that your Perl string is a
&quot;byte string&quot;, i.e., is either raw, undecoded
input into Perl or is pre-encoded to, e.g.,
<small>UTF&minus;8.</small></p>

<p style="margin-left:11%; margin-top: 1em">Alternatively,
if your C library expects <small>UTF&minus;8</small> text,
you can use &quot;SvPVutf8&quot; and related macros. This
has the same effect as encoding to
<small>UTF&minus;8</small> then calling the corresponding
&quot;SvPVbyte&quot;&minus;related macro.</p>

<p style="margin-left:11%; margin-top: 1em">Some C
libraries may expect other encodings (e.g.,
<small>UTF&minus;16LE</small> ). To give Perl strings to
such libraries you must either do that encoding in Perl then
use &quot;SvPVbyte&quot;, or use an intermediary C library
to convert from however Perl stores the string to the
desired encoding.</p>

<p style="margin-left:11%; margin-top: 1em">Take care also
that NULs in your Perl string don&rsquo;t confuse the C
library. If possible, give the string&rsquo;s length to the
C library; if that&rsquo;s not possible, consider rejecting
strings that contain <small>NUL</small> bytes.</p>

<p style="margin-left:11%; margin-top: 1em"><i>What about
&quot;SvPV&quot;, &quot;SvPV_nolen&quot;, etc.?</i></p>

<p style="margin-left:11%; margin-top: 1em">Consider a
3&minus;character Perl string &quot;$foo =
&quot;\x64\x78\x8c&quot;&quot;. Perl can store these 3
characters either of two ways:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="5%"></td>
<td width="40%">


<p>bytes: 0x64 0x78 0x8c</p></td>
<td width="43%">
</td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="5%"></td>
<td width="40%">


<p><small>UTF&minus;8:</small> 0x64 0x78 0xc2 0x8c</p></td>
<td width="43%">
</td></tr>
</table>

<p style="margin-left:11%; margin-top: 1em">Now let&rsquo;s
say you convert $foo to a C string thus:</p>

<p style="margin-left:11%; margin-top: 1em">STRLEN strlen;
<br>
char *str = SvPV(foo_sv, strlen);</p>

<p style="margin-left:11%; margin-top: 1em">At this point
&quot;str&quot; could point to a 3&minus;byte C string or a
4&minus;byte one.</p>

<p style="margin-left:11%; margin-top: 1em">Generally
speaking, we want &quot;str&quot; to be the same regardless
of how Perl stores $foo, so the ambiguity here is
undesirable. &quot;SvPVbyte&quot; and &quot;SvPVutf8&quot;
solve that by giving predictable output: use
&quot;SvPVbyte&quot; if your C library expects byte strings,
or &quot;SvPVutf8&quot; if it expects
<small>UTF&minus;8.</small></p>

<p style="margin-left:11%; margin-top: 1em">If your C
library happens to support both encodings, then
&quot;SvPV&quot;&minus;&minus;always in tandem with lookups
to &quot;SvUTF8&quot;!&minus;&minus;may be safe and
(slightly) more efficient.</p>


<p style="margin-left:11%; margin-top: 1em"><b><small>TESTING
TIP:</small></b> Use utf8&rsquo;s &quot;upgrade&quot; and
&quot;downgrade&quot; functions in your tests to ensure
consistent handling regardless of Perl&rsquo;s internal
encoding.</p>

<p style="margin-left:11%; margin-top: 1em"><b>How do I
convert a string to <small>UTF&minus;8</small> ?</b> <br>
If you&rsquo;re mixing <small>UTF&minus;8</small> and
non&minus;UTF&minus;8 strings, it is necessary to upgrade
the non&minus;UTF&minus;8 strings to
<small>UTF&minus;8.</small> If you&rsquo;ve got an
<small>SV,</small> the easiest way to do this is:</p>


<p style="margin-left:11%; margin-top: 1em">sv_utf8_upgrade(sv);</p>

<p style="margin-left:11%; margin-top: 1em">However, you
must not do this, for example:</p>

<p style="margin-left:11%; margin-top: 1em">if
(!SvUTF8(left)) <br>
sv_utf8_upgrade(left);</p>

<p style="margin-left:11%; margin-top: 1em">If you do this
in a binary operator, you will actually change one of the
strings that came into the operator, and, while it
shouldn&rsquo;t be noticeable by the end user, it can cause
problems in deficient code.</p>

<p style="margin-left:11%; margin-top: 1em">Instead,
&quot;bytes_to_utf8&quot; will give you a
UTF&minus;8&minus;encoded <b>copy</b> of its string
argument. This is useful for having the data available for
comparisons and so on, without harming the original
<small>SV.</small> There&rsquo;s also
&quot;utf8_to_bytes&quot; to go the other way, but
naturally, this will fail if the string contains any
characters above 255 that can&rsquo;t be represented in a
single byte.</p>

<p style="margin-left:11%; margin-top: 1em"><b>How do I
compare strings?</b> <br>
&quot;sv_cmp&quot; in perlapi and &quot;sv_cmp_flags&quot;
in perlapi do a lexigraphic comparison of two
<small>SV</small> &rsquo;s, and handle UTF&minus;8ness
properly. Note, however, that Unicode specifies a much
fancier mechanism for collation, available via the
Unicode::Collate module.</p>

<p style="margin-left:11%; margin-top: 1em">To just compare
two strings for equality/non&minus;equality, you can just
use &quot;memEQ()&quot; and &quot;memNE()&quot; as usual,
except the strings must be both <small>UTF&minus;8</small>
or not <small>UTF&minus;8</small> encoded.</p>

<p style="margin-left:11%; margin-top: 1em">To compare two
strings case-insensitively, use &quot;foldEQ_utf8()&quot;
(the strings don&rsquo;t have to have the same
UTF&minus;8ness).</p>

<p style="margin-left:11%; margin-top: 1em"><b>Is there
anything else I need to know?</b> <br>
Not really. Just remember these things:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p style="margin-top: 1em">&bull;</p></td>
<td width="3%"></td>
<td width="85%">


<p style="margin-top: 1em">There&rsquo;s no way to tell if
a &quot;char&nbsp;*&quot; or &quot;U8&nbsp;*&quot; string is
<small>UTF&minus;8</small> or not. But you can tell if an
<small>SV</small> is to be treated as
<small>UTF&minus;8</small> by calling &quot;DO_UTF8&quot; on
it, after stringifying it with &quot;SvPV&quot; or a similar
macro. And, you can tell if <small>SV</small> is actually
<small>UTF&minus;8</small> (even if it is not to be treated
as such) by looking at its &quot;SvUTF8&quot; flag (again
after stringifying it). Don&rsquo;t forget to set the flag
if something should be <small>UTF&minus;8.</small> Treat the
flag as part of the <small>PV,</small> even though
it&rsquo;s not -- if you pass on the <small>PV</small> to
somewhere, pass on the flag too.</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="3%"></td>
<td width="85%">


<p>If a string is <small>UTF&minus;8,</small> <b>always</b>
use &quot;utf8_to_uvchr_buf&quot; to get at the value,
unless &quot;UTF8_IS_INVARIANT(*s)&quot; in which case you
can use *s.</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="3%"></td>
<td width="85%">


<p>When writing a character <small>UV</small> to a
<small>UTF&minus;8</small> string, <b>always</b> use
&quot;uvchr_to_utf8&quot;, unless
&quot;UVCHR_IS_INVARIANT(uv))&quot; in which case you can
use &quot;*s = uv&quot;.</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="3%"></td>
<td width="85%">


<p>Mixing <small>UTF&minus;8</small> and
non&minus;UTF&minus;8 strings is tricky. Use
&quot;bytes_to_utf8&quot; to get a new string which is
<small>UTF&minus;8</small> encoded, and then combine
them.</p> </td></tr>
</table>

<h2>Custom Operators
<a name="Custom Operators"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Custom operator
support is an experimental feature that allows you to define
your own ops. This is primarily to allow the building of
interpreters for other languages in the Perl core, but it
also allows optimizations through the creation of
&quot;macro-ops&quot; (ops which perform the functions of
multiple ops which are usually executed together, such as
&quot;gvsv, gvsv, add&quot;.)</p>

<p style="margin-left:11%; margin-top: 1em">This feature is
implemented as a new op type, &quot;OP_CUSTOM&quot;. The
Perl core does not &quot;know&quot; anything special about
this op type, and so it will not be involved in any
optimizations. This also means that you can define your
custom ops to be any op structure -- unary, binary, list and
so on -- you like.</p>

<p style="margin-left:11%; margin-top: 1em">It&rsquo;s
important to know what custom operators won&rsquo;t do for
you. They won&rsquo;t let you add new syntax to Perl,
directly. They won&rsquo;t even let you add new keywords,
directly. In fact, they won&rsquo;t change the way Perl
compiles a program at all. You have to do those changes
yourself, after Perl has compiled the program. You do this
either by manipulating the op tree using a &quot;CHECK&quot;
block and the &quot;B::Generate&quot; module, or by adding a
custom peephole optimizer with the &quot;optimize&quot;
module.</p>

<p style="margin-left:11%; margin-top: 1em">When you do
this, you replace ordinary Perl ops with custom ops by
creating ops with the type &quot;OP_CUSTOM&quot; and the
&quot;op_ppaddr&quot; of your own <small>PP</small>
function. This should be defined in <small>XS</small> code,
and should look like the <small>PP</small> ops in
&quot;pp_*.c&quot;. You are responsible for ensuring that
your op takes the appropriate number of values from the
stack, and you are responsible for adding stack marks if
necessary.</p>

<p style="margin-left:11%; margin-top: 1em">You should also
&quot;register&quot; your op with the Perl interpreter so
that it can produce sensible error and warning messages.
Since it is possible to have multiple custom ops within the
one &quot;logical&quot; op type &quot;OP_CUSTOM&quot;, Perl
uses the value of &quot;o&minus;&gt;op_ppaddr&quot; to
determine which custom op it is dealing with. You should
create an &quot;XOP&quot; structure for each ppaddr you use,
set the properties of the custom op with
&quot;XopENTRY_set&quot;, and register the structure against
the ppaddr using &quot;Perl_custom_op_register&quot;. A
trivial example might look like:</p>

<p style="margin-left:11%; margin-top: 1em">static XOP
my_xop; <br>
static OP *my_pp(pTHX); <br>
BOOT: <br>
XopENTRY_set(&amp;my_xop, xop_name, &quot;myxop&quot;); <br>
XopENTRY_set(&amp;my_xop, xop_desc, &quot;Useless custom
op&quot;); <br>
Perl_custom_op_register(aTHX_ my_pp, &amp;my_xop);</p>

<p style="margin-left:11%; margin-top: 1em">The available
fields in the structure are: <br>
xop_name</p>

<p style="margin-left:17%;">A short name for your op. This
will be included in some error messages, and will also be
returned as &quot;$op&minus;&gt;name&quot; by the B module,
so it will appear in the output of module like
B::Concise.</p>

<p style="margin-left:11%;">xop_desc</p>

<p style="margin-left:17%;">A short description of the
function of the op.</p>

<p style="margin-left:11%;">xop_class</p>

<p style="margin-left:17%;">Which of the various *OP
structures this op uses. This should be one of the
&quot;OA_*&quot; constants from <i>op.h</i>, namely
<small><br>
OA_BASEOP <br>
OA_UNOP <br>
OA_BINOP <br>
OA_LOGOP <br>
OA_LISTOP <br>
OA_PMOP <br>
OA_SVOP <br>
OA_PADOP <br>
OA_PVOP_OR_SVOP</small></p>

<p style="margin-left:23%;">This should be interpreted as
&rsquo;&quot;PVOP&quot;&rsquo; only. The
&quot;_OR_SVOP&quot; is because the only core
&quot;PVOP&quot;, &quot;OP_TRANS&quot;, can sometimes be a
&quot;SVOP&quot; instead.</p>

<p style="margin-left:17%;"><small>OA_LOOP <br>
OA_COP</small></p>

<p style="margin-left:17%; margin-top: 1em">The other
&quot;OA_*&quot; constants should not be used.</p>

<p style="margin-left:11%;">xop_peep</p>

<p style="margin-left:17%;">This member is of type
&quot;Perl_cpeep_t&quot;, which expands to &quot;void
(*Perl_cpeep_t)(aTHX_ OP *o, OP *oldop)&quot;. If it is set,
this function will be called from &quot;Perl_rpeep&quot;
when ops of this type are encountered by the peephole
optimizer. <i>o</i> is the <small>OP</small> that needs
optimizing; <i>oldop</i> is the previous <small>OP</small>
optimized, whose &quot;op_next&quot; points to <i>o</i>.</p>


<p style="margin-left:11%; margin-top: 1em">&quot;B::Generate&quot;
directly supports the creation of custom ops by name.</p>

<h2>Stacks
<a name="Stacks"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Descriptions
above occasionally refer to &quot;the stack&quot;, but there
are in fact many stack-like data structures within the perl
interpreter. When otherwise unqualified, &quot;the
stack&quot; usually refers to the value stack.</p>

<p style="margin-left:11%; margin-top: 1em">The various
stacks have different purposes, and operate in slightly
different ways. Their differences are noted below.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Value
Stack</b> <br>
This stack stores the values that regular perl code is
operating on, usually intermediate values of expressions
within a statement. The stack itself is formed of an array
of <small>SV</small> pointers.</p>

<p style="margin-left:11%; margin-top: 1em">The base of
this stack is pointed to by the interpreter variable
&quot;PL_stack_base&quot;, of type &quot;SV **&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">The head of the
stack is &quot;PL_stack_sp&quot;, and points to the most
recently-pushed item.</p>

<p style="margin-left:11%; margin-top: 1em">Items are
pushed to the stack by using the &quot;PUSHs()&quot; macro
or its variants described above; &quot;XPUSHs()&quot;,
&quot;mPUSHs()&quot;, &quot;mXPUSHs()&quot; and the typed
versions. Note carefully that the non&minus;&quot;X&quot;
versions of these macros do not check the size of the stack
and assume it to be big enough. These must be paired with a
suitable check of the stack&rsquo;s size, such as the
&quot;EXTEND&quot; macro to ensure it is large enough. For
example</p>

<p style="margin-left:11%; margin-top: 1em">EXTEND(SP, 4);
<br>
mPUSHi(10); <br>
mPUSHi(20); <br>
mPUSHi(30); <br>
mPUSHi(40);</p>

<p style="margin-left:11%; margin-top: 1em">This is
slightly more performant than making four separate checks in
four separate &quot;mXPUSHi()&quot; calls.</p>

<p style="margin-left:11%; margin-top: 1em">As a further
performance optimisation, the various &quot;PUSH&quot;
macros all operate using a local variable &quot;SP&quot;,
rather than the interpreter-global variable
&quot;PL_stack_sp&quot;. This variable is declared by the
&quot;dSP&quot; macro &minus; though it is normally implied
by XSUBs and similar so it is rare you have to consider it
directly. Once declared, the &quot;PUSH&quot; macros will
operate only on this local variable, so before invoking any
other perl core functions you must use the
&quot;PUTBACK&quot; macro to return the value from the local
&quot;SP&quot; variable back to the interpreter variable.
Similarly, after calling a perl core function which may have
had reason to move the stack or push/pop values to it, you
must use the &quot;SPAGAIN&quot; macro which refreshes the
local &quot;SP&quot; value back from the interpreter
one.</p>

<p style="margin-left:11%; margin-top: 1em">Items are
popped from the stack by using the &quot;POPs&quot; macro or
its typed versions, There is also a macro &quot;TOPs&quot;
that inspects the topmost item without removing it.</p>

<p style="margin-left:11%; margin-top: 1em">Note
specifically that <small>SV</small> pointers on the value
stack do not contribute to the overall reference count of
the xVs being referred to. If newly-created xVs are being
pushed to the stack you must arrange for them to be
destroyed at a suitable time; usually by using one of the
&quot;mPUSH*&quot; macros or &quot;sv_2mortal()&quot; to
mortalise the xV.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Mark
Stack</b> <br>
The value stack stores individual perl scalar values as
temporaries between expressions. Some perl expressions
operate on entire lists; for that purpose we need to know
where on the stack each list begins. This is the purpose of
the mark stack.</p>

<p style="margin-left:11%; margin-top: 1em">The mark stack
stores integers as I32 values, which are the height of the
value stack at the time before the list began; thus the mark
itself actually points to the value stack entry one before
the list. The list itself starts at &quot;mark +
1&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">The base of
this stack is pointed to by the interpreter variable
&quot;PL_markstack&quot;, of type &quot;I32 *&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">The head of the
stack is &quot;PL_markstack_ptr&quot;, and points to the
most recently-pushed item.</p>

<p style="margin-left:11%; margin-top: 1em">Items are
pushed to the stack by using the &quot;PUSHMARK()&quot;
macro. Even though the stack itself stores (value) stack
indices as integers, the &quot;PUSHMARK&quot; macro should
be given a stack pointer directly; it will calculate the
index offset by comparing to the &quot;PL_stack_sp&quot;
variable. Thus almost always the code to perform this is</p>


<p style="margin-left:11%; margin-top: 1em">PUSHMARK(SP);</p>

<p style="margin-left:11%; margin-top: 1em">Items are
popped from the stack by the &quot;POPMARK&quot; macro.
There is also a macro &quot;TOPMARK&quot; that inspects the
topmost item without removing it. These macros return I32
index values directly. There is also the &quot;dMARK&quot;
macro which declares a new <small>SV</small> double-pointer
variable, called &quot;mark&quot;, which points at the
marked stack slot; this is the usual macro that C code will
use when operating on lists given on the stack.</p>

<p style="margin-left:11%; margin-top: 1em">As noted above,
the &quot;mark&quot; variable itself will point at the most
recently pushed value on the value stack before the list
begins, and so the list itself starts at &quot;mark +
1&quot;. The values of the list may be iterated by code such
as</p>

<p style="margin-left:11%; margin-top: 1em">for(SV **svp =
mark + 1; svp &lt;= PL_stack_sp; svp++) { <br>
SV *item = *svp; <br>
... <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">Note
specifically in the case that the list is already empty,
&quot;mark&quot; will equal &quot;PL_stack_sp&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Because the
&quot;mark&quot; variable is converted to a pointer on the
value stack, extra care must be taken if &quot;EXTEND&quot;
or any of the &quot;XPUSH&quot; macros are invoked within
the function, because the stack may need to be moved to
extend it and so the existing pointer will now be invalid.
If this may be a problem, a possible solution is to track
the mark offset as an integer and track the mark itself
later on after the stack had been moved.</p>

<p style="margin-left:11%; margin-top: 1em">I32 markoff =
POPMARK; <br>
... <br>
SP **mark = PL_stack_base + markoff;</p>

<p style="margin-left:11%; margin-top: 1em"><b>Temporaries
Stack</b> <br>
As noted above, xV references on the main value stack do not
contribute to the reference count of an xV, and so another
mechanism is used to track when temporary values which live
on the stack must be released. This is the job of the
temporaries stack.</p>

<p style="margin-left:11%; margin-top: 1em">The temporaries
stack stores pointers to xVs whose reference counts will be
decremented soon.</p>

<p style="margin-left:11%; margin-top: 1em">The base of
this stack is pointed to by the interpreter variable
&quot;PL_tmps_stack&quot;, of type &quot;SV **&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">The head of the
stack is indexed by &quot;PL_tmps_ix&quot;, an integer which
stores the index in the array of the most recently-pushed
item.</p>

<p style="margin-left:11%; margin-top: 1em">There is no
public <small>API</small> to directly push items to the
temporaries stack. Instead, the <small>API</small> function
&quot;sv_2mortal()&quot; is used to mortalize an xV, adding
its address to the temporaries stack.</p>

<p style="margin-left:11%; margin-top: 1em">Likewise, there
is no public <small>API</small> to read values from the
temporaries stack. Instead, the macros &quot;SAVETMPS&quot;
and &quot;FREETMPS&quot; are used. The &quot;SAVETMPS&quot;
macro establishes the base levels of the temporaries stack,
by capturing the current value of &quot;PL_tmps_ix&quot;
into &quot;PL_tmps_floor&quot; and saving the previous value
to the save stack. Thereafter, whenever &quot;FREETMPS&quot;
is invoked all of the temporaries that have been pushed
since that level are reclaimed.</p>

<p style="margin-left:11%; margin-top: 1em">While it is
common to see these two macros in pairs within an
&quot;ENTER&quot;/ &quot;LEAVE&quot; pair, it is not
necessary to match them. It is permitted to invoke
&quot;FREETMPS&quot; multiple times since the most recent
&quot;SAVETMPS&quot;; for example in a loop iterating over
elements of a list. While you can invoke
&quot;SAVETMPS&quot; multiple times within a scope pair, it
is unlikely to be useful. Subsequent invocations will move
the temporaries floor further up, thus effectively trapping
the existing temporaries to only be released at the end of
the scope.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Save
Stack</b> <br>
The save stack is used by perl to implement the
&quot;local&quot; keyword and other similar behaviours; any
cleanup operations that need to be performed when leaving
the current scope. Items pushed to this stack generally
capture the current value of some internal variable or
state, which will be restored when the scope is unwound due
to leaving, &quot;return&quot;, &quot;die&quot;,
&quot;goto&quot; or other reasons.</p>

<p style="margin-left:11%; margin-top: 1em">Whereas other
perl internal stacks store individual items all of the same
type (usually <small>SV</small> pointers or integers), the
items pushed to the save stack are formed of many different
types, having multiple fields to them. For example, the
&quot;SAVEt_INT&quot; type needs to store both the address
of the &quot;int&quot; variable to restore, and the value to
restore it to. This information could have been stored using
fields of a &quot;struct&quot;, but would have to be large
enough to store three pointers in the largest case, which
would waste a lot of space in most of the smaller cases.</p>

<p style="margin-left:11%; margin-top: 1em">Instead, the
stack stores information in a variable-length encoding of
&quot;ANY&quot; structures. The final value pushed is stored
in the &quot;UV&quot; field which encodes the kind of item
held by the preceding items; the count and types of which
will depend on what kind of item is being stored. The kind
field is pushed last because that will be the first field to
be popped when unwinding items from the stack.</p>

<p style="margin-left:11%; margin-top: 1em">The base of
this stack is pointed to by the interpreter variable
&quot;PL_savestack&quot;, of type &quot;ANY *&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">The head of the
stack is indexed by &quot;PL_savestack_ix&quot;, an integer
which stores the index in the array at which the next item
should be pushed. (Note that this is different to most other
stacks, which reference the most recently-pushed item).</p>

<p style="margin-left:11%; margin-top: 1em">Items are
pushed to the save stack by using the various
&quot;SAVE...()&quot; macros. Many of these macros take a
variable and store both its address and current value on the
save stack, ensuring that value gets restored on scope
exit.</p>

<p style="margin-left:11%; margin-top: 1em">SAVEI8(i8) <br>
SAVEI16(i16) <br>
SAVEI32(i32) <br>
SAVEINT(i) <br>
...</p>

<p style="margin-left:11%; margin-top: 1em">There are also
a variety of other special-purpose macros which save
particular types or values of interest. &quot;SAVETMPS&quot;
has already been mentioned above. Others include
&quot;SAVEFREEPV&quot; which arranges for a
<small>PV</small> (i.e. a string buffer) to be freed, or
&quot;SAVEDESTRUCTOR&quot; which arranges for a given
function pointer to be invoked on scope exit. A full list of
such macros can be found in <i>scope.h</i>.</p>

<p style="margin-left:11%; margin-top: 1em">There is no
public <small>API</small> for popping individual values or
items from the save stack. Instead, via the scope stack, the
&quot;ENTER&quot; and &quot;LEAVE&quot; pair form a way to
start and stop nested scopes. Leaving a nested scope via
&quot;LEAVE&quot; will restore all of the saved values that
had been pushed since the most recent &quot;ENTER&quot;.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Scope
Stack</b> <br>
As with the mark stack to the value stack, the scope stack
forms a pair with the save stack. The scope stack stores the
height of the save stack at which nested scopes begin, and
allows the save stack to be unwound back to that point when
the scope is left.</p>

<p style="margin-left:11%; margin-top: 1em">When perl is
built with debugging enabled, there is a second part to this
stack storing human-readable string names describing the
type of stack context. Each push operation saves the name as
well as the height of the save stack, and each pop operation
checks the topmost name with what is expected, causing an
assertion failure if the name does not match.</p>

<p style="margin-left:11%; margin-top: 1em">The base of
this stack is pointed to by the interpreter variable
&quot;PL_scopestack&quot;, of type &quot;I32 *&quot;. If
enabled, the scope stack names are stored in a separate
array pointed to by &quot;PL_scopestack_name&quot;, of type
&quot;const char **&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">The head of the
stack is indexed by &quot;PL_scopestack_ix&quot;, an integer
which stores the index of the array or arrays at which the
next item should be pushed. (Note that this is different to
most other stacks, which reference the most recently-pushed
item).</p>

<p style="margin-left:11%; margin-top: 1em">Values are
pushed to the scope stack using the &quot;ENTER&quot; macro,
which begins a new nested scope. Any items pushed to the
save stack are then restored at the next nested invocation
of the &quot;LEAVE&quot; macro.</p>

<h2>Dynamic Scope and the Context Stack
<a name="Dynamic Scope and the Context Stack"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>Note:</b>
this section describes a non-public internal
<small>API</small> that is subject to change without
notice.</p>


<p style="margin-left:11%; margin-top: 1em"><b>Introduction
to the context stack</b> <br>
In Perl, dynamic scoping refers to the runtime nesting of
things like subroutine calls, evals etc, as well as the
entering and exiting of block scopes. For example, the
restoring of a &quot;local&quot;ised variable is determined
by the dynamic scope.</p>

<p style="margin-left:11%; margin-top: 1em">Perl tracks the
dynamic scope by a data structure called the context stack,
which is an array of &quot;PERL_CONTEXT&quot; structures,
and which is itself a big union for all the types of
context. Whenever a new scope is entered (such as a block, a
&quot;for&quot; loop, or a subroutine call), a new context
entry is pushed onto the stack. Similarly when leaving a
block or returning from a subroutine call etc. a context is
popped. Since the context stack represents the current
dynamic scope, it can be searched. For example, &quot;next
LABEL&quot; searches back through the stack looking for a
loop context that matches the label; &quot;return&quot; pops
contexts until it finds a sub or eval context or similar;
&quot;caller&quot; examines sub contexts on the stack.</p>

<p style="margin-left:11%; margin-top: 1em">Each context
entry is labelled with a context type, &quot;cx_type&quot;.
Typical context types are &quot;CXt_SUB&quot;,
&quot;CXt_EVAL&quot; etc., as well as &quot;CXt_BLOCK&quot;
and &quot;CXt_NULL&quot; which represent a basic scope (as
pushed by &quot;pp_enter&quot;) and a sort block. The type
determines which part of the context union are valid.</p>

<p style="margin-left:11%; margin-top: 1em">The main
division in the context struct is between a substitution
scope (&quot;CXt_SUBST&quot;) and block scopes, which are
everything else. The former is just used while executing
&quot;s///e&quot;, and won&rsquo;t be discussed further
here.</p>

<p style="margin-left:11%; margin-top: 1em">All the block
scope types share a common base, which corresponds to
&quot;CXt_BLOCK&quot;. This stores the old values of various
scope-related variables like &quot;PL_curpm&quot;, as well
as information about the current scope, such as
&quot;gimme&quot;. On scope exit, the old variables are
restored.</p>

<p style="margin-left:11%; margin-top: 1em">Particular
block scope types store extra per-type information. For
example, &quot;CXt_SUB&quot; stores the currently executing
<small>CV,</small> while the various for loop types might
hold the original loop variable <small>SV.</small> On scope
exit, the per-type data is processed; for example the
<small>CV</small> has its reference count decremented, and
the original loop variable is restored.</p>

<p style="margin-left:11%; margin-top: 1em">The macro
&quot;cxstack&quot; returns the base of the current context
stack, while &quot;cxstack_ix&quot; is the index of the
current frame within that stack.</p>

<p style="margin-left:11%; margin-top: 1em">In fact, the
context stack is actually part of a stack-of-stacks system;
whenever something unusual is done such as calling a
&quot;DESTROY&quot; or tie handler, a new stack is pushed,
then popped at the end.</p>

<p style="margin-left:11%; margin-top: 1em">Note that the
<small>API</small> described here changed considerably in
perl 5.24; prior to that, big macros like
&quot;PUSHBLOCK&quot; and &quot;POPSUB&quot; were used; in
5.24 they were replaced by the inline static functions
described below. In addition, the ordering and detail of how
these macros/function work changed in many ways, often
subtly. In particular they didn&rsquo;t handle saving the
savestack and temps stack positions, and required additional
&quot;ENTER&quot;, &quot;SAVETMPS&quot; and
&quot;LEAVE&quot; compared to the new functions. The
old-style macros will not be described further.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Pushing
contexts</b> <br>
For pushing a new context, the two basic functions are
&quot;cx = cx_pushblock()&quot;, which pushes a new basic
context block and returns its address, and a family of
similar functions with names like &quot;cx_pushsub(cx)&quot;
which populate the additional type-dependent fields in the
&quot;cx&quot; struct. Note that &quot;CXt_NULL&quot; and
&quot;CXt_BLOCK&quot; don&rsquo;t have their own push
functions, as they don&rsquo;t store any data beyond that
pushed by &quot;cx_pushblock&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">The fields of
the context struct and the arguments to the &quot;cx_*&quot;
functions are subject to change between perl releases,
representing whatever is convenient or efficient for that
release.</p>

<p style="margin-left:11%; margin-top: 1em">A typical
context stack pushing can be found in
&quot;pp_entersub&quot;; the following shows a simplified
and stripped-down example of a non-XS call, along with
comments showing roughly what each function does.</p>

<p style="margin-left:11%; margin-top: 1em">dMARK; <br>
U8 gimme = GIMME_V; <br>
bool hasargs = cBOOL(PL_op&minus;&gt;op_flags &amp;
OPf_STACKED); <br>
OP *retop = PL_op&minus;&gt;op_next; <br>
I32 old_ss_ix = PL_savestack_ix; <br>
CV *cv = ....; <br>
/* ... make mortal copies of stack args which are PADTMPs
here ... */ <br>
/* ... do any additional savestack pushes here ... */ <br>
/* Now push a new context entry of type 'CXt_SUB'; initially
just <br>
* doing the actions common to all block types: */ <br>
cx = cx_pushblock(CXt_SUB, gimme, MARK, old_ss_ix); <br>
/* this does (approximately): <br>
CXINC; /* cxstack_ix++ (grow if necessary) */ <br>
cx = CX_CUR(); /* and get the address of new frame */ <br>
cx&minus;&gt;cx_type = CXt_SUB; <br>
cx&minus;&gt;blk_gimme = gimme; <br>
cx&minus;&gt;blk_oldsp = MARK &minus; PL_stack_base; <br>
cx&minus;&gt;blk_oldsaveix = old_ss_ix; <br>
cx&minus;&gt;blk_oldcop = PL_curcop; <br>
cx&minus;&gt;blk_oldmarksp = PL_markstack_ptr &minus;
PL_markstack; <br>
cx&minus;&gt;blk_oldscopesp = PL_scopestack_ix; <br>
cx&minus;&gt;blk_oldpm = PL_curpm; <br>
cx&minus;&gt;blk_old_tmpsfloor = PL_tmps_floor; <br>
PL_tmps_floor = PL_tmps_ix; <br>
*/ <br>
/* then update the new context frame with
subroutine&minus;specific info, <br>
* such as the CV about to be executed: */ <br>
cx_pushsub(cx, cv, retop, hasargs); <br>
/* this does (approximately): <br>
cx&minus;&gt;blk_sub.cv = cv; <br>
cx&minus;&gt;blk_sub.olddepth = CvDEPTH(cv); <br>
cx&minus;&gt;blk_sub.prevcomppad = PL_comppad; <br>
cx&minus;&gt;cx_type |= (hasargs) ? CXp_HASARGS : 0; <br>
cx&minus;&gt;blk_sub.retop = retop; <br>
SvREFCNT_inc_simple_void_NN(cv); <br>
*/</p>

<p style="margin-left:11%; margin-top: 1em">Note that
&quot;cx_pushblock()&quot; sets two new floors: for the args
stack (to &quot;MARK&quot;) and the temps stack (to
&quot;PL_tmps_ix&quot;). While executing at this scope
level, every &quot;nextstate&quot; (amongst others) will
reset the args and tmps stack levels to these floors. Note
that since &quot;cx_pushblock&quot; uses the current value
of &quot;PL_tmps_ix&quot; rather than it being passed as an
arg, this dictates at what point &quot;cx_pushblock&quot;
should be called. In particular, any new mortals which
should be freed only on scope exit (rather than at the next
&quot;nextstate&quot;) should be created first.</p>

<p style="margin-left:11%; margin-top: 1em">Most callers of
&quot;cx_pushblock&quot; simply set the new args stack floor
to the top of the previous stack frame, but for
&quot;CXt_LOOP_LIST&quot; it stores the items being iterated
over on the stack, and so sets &quot;blk_oldsp&quot; to the
top of these items instead. Note that, contrary to its name,
&quot;blk_oldsp&quot; doesn&rsquo;t always represent the
value to restore &quot;PL_stack_sp&quot; to on scope
exit.</p>

<p style="margin-left:11%; margin-top: 1em">Note the early
capture of &quot;PL_savestack_ix&quot; to
&quot;old_ss_ix&quot;, which is later passed as an arg to
&quot;cx_pushblock&quot;. In the case of
&quot;pp_entersub&quot;, this is because, although most
values needing saving are stored in fields of the context
struct, an extra value needs saving only when the debugger
is running, and it doesn&rsquo;t make sense to bloat the
struct for this rare case. So instead it is saved on the
savestack. Since this value gets calculated and saved before
the context is pushed, it is necessary to pass the old value
of &quot;PL_savestack_ix&quot; to &quot;cx_pushblock&quot;,
to ensure that the saved value gets freed during scope exit.
For most users of &quot;cx_pushblock&quot;, where nothing
needs pushing on the save stack, &quot;PL_savestack_ix&quot;
is just passed directly as an arg to
&quot;cx_pushblock&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Note that where
possible, values should be saved in the context struct
rather than on the save stack; it&rsquo;s much faster that
way.</p>

<p style="margin-left:11%; margin-top: 1em">Normally
&quot;cx_pushblock&quot; should be immediately followed by
the appropriate &quot;cx_pushfoo&quot;, with nothing between
them; this is because if code in-between could die (e.g. a
warning upgraded to fatal), then the context stack unwinding
code in &quot;dounwind&quot; would see (in the example
above) a &quot;CXt_SUB&quot; context frame, but without all
the subroutine-specific fields set, and crashes would soon
ensue.</p>

<p style="margin-left:11%; margin-top: 1em">Where the two
must be separate, initially set the type to
&quot;CXt_NULL&quot; or &quot;CXt_BLOCK&quot;, and later
change it to &quot;CXt_foo&quot; when doing the
&quot;cx_pushfoo&quot;. This is exactly what
&quot;pp_enteriter&quot; does, once it&rsquo;s determined
which type of loop it&rsquo;s pushing.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Popping
contexts</b> <br>
Contexts are popped using &quot;cx_popsub()&quot; etc. and
&quot;cx_popblock()&quot;. Note however, that unlike
&quot;cx_pushblock&quot;, neither of these functions
actually decrement the current context stack index; this is
done separately using &quot;CX_POP()&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">There are two
main ways that contexts are popped. During normal execution
as scopes are exited, functions like &quot;pp_leave&quot;,
&quot;pp_leaveloop&quot; and &quot;pp_leavesub&quot; process
and pop just one context using &quot;cx_popfoo&quot; and
&quot;cx_popblock&quot;. On the other hand, things like
&quot;pp_return&quot; and &quot;next&quot; may have to pop
back several scopes until a sub or loop context is found,
and exceptions (such as &quot;die&quot;) need to pop back
contexts until an eval context is found. Both of these are
accomplished by &quot;dounwind()&quot;, which is capable of
processing and popping all contexts above the target
one.</p>

<p style="margin-left:11%; margin-top: 1em">Here is a
typical example of context popping, as found in
&quot;pp_leavesub&quot; (simplified slightly):</p>

<p style="margin-left:11%; margin-top: 1em">U8 gimme; <br>
PERL_CONTEXT *cx; <br>
SV **oldsp; <br>
OP *retop; <br>
cx = CX_CUR(); <br>
gimme = cx&minus;&gt;blk_gimme; <br>
oldsp = PL_stack_base + cx&minus;&gt;blk_oldsp; /* last arg
of previous frame */ <br>
if (gimme == G_VOID) <br>
PL_stack_sp = oldsp; <br>
else <br>
leave_adjust_stacks(oldsp, oldsp, gimme, 0); <br>
CX_LEAVE_SCOPE(cx); <br>
cx_popsub(cx); <br>
cx_popblock(cx); <br>
retop = cx&minus;&gt;blk_sub.retop; <br>
CX_POP(cx); <br>
return retop;</p>

<p style="margin-left:11%; margin-top: 1em">The steps above
are in a very specific order, designed to be the reverse
order of when the context was pushed. The first thing to do
is to copy and/or protect any return arguments and free any
temps in the current scope. Scope exits like an rvalue sub
normally return a mortal copy of their return args (as
opposed to lvalue subs). It is important to make this copy
before the save stack is popped or variables are restored,
or bad things like the following can happen:</p>

<p style="margin-left:11%; margin-top: 1em">sub f { my $x
=...; $x } # $x freed before we get to copy it <br>
sub f { /(...)/; $1 } # PL_curpm restored before $1
copied</p>

<p style="margin-left:11%; margin-top: 1em">Although we
wish to free any temps at the same time, we have to be
careful not to free any temps which are keeping return args
alive; nor to free the temps we have just created while
mortal copying return args. Fortunately,
&quot;leave_adjust_stacks()&quot; is capable of making
mortal copies of return args, shifting args down the stack,
and only processing those entries on the temps stack that
are safe to do so.</p>

<p style="margin-left:11%; margin-top: 1em">In void context
no args are returned, so it&rsquo;s more efficient to skip
calling &quot;leave_adjust_stacks()&quot;. Also in void
context, a &quot;nextstate&quot; op is likely to be
imminently called which will do a &quot;FREETMPS&quot;, so
there&rsquo;s no need to do that either.</p>

<p style="margin-left:11%; margin-top: 1em">The next step
is to pop savestack entries: &quot;CX_LEAVE_SCOPE(cx)&quot;
is just defined as
&quot;LEAVE_SCOPE(cx&minus;&gt;blk_oldsaveix)&quot;. Note
that during the popping, it&rsquo;s possible for perl to
call destructors, call &quot;STORE&quot; to undo
localisations of tied vars, and so on. Any of these can die
or call &quot;exit()&quot;. In this case,
&quot;dounwind()&quot; will be called, and the current
context stack frame will be re-processed. Thus it is vital
that all steps in popping a context are done in such a way
to support reentrancy. The other alternative, of
decrementing &quot;cxstack_ix&quot; <i>before</i> processing
the frame, would lead to leaks and the like if something
died halfway through, or overwriting of the current
frame.</p>


<p style="margin-left:11%; margin-top: 1em">&quot;CX_LEAVE_SCOPE&quot;
itself is safely re-entrant: if only half the savestack
items have been popped before dying and getting trapped by
eval, then the &quot;CX_LEAVE_SCOPE&quot;s in
&quot;dounwind&quot; or &quot;pp_leaveeval&quot; will
continue where the first one left off.</p>

<p style="margin-left:11%; margin-top: 1em">The next step
is the type-specific context processing; in this case
&quot;cx_popsub&quot;. In part, this looks like:</p>

<p style="margin-left:11%; margin-top: 1em">cv =
cx&minus;&gt;blk_sub.cv; <br>
CvDEPTH(cv) = cx&minus;&gt;blk_sub.olddepth; <br>
cx&minus;&gt;blk_sub.cv = NULL; <br>
SvREFCNT_dec(cv);</p>

<p style="margin-left:11%; margin-top: 1em">where its
processing the just-executed <small>CV.</small> Note that
before it decrements the <small>CV</small> &rsquo;s
reference count, it nulls the &quot;blk_sub.cv&quot;. This
means that if it re-enters, the <small>CV</small>
won&rsquo;t be freed twice. It also means that you
can&rsquo;t rely on such type-specific fields having useful
values after the return from &quot;cx_popfoo&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Next,
&quot;cx_popblock&quot; restores all the various interpreter
vars to their previous values or previous high water marks;
it expands to:</p>


<p style="margin-left:11%; margin-top: 1em">PL_markstack_ptr
= PL_markstack + cx&minus;&gt;blk_oldmarksp; <br>
PL_scopestack_ix = cx&minus;&gt;blk_oldscopesp; <br>
PL_curpm = cx&minus;&gt;blk_oldpm; <br>
PL_curcop = cx&minus;&gt;blk_oldcop; <br>
PL_tmps_floor = cx&minus;&gt;blk_old_tmpsfloor;</p>

<p style="margin-left:11%; margin-top: 1em">Note that it
<i>doesn&rsquo;t</i> restore &quot;PL_stack_sp&quot;; as
mentioned earlier, which value to restore it to depends on
the context type (specifically &quot;for (list) {}&quot;),
and what args (if any) it returns; and that will already
have been sorted out earlier by
&quot;leave_adjust_stacks()&quot;.</p>

<p style="margin-left:11%; margin-top: 1em">Finally, the
context stack pointer is actually decremented by
&quot;CX_POP(cx)&quot;. After this point, it&rsquo;s
possible that that the current context frame could be
overwritten by other contexts being pushed. Although things
like ties and &quot;DESTROY&quot; are supposed to work
within a new context stack, it&rsquo;s best not to assume
this. Indeed on debugging builds, &quot;CX_POP(cx)&quot;
deliberately sets &quot;cx&quot; to null to detect code that
is still relying on the field values in that context frame.
Note in the &quot;pp_leavesub()&quot; example above, we grab
&quot;blk_sub.retop&quot; <i>before</i> calling
&quot;CX_POP&quot;.</p>

<p style="margin-left:11%; margin-top: 1em"><b>Redoing
contexts</b> <br>
Finally, there is &quot;cx_topblock(cx)&quot;, which acts
like a super&minus;&quot;nextstate&quot; as regards to
resetting various vars to their base values. It is used in
places like &quot;pp_next&quot;, &quot;pp_redo&quot; and
&quot;pp_goto&quot; where rather than exiting a scope, we
want to re-initialise the scope. As well as resetting
&quot;PL_stack_sp&quot; like &quot;nextstate&quot;, it also
resets &quot;PL_markstack_ptr&quot;,
&quot;PL_scopestack_ix&quot; and &quot;PL_curpm&quot;. Note
that it doesn&rsquo;t do a &quot;FREETMPS&quot;.</p>

<h2>Slab-based operator allocation
<a name="Slab-based operator allocation"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>Note:</b>
this section describes a non-public internal
<small>API</small> that is subject to change without
notice.</p>

<p style="margin-left:11%; margin-top: 1em">Perl&rsquo;s
internal error-handling mechanisms implement &quot;die&quot;
(and its internal equivalents) using longjmp. If this occurs
during lexing, parsing or compilation, we must ensure that
any ops allocated as part of the compilation process are
freed. (Older Perl versions did not adequately handle this
situation: when failing a parse, they would leak ops that
were stored in C &quot;auto&quot; variables and not linked
anywhere else.)</p>

<p style="margin-left:11%; margin-top: 1em">To handle this
situation, Perl uses <i>op slabs</i> that are attached to
the currently-compiling <small>CV. A</small> slab is a chunk
of allocated memory. New ops are allocated as regions of the
slab. If the slab fills up, a new one is created (and linked
from the previous one). When an error occurs and the
<small>CV</small> is freed, any ops remaining are freed.</p>

<p style="margin-left:11%; margin-top: 1em">Each op is
preceded by two pointers: one points to the next op in the
slab, and the other points to the slab that owns it. The
next-op pointer is needed so that Perl can iterate over a
slab and free all its ops. (Op structures are of different
sizes, so the slab&rsquo;s ops can&rsquo;t merely be treated
as a dense array.) The slab pointer is needed for accessing
a reference count on the slab: when the last op on a slab is
freed, the slab itself is freed.</p>

<p style="margin-left:11%; margin-top: 1em">The slab
allocator puts the ops at the end of the slab first. This
will tend to allocate the leaves of the op tree first, and
the layout will therefore hopefully be cache-friendly. In
addition, this means that there&rsquo;s no need to store the
size of the slab (see below on why slabs vary in size),
because Perl can follow pointers to find the last op.</p>

<p style="margin-left:11%; margin-top: 1em">It might seem
possible to eliminate slab reference counts altogether, by
having all ops implicitly attached to &quot;PL_compcv&quot;
when allocated and freed when the <small>CV</small> is
freed. That would also allow &quot;op_free&quot; to skip
&quot;FreeOp&quot; altogether, and thus free ops faster. But
that doesn&rsquo;t work in those cases where ops need to
survive beyond their CVs, such as re-evals.</p>

<p style="margin-left:11%; margin-top: 1em">The
<small>CV</small> also has to have a reference count on the
slab. Sometimes the first op created is immediately freed.
If the reference count of the slab reaches 0, then it will
be freed with the <small>CV</small> still pointing to
it.</p>

<p style="margin-left:11%; margin-top: 1em">CVs use the
&quot;CVf_SLABBED&quot; flag to indicate that the
<small>CV</small> has a reference count on the slab. When
this flag is set, the slab is accessible via
&quot;CvSTART&quot; when &quot;CvROOT&quot; is not set, or
by subtracting two pointers &quot;(2*sizeof(I32 *))&quot;
from &quot;CvROOT&quot; when it is set. The alternative to
this approach of sneaking the slab into &quot;CvSTART&quot;
during compilation would be to enlarge the &quot;xpvcv&quot;
struct by another pointer. But that would make all CVs
larger, even though slab-based op freeing is typically of
benefit only for programs that make significant use of
string eval.</p>

<p style="margin-left:11%; margin-top: 1em">When the
&quot;CVf_SLABBED&quot; flag is set, the <small>CV</small>
takes responsibility for freeing the slab. If
&quot;CvROOT&quot; is not set when the <small>CV</small> is
freed or undeffed, it is assumed that a compilation error
has occurred, so the op slab is traversed and all the ops
are freed.</p>

<p style="margin-left:11%; margin-top: 1em">Under normal
circumstances, the <small>CV</small> forgets about its slab
(decrementing the reference count) when the root is
attached. So the slab reference counting that happens when
ops are freed takes care of freeing the slab. In some cases,
the <small>CV</small> is told to forget about the slab
(&quot;cv_forget_slab&quot;) precisely so that the ops can
survive after the <small>CV</small> is done away with.</p>

<p style="margin-left:11%; margin-top: 1em">Forgetting the
slab when the root is attached is not strictly necessary,
but avoids potential problems with &quot;CvROOT&quot; being
written over. There is code all over the place, both in core
and on <small>CPAN,</small> that does things with
&quot;CvROOT&quot;, so forgetting the slab makes things more
robust and avoids potential problems.</p>

<p style="margin-left:11%; margin-top: 1em">Since the
<small>CV</small> takes ownership of its slab when flagged,
that flag is never copied when a <small>CV</small> is
cloned, as one <small>CV</small> could free a slab that
another <small>CV</small> still points to, since forced
freeing of ops ignores the reference count (but asserts that
it looks right).</p>

<p style="margin-left:11%; margin-top: 1em">To avoid slab
fragmentation, freed ops are marked as freed and attached to
the slab&rsquo;s freed chain (an idea stolen from
DBM::Deep). Those freed ops are reused when possible. Not
reusing freed ops would be simpler, but it would result in
significantly higher memory usage for programs with large
&quot;if (DEBUG) {...}&quot; blocks.</p>


<p style="margin-left:11%; margin-top: 1em">&quot;SAVEFREEOP&quot;
is slightly problematic under this scheme. Sometimes it can
cause an op to be freed after its <small>CV.</small> If the
<small>CV</small> has forcibly freed the ops on its slab and
the slab itself, then we will be fiddling with a freed slab.
Making &quot;SAVEFREEOP&quot; a no-op doesn&rsquo;t help, as
sometimes an op can be savefreed when there is no
compilation error, so the op would never be freed. It holds
a reference count on the slab, so the whole slab would leak.
So &quot;SAVEFREEOP&quot; now sets a special flag on the op
(&quot;&minus;&gt;op_savefree&quot;). The forced freeing of
ops after a compilation error won&rsquo;t free any ops thus
marked.</p>

<p style="margin-left:11%; margin-top: 1em">Since many
pieces of code create tiny subroutines consisting of only a
few ops, and since a huge slab would be quite a bit of
baggage for those to carry around, the first slab is always
very small. To avoid allocating too many slabs for a single
<small>CV,</small> each subsequent slab is twice the size of
the previous.</p>

<p style="margin-left:11%; margin-top: 1em">Smartmatch
expects to be able to allocate an op at run time, run it,
and then throw it away. For that to work the op is simply
malloced when &quot;PL_compcv&quot; hasn&rsquo;t been set
up. So all slab-allocated ops are marked as such
(&quot;&minus;&gt;op_slabbed&quot;), to distinguish them
from malloced ops.</p>

<h2>AUTHORS
<a name="AUTHORS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Until May 1997,
this document was maintained by Jeff Okamoto
&lt;okamoto@corp.hp.com&gt;. It is now maintained as part of
Perl itself by the Perl 5 Porters
&lt;perl5&minus;porters@perl.org&gt;.</p>

<p style="margin-left:11%; margin-top: 1em">With lots of
help and suggestions from Dean Roehrich, Malcolm Beattie,
Andreas Koenig, Paul Hudson, Ilya Zakharevich, Paul
Marquess, Neil Bowers, Matthew Green, Tim Bunce, Spider
Boardman, Ulrich Pfeifer, Stephen McCamant, and Gurusamy
Sarathy.</p>

<h2>SEE ALSO
<a name="SEE ALSO"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">perlapi,
perlintern, perlxs, perlembed</p>
<hr>
</body>
</html>
