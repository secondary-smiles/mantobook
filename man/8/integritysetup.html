<!-- Creator     : groff version 1.22.4 -->
<!-- CreationDate: Mon May 29 22:57:05 2023 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title>INTEGRITYSETUP</title>

</head>
<body>
<h1>integritysetup</h1>



<h2>NAME
<a name="NAME"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">integritysetup
&minus; manage dm&minus;integrity (block level integrity)
volumes</p>

<h2>SYNOPSIS
<a name="SYNOPSIS"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em"><b>integritysetup
&lt;action&gt; [&lt;options&gt;] &lt;action args&gt;</b></p>

<h2>DESCRIPTION
<a name="DESCRIPTION"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Integritysetup
is used to configure dm&minus;integrity managed
device&minus;mapper mappings.</p>


<p style="margin-left:11%; margin-top: 1em">Device&minus;mapper
integrity target provides read&minus;write transparent
integrity checking of block devices. The dm&minus;integrity
target emulates an additional data integrity field
per&minus;sector. You can use this additional field directly
with integritysetup utility, or indirectly (for
authenticated encryption) through cryptsetup.</p>

<h2>BASIC ACTIONS
<a name="BASIC ACTIONS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Integritysetup
supports these operations:</p>

<p style="margin-left:11%; margin-top: 1em"><b>FORMAT <br>
format &lt;device&gt;</b></p>

<p style="margin-left:11%; margin-top: 1em">Formats
&lt;device&gt; (calculates space and dm&minus;integrity
superblock and wipes the device).</p>


<p style="margin-left:11%; margin-top: 1em"><b>&lt;options&gt;</b>
can be [&minus;&minus;data&minus;device,
&minus;&minus;batch&minus;mode, &minus;&minus;no&minus;wipe,
&minus;&minus;journal&minus;size,
&minus;&minus;interleave&minus;sectors,
&minus;&minus;tag&minus;size, &minus;&minus;integrity,
&minus;&minus;integrity&minus;key&minus;size,
&minus;&minus;integrity&minus;key&minus;file,
&minus;&minus;sector&minus;size,
&minus;&minus;progress&minus;frequency,
&minus;&minus;progress&minus;json].</p>

<p style="margin-left:11%; margin-top: 1em"><b>OPEN <br>
open &lt;device&gt; &lt;name&gt;</b> <br>
create &lt;name&gt; &lt;device&gt; (<b>OBSOLETE
syntax</b>)</p>

<p style="margin-left:11%; margin-top: 1em">Open a mapping
with &lt;name&gt; backed by device &lt;device&gt;.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&lt;options&gt;</b>
can be [&minus;&minus;data&minus;device,
&minus;&minus;batch&minus;mode,
&minus;&minus;journal&minus;watermark,
&minus;&minus;journal&minus;commit&minus;time,
&minus;&minus;buffer&minus;sectors, &minus;&minus;integrity,
&minus;&minus;integrity&minus;key&minus;size,
&minus;&minus;integrity&minus;key&minus;file,
&minus;&minus;integrity&minus;no&minus;journal,
&minus;&minus;integrity&minus;recalculate,
&minus;&minus;integrity&minus;recalculate&minus;reset,&minus;&minus;integrity&minus;recovery&minus;mode,
&minus;&minus;allow&minus;discards].</p>

<p style="margin-left:11%; margin-top: 1em"><b>CLOSE <br>
close &lt;name&gt;</b> <br>
remove &lt;name&gt; (<b>OBSOLETE syntax</b>)</p>

<p style="margin-left:11%; margin-top: 1em">Removes
existing mapping &lt;name&gt;.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&lt;options&gt;</b>
can be [&minus;&minus;deferred] or
[&minus;&minus;cancel&minus;deferred]</p>

<p style="margin-left:11%; margin-top: 1em"><b>STATUS <br>
status &lt;name&gt;</b></p>

<p style="margin-left:11%; margin-top: 1em">Reports status
for the active integrity mapping &lt;name&gt;.</p>

<p style="margin-left:11%; margin-top: 1em"><b>DUMP <br>
dump &lt;device&gt;</b></p>

<p style="margin-left:11%; margin-top: 1em">Reports
parameters from on&minus;disk stored superblock.</p>

<p style="margin-left:11%; margin-top: 1em"><b>RESIZE <br>
resize &lt;name&gt;</b></p>

<p style="margin-left:11%; margin-top: 1em">Resizes an
active mapping &lt;name&gt;.</p>

<p style="margin-left:11%; margin-top: 1em">If
&minus;&minus;size (in 512&minus;bytes sectors) or
&minus;&minus;device&minus;size are not specified, the size
is computed from the underlying device. After resize, the
<b>recalculating</b> flag is set. If &minus;&minus;wipe flag
is set and the size of the device is increased, the newly
added section will be wiped.</p>

<p style="margin-left:11%; margin-top: 1em">Increasing the
size of integrity volumes is available since the Linux
kernel version 5.7, shrinking should work on older kernels
too.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&lt;options&gt;</b>
can be [&minus;&minus;size, &minus;&minus;device&minus;size,
&minus;&minus;wipe].</p>

<h2>OPTIONS
<a name="OPTIONS"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;progress&minus;frequency
&lt;seconds&gt;</b></p>

<p style="margin-left:17%;">Print separate line every
&lt;seconds&gt; with wipe progress.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;progress&minus;json</b></p>

<p style="margin-left:17%;">Prints wipe progress data in
json format suitable mostly for machine processing. It
prints separate line every half second (or based on
&minus;&minus;progress&minus;frequency value). The JSON
output looks as follows during wipe progress (except
it&rsquo;s compact single line):</p>

<p style="margin-left:23%; margin-top: 1em">{ <br>
&quot;device&quot;:&quot;/dev/sda&quot; // backing device or
file <br>
&quot;device_bytes&quot;:&quot;8192&quot;, // bytes wiped so
far <br>
&quot;device_size&quot;:&quot;44040192&quot;, // total bytes
to wipe <br>
&quot;speed&quot;:&quot;126877696&quot;, // calculated speed
in bytes per second (based on progress so far) <br>
&quot;eta_ms&quot;:&quot;2520012&quot; // estimated time to
finish wipe in milliseconds <br>
&quot;time_ms&quot;:&quot;5561235&quot; // total time spent
wiping device in milliseconds <br>
}</p>

<p style="margin-left:17%; margin-top: 1em">Note on numbers
in JSON output: Due to JSON parsers limitations all numbers
are represented in a string format due to need of full 64bit
unsigned integers.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;no&minus;wipe</b></p>

<p style="margin-left:17%;">Do not wipe the device after
format. A device that is not initially wiped will contain
invalid checksums.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;wipe</b></p>

<p style="margin-left:17%;">Wipe the newly allocated area
after resize to bigger size. If this flag is not set,
checksums will be calculated for the data previously stored
in the newly allocated area.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;journal&minus;size,
&minus;j BYTES</b></p>

<p style="margin-left:17%;">Size of the journal.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;interleave&minus;sectors
SECTORS</b></p>

<p style="margin-left:17%;">The number of interleaved
sectors.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;integrity&minus;recalculate</b></p>

<p style="margin-left:17%;">Automatically recalculate
integrity tags in kernel on activation. The device can be
used during automatic integrity recalculation but becomes
fully integrity protected only after the background
operation is finished. This option is available since the
Linux kernel version 4.19.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;integrity&minus;recalculate&minus;reset</b></p>

<p style="margin-left:17%;">Restart recalculation from the
beginning of the device. It can be used to change the
integrity checksum function. Note it does not change the tag
length. This option is available since the Linux kernel
version 5.13.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;journal&minus;watermark
PERCENT</b></p>

<p style="margin-left:17%;">Journal watermark in percents.
When the size of the journal exceeds this watermark, the
journal flush will be started.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;journal&minus;commit&minus;time
MS</b></p>

<p style="margin-left:17%;">Commit time in milliseconds.
When this time passes (and no explicit flush operation was
issued), the journal is written.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;tag&minus;size,
&minus;t BYTES</b></p>

<p style="margin-left:17%;">Size of the integrity tag
per&minus;sector (here the integrity function will store
authentication tag).</p>

<p style="margin-left:17%; margin-top: 1em"><b>NOTE:</b>
The size can be smaller that output size of the hash
function, in that case only part of the hash will be
stored.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;data&minus;device
&lt;data_device&gt;</b></p>

<p style="margin-left:17%;">Specify a separate data device
that contains existing data. The &lt;device&gt; then will
contain calculated integrity tags and journal for data on
&lt;data_device&gt;.</p>

<p style="margin-left:17%; margin-top: 1em"><b>NOTE:</b> To
not wipe the data device after initial format, also specify
&minus;&minus;no&minus;wipe option and activate with
&minus;&minus;integrity&minus;recalculate to automatically
recalculate integrity tags.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;sector&minus;size,
&minus;s BYTES</b></p>

<p style="margin-left:17%;">Sector size (power of two: 512,
1024, 2048, 4096).</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;buffer&minus;sectors
SECTORS</b></p>

<p style="margin-left:17%;">The number of sectors in one
buffer.</p>

<p style="margin-left:17%; margin-top: 1em">The tag area is
accessed using buffers, the large buffer size means that the
I/O size will be larger, but there could be less I/Os
issued.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;integrity,
&minus;I ALGORITHM</b></p>

<p style="margin-left:17%;">Use internal integrity
calculation (standalone mode). The integrity algorithm can
be CRC (crc32c/crc32), non&minus;cryptographic hash function
(xxhash64) or hash function (sha1, sha256).</p>

<p style="margin-left:17%; margin-top: 1em">For HMAC
(hmac&minus;sha256) you have also to specify an integrity
key and its size.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;integrity&minus;key&minus;size
BYTES</b></p>

<p style="margin-left:17%;">The size of the data integrity
key. Maximum is 4096 bytes.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;integrity&minus;key&minus;file
FILE</b></p>

<p style="margin-left:17%;">The file with the integrity
key.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;integrity&minus;no&minus;journal,
&minus;D</b></p>

<p style="margin-left:17%;">Disable journal for integrity
device.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;integrity&minus;bitmap&minus;mode.
&minus;B</b></p>

<p style="margin-left:17%;">Use alternate bitmap mode
(available since Linux kernel 5.2) where dm&minus;integrity
uses bitmap instead of a journal. If a bit in the bitmap is
1, the corresponding region&rsquo;s data and integrity tags
are not synchronized &minus; if the machine crashes, the
unsynchronized regions will be recalculated. The bitmap mode
is faster than the journal mode, because we don&rsquo;t have
to write the data twice, but it is also less reliable,
because if data corruption happens when the machine crashes,
it may not be detected.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;bitmap&minus;sectors&minus;per&minus;bit
SECTORS</b></p>

<p style="margin-left:17%;">Number of 512&minus;byte
sectors per bitmap bit, the value must be power of two.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;bitmap&minus;flush&minus;time
MS</b></p>

<p style="margin-left:17%;">Bitmap flush time in
milliseconds.</p>


<p style="margin-left:11%; margin-top: 1em"><b>WARNING:</b></p>

<p style="margin-left:17%;">In case of a crash, it is
possible that the data and integrity tag doesn&rsquo;t match
if the journal is disabled.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;integrity&minus;recovery&minus;mode.
&minus;R</b></p>

<p style="margin-left:17%;">Recovery mode (no journal, no
tag checking).</p>

<p style="margin-left:11%; margin-top: 1em"><b>NOTE:</b>
The following options are intended for testing purposes
only.: Using journal encryption does not make sense without
encryption the data, these options are internally used in
authenticated disk encryption with <b>cryptsetup(8)</b>.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;journal&minus;integrity
ALGORITHM</b></p>

<p style="margin-left:17%;">Integrity algorithm for journal
area. See &minus;&minus;integrity option for detailed
specification.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;journal&minus;integrity&minus;key&minus;size
BYTES</b></p>

<p style="margin-left:17%;">The size of the journal
integrity key. Maximum is 4096 bytes.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;journal&minus;integrity&minus;key&minus;file
FILE</b></p>

<p style="margin-left:17%;">The file with the integrity
key.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;journal&minus;crypt
ALGORITHM</b></p>

<p style="margin-left:17%;">Encryption algorithm for
journal data area. You can use a block cipher here such as
cbc&minus;aes or a stream cipher, for example, chacha20 or
ctr&minus;aes.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;journal&minus;crypt&minus;key&minus;size
BYTES</b></p>

<p style="margin-left:17%;">The size of the journal
encryption key. Maximum is 4096 bytes.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;journal&minus;crypt&minus;key&minus;file
FILE</b></p>

<p style="margin-left:17%;">The file with the journal
encryption key.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;allow&minus;discards</b></p>

<p style="margin-left:17%;">Allow the use of discard (TRIM)
requests for the device. This option is available since the
Linux kernel version 5.7.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;deferred</b></p>

<p style="margin-left:17%;">Defers device removal in
<b>close</b> command until the last user closes it.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;cancel&minus;deferred</b></p>

<p style="margin-left:17%;">Removes a previously configured
deferred device removal in <b>close</b> command.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;verbose,
&minus;v</b></p>

<p style="margin-left:17%;">Print more information on
command execution.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;debug</b></p>

<p style="margin-left:17%;">Run in debug mode with full
diagnostic logs. Debug output lines are always prefixed by
<b>#</b>.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;version,
&minus;V</b></p>

<p style="margin-left:17%;">Show the program version.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;batch&minus;mode,
&minus;q</b></p>

<p style="margin-left:17%;">Do not ask for
confirmation.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;usage</b></p>

<p style="margin-left:17%;">Show short option help.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;help,
&minus;?</b></p>

<p style="margin-left:17%;">Show help text and default
parameters.</p>

<h2>LEGACY COMPATIBILITY OPTIONS
<a name="LEGACY COMPATIBILITY OPTIONS"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em"><b>WARNING:</b></p>

<p style="margin-left:17%;">Do not use these options until
you need compatibility with specific old kernel.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;integrity&minus;legacy&minus;padding</b></p>

<p style="margin-left:17%;">Use inefficient legacy
padding.</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;integrity&minus;legacy&minus;hmac</b></p>

<p style="margin-left:17%;">Use old flawed HMAC calculation
(also does not protect superblock).</p>


<p style="margin-left:11%; margin-top: 1em"><b>&minus;&minus;integrity&minus;legacy&minus;recalculate</b></p>

<p style="margin-left:17%;">Allow insecure recalculating of
volumes with HMAC keys (recalculation offset in superblock
is not protected).</p>

<h2>RETURN CODES
<a name="RETURN CODES"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Integritysetup
returns <b>0</b> on success and a non&minus;zero value on
error.</p>

<p style="margin-left:11%; margin-top: 1em">Error codes
are: <b>1</b> wrong parameters, <b>2</b> no permission,
<b>3</b> out of memory, <b>4</b> wrong device specified,
<b>5</b> device already exists or device is busy.</p>

<h2>NOTES
<a name="NOTES"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">The
dm&minus;integrity target is available since Linux kernel
version 4.12.</p>

<p style="margin-left:11%; margin-top: 1em">Format and
activation of an integrity device always require superuser
privilege because the superblock is calculated and handled
in dm&minus;integrity kernel target.</p>

<h2>EXAMPLES
<a name="EXAMPLES"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Format the
device with default standalone mode (CRC32C):</p>


<p style="margin-left:11%; margin-top: 1em"><b>integritysetup
format &lt;device&gt;</b></p>

<p style="margin-left:11%; margin-top: 1em">Open the device
with default parameters:</p>


<p style="margin-left:11%; margin-top: 1em"><b>integritysetup
open &lt;device&gt; test</b></p>

<p style="margin-left:11%; margin-top: 1em">Format the
device in standalone mode for use with HMAC(SHA256):</p>


<p style="margin-left:11%; margin-top: 1em"><b>integritysetup
format &lt;device&gt; &minus;&minus;tag&minus;size 32
&minus;&minus;integrity hmac&minus;sha256
&minus;&minus;integrity&minus;key&minus;file &lt;keyfile&gt;
&minus;&minus;integrity&minus;key&minus;size
&lt;key_bytes&gt;</b></p>

<p style="margin-left:11%; margin-top: 1em">Open (activate)
the device with HMAC(SHA256) and HMAC key in file:</p>


<p style="margin-left:11%; margin-top: 1em"><b>integritysetup
open &lt;device&gt; test &minus;&minus;integrity
hmac&minus;sha256
&minus;&minus;integrity&minus;key&minus;file &lt;keyfile&gt;
&minus;&minus;integrity&minus;key&minus;size
&lt;key_bytes&gt;</b></p>

<p style="margin-left:11%; margin-top: 1em">Dump
dm&minus;integrity superblock information:</p>


<p style="margin-left:11%; margin-top: 1em"><b>integritysetup
dump &lt;device&gt;</b></p>

<h2>DM&minus;INTEGRITY ON&minus;DISK FORMAT
<a name="DM&minus;INTEGRITY ON&minus;DISK FORMAT"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">The
on&minus;disk format specification available at
<b>DMIntegrity
&lt;https://gitlab.com/cryptsetup/cryptsetup/wikis/DMIntegrity&gt;
page.</b></p>

<h2>AUTHORS
<a name="AUTHORS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">The
integritysetup tool is written by <i>Milan Broz</i>
&lt;gmazyland@gmail.com&gt;.</p>

<h2>REPORTING BUGS
<a name="REPORTING BUGS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Report bugs at
<b>cryptsetup mailing list
&lt;cryptsetup@lists.linux.dev&gt; or in Issues project
section
&lt;https://gitlab.com/cryptsetup/cryptsetup/&minus;/issues/new&gt;.</b></p>

<p style="margin-left:11%; margin-top: 1em"><b>Please
attach output of the failed command with &minus;&minus;debug
option added.</b></p>

<h2>SEE ALSO
<a name="SEE ALSO"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>Cryptsetup
FAQ
&lt;https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions&gt;</b></p>


<p style="margin-left:11%; margin-top: 1em"><b>cryptsetup(8),
integritysetup(8) and veritysetup(8)</b></p>

<h2>CRYPTSETUP
<a name="CRYPTSETUP"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Part of
<b>cryptsetup project
&lt;https://gitlab.com/cryptsetup/cryptsetup/&gt;.</b></p>
<hr>
</body>
</html>
